<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caiman: analysis_parallel_multisession.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Caiman_logo_FIsmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caiman
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A Computational toolbox for large scale Calcium Imaging Analysis</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('analysis__parallel__multisession_8py_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">analysis_parallel_multisession.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="analysis__parallel__multisession_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html">    1</a></span>&#160;<span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">Created on Mon Aug  8 18:02:10 2016</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">@author: agiovann</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">#analysis parallel</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> next</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> filter</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> str</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> zip</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> range</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> past.utils <span class="keyword">import</span> old_div</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;get_ipython().magic(<span class="stringliteral">&#39;load_ext autoreload&#39;</span>)</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;get_ipython().magic(<span class="stringliteral">&#39;autoreload 2&#39;</span>)</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">from</span> time <span class="keyword">import</span> time</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">from</span> scipy.sparse <span class="keyword">import</span> coo_matrix</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">import</span> tifffile</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">import</span> subprocess</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">import</span> time <span class="keyword">as</span> tm</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">from</span> time <span class="keyword">import</span> time</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">import</span> pylab <span class="keyword">as</span> pl</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">import</span> psutil</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">from</span> glob <span class="keyword">import</span> glob</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">import</span> os</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">import</span> scipy</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">from</span> ipyparallel <span class="keyword">import</span> Client</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">import</span> caiman <span class="keyword">as</span> cm</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> sys</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> pickle</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> use_cases</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">from</span> <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html">use_cases.granule_cells.utils_granule</a> <span class="keyword">import</span> load_data_from_stored_results,process_eyelid_traces,process_wheel_traces,process_fast_process_day,process_wheel_traces_talmo</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">import</span> re</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacecaiman_1_1components__evaluation.html">caiman.components_evaluation</a> <span class="keyword">import</span> compute_event_exceptionality</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">from</span>  statsmodels.robust.scale <span class="keyword">import</span> mad</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="keywordflow">if</span> <span class="keyword">False</span>:</div><div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aec243578508d14c950b15e41a4de034e">   44</a></span>&#160;    backend=<span class="stringliteral">&#39;local&#39;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keywordflow">if</span> backend == <span class="stringliteral">&#39;SLURM&#39;</span>:</div><div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#afc887c81cb0ff13d5b2439525ddbdc8d">   46</a></span>&#160;        n_processes = np.int(os.environ.get(<span class="stringliteral">&#39;SLURM_NPROCS&#39;</span>))</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        n_processes = np.maximum(np.int(psutil.cpu_count()),1) <span class="comment"># roughly number of cores on your machine minus 1</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    print((<span class="stringliteral">&#39;using &#39;</span> + str(n_processes) + <span class="stringliteral">&#39; processes&#39;</span>))</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="comment">#% start cluster for efficient computation</span></div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9e59a8544e50abae8f7d58057ab8e1bf">   52</a></span>&#160;    single_thread=<span class="keyword">False</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">if</span> single_thread:</div><div class="line"><a name="l00055"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2e98a47cee987dc7000ac312036cddaf">   55</a></span>&#160;        dview=<span class="keywordtype">None</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <span class="keywordflow">else</span>:    </div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;            c.close()</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">except</span>:</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;            print(<span class="stringliteral">&#39;C was not existing, creating one&#39;</span>)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        print(<span class="stringliteral">&quot;Stopping  cluster to avoid unnencessary use of memory....&quot;</span>)</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        sys.stdout.flush()  </div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">if</span> backend == <span class="stringliteral">&#39;SLURM&#39;</span>:</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00065"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af58da398f293ce7fc4630bc69ad5f8d7">   65</a></span>&#160;                cse.utilities.stop_server(is_slurm=<span class="keyword">True</span>)</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                print(<span class="stringliteral">&#39;Nothing to stop&#39;</span>)</div><div class="line"><a name="l00068"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ace72880acd4ada0f7d8d7a34c74c5e49">   68</a></span>&#160;            slurm_script=<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/SOFTWARE/Constrained_NMF/SLURM/slurmStart.sh&#39;</span></div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            cse.utilities.start_server(slurm_script=slurm_script)</div><div class="line"><a name="l00070"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7667610e670e037bd84c42dadbfbaa30">   70</a></span>&#160;            pdir, profile = os.environ[<span class="stringliteral">&#39;IPPPDIR&#39;</span>], os.environ[<span class="stringliteral">&#39;IPPPROFILE&#39;</span>]</div><div class="line"><a name="l00071"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae0323a9039add2978bf5b49550572c7c">   71</a></span>&#160;            c = Client(ipython_dir=pdir, profile=profile)        </div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            cse.utilities.stop_server()</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            cse.utilities.start_server()        </div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;            c=Client()</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        dview=c[::4]</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        print((<span class="stringliteral">&#39;Using &#39;</span>+ str(len(dview)) + <span class="stringliteral">&#39; processes&#39;</span>))</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a65fa6e5d346b24e9bd19e580451d88b2">   82</a></span>&#160;base_folders=[</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160627154015/&#39;</span>,            </div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160624105838/&#39;</span>,</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160625132042/&#39;</span>,</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160626175708/&#39;</span>,</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160627110747/&#39;</span>,</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160628100247/&#39;</span>,</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160705103903/&#39;</span>,</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160628162522/&#39;</span>,</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160629123648/&#39;</span>,</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160630120544/&#39;</span>,</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160701113525/&#39;</span>,</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160702152950/&#39;</span>,</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160703173620/&#39;</span>,</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160704130454/&#39;</span>,</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">#              ]</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">#error:               &#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160711104450/&#39;, </span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">#              &#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160712105933/&#39;,             </span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">#base_folders=[</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160710134627/&#39;</span>,</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160710193544/&#39;</span>,</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160711164154/&#39;</span>,</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160711212316/&#39;</span>,</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160712101950/&#39;</span>,</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160712173043/&#39;</span>,</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160713100916/&#39;</span>,</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160713171246/&#39;</span>,</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160714094320/&#39;</span>,</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;              <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160714143248/&#39;</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;              ] </div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;base_folders.sort()</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;print(base_folders)              </div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="keywordflow">if</span> <span class="keyword">False</span>:</div><div class="line"><a name="l00118"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a339bb5524b06e496a6aaa0a97a4a8d21">  118</a></span>&#160;    results=dview.map_sync(cm.use_cases.granule_cells.utils_granule.fast_process_day,base_folders)     </div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="comment">#% if this does not work look below</span></div><div class="line"><a name="l00121"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aad4b0dfc3a996c416aa1c6331d37f646">  121</a></span>&#160;    triggers_chunk_fluo, eyelid_chunk,wheel_chunk ,triggers_chunk_bh ,tm_behav,names_chunks,fluo_chunk,pos_examples_chunks,A_chunks=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#af632b4bb540efcbdd4df79f9228c2f78">process_fast_process_day</a>(base_folders,save_name=<span class="stringliteral">&#39;eyeblink_35_37_sorted.npz&#39;</span>)</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">#import re</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">#triggers_chunk_fluo = []  </span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">#eyelid_chunk = []</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">#wheel_chunk = []</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">#triggers_chunk_bh = []</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">#tm_behav=[]</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">#names_chunks=[]</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">#fluo_chunk=[]</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">#pos_examples_chunks=[]</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment"># </span></div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">#A_chunks=[]  </span></div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">#for base_folder in base_folders:</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">#    try:         </span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">#        print (base_folder)</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">#        with np.load(os.path.join(base_folder,&#39;all_triggers.npz&#39;)) as ld:</span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">#            triggers=ld[&#39;triggers&#39;]</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">#            trigger_names=ld[&#39;trigger_names&#39;]</span></div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">#        with np.load(glob(os.path.join(base_folder,&#39;*-template_total.npz&#39;))[0]) as ld:</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">#            movie_names=ld[&#39;movie_names&#39;]</span></div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">#            template_each=ld[&#39;template_each&#39;]</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">#        idx_chunks=[] </span></div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">#        for name_chunk in movie_names:</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">#            idx_chunks.append([np.int(re.search(&#39;_00[0-9][0-9][0-9]_0&#39;,nm).group(0)[2:6])-1 for nm in name_chunk])</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">#          </span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">#        with np.load(base_folder+&#39;behavioral_traces.npz&#39;) as ld: </span></div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">#            res_bt = dict(**ld)</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">#            tm=res_bt[&#39;time&#39;]</span></div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">#            f_rate_bh=1/np.median(np.diff(tm))</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">#            ISI=np.median([rs[3]-rs[2] for rs in res_bt[&#39;trial_info&#39;][res_bt[&#39;idx_CS_US&#39;]]])</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">#            trig_int=np.hstack([((res_bt[&#39;trial_info&#39;][:,2:4]-res_bt[&#39;trial_info&#39;][:,0][:,None])*f_rate_bh),res_bt[&#39;trial_info&#39;][:,-1][:,np.newaxis]]).astype(np.int)</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">#            trig_int[trig_int&lt;0]=-1</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment">#            trig_int=np.hstack([trig_int,len(tm)+trig_int[:,:1]*0])</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">#            trig_US=np.argmin(np.abs(tm))</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">#            trig_CS=np.argmin(np.abs(tm+ISI))</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">#            trig_int[res_bt[&#39;idx_CS_US&#39;],0]=trig_CS</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">#            trig_int[res_bt[&#39;idx_CS_US&#39;],1]=trig_US</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">#            trig_int[res_bt[&#39;idx_US&#39;],1]=trig_US</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">#            trig_int[res_bt[&#39;idx_CS&#39;],0]=trig_CS</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">#            eye_traces=np.array(res_bt[&#39;eyelid&#39;]) </span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">#            wheel_traces=np.array(res_bt[&#39;wheel&#39;])</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">#            </span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">#         </span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">#         </span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">#        fls=glob(os.path.join(base_folder,&#39;*.results_analysis_traces.pk&#39;))</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">#        fls.sort()</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">#        fls_m=glob(os.path.join(base_folder,&#39;*.results_analysis_masks.npz&#39;))</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">#        fls_m.sort()     </span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">#         </span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">#        for indxs,name_chunk,fl,fl_m in zip(idx_chunks,movie_names,fls,fls_m):</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">#            if np.all([nmc[:-4] for nmc in name_chunk] == trigger_names[indxs]):</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">#                triggers_chunk_fluo.append(triggers[indxs,:])</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">#                eyelid_chunk.append(eye_traces[indxs,:])</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">#                wheel_chunk.append(wheel_traces[indxs,:])</span></div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">#                triggers_chunk_bh.append(trig_int[indxs,:])</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">#                tm_behav.append(tm)</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">#                names_chunks.append(fl)</span></div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">#                with open(fl,&#39;r&#39;) as f: </span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">#                    tr_dict=pickle.load(f)   </span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">#                    print(fl)</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">#                    fluo_chunk.append(tr_dict[&#39;traces_DFF&#39;])</span></div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">#                with np.load(fl_m) as ld:</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">#                    A_chunks.append(scipy.sparse.coo_matrix(ld[&#39;A&#39;]))</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">#                    pos_examples_chunks.append(ld[&#39;pos_examples&#39;])                </span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">#            else:</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">#                raise Exception(&#39;Names of triggers not matching!&#39;)</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">#    except:</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">#        print(&quot;ERROR in:&quot;+base_folder)                </span></div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;with np.load(<span class="stringliteral">&#39;eyeblink_35_37.npz&#39;</span>)  <span class="keyword">as</span> ld:</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    print((list(ld.keys())))</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    locals().update(ld)     </div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa71a7bcc742ac61f10c8ffbf28092017">  203</a></span>&#160;idx_sorted=names_chunks.argsort()</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;names_chunks=names_chunks[idx_sorted]<span class="comment">#[:27]       </span></div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;fluo_chunk=fluo_chunk[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;eyelid_chunk=eyelid_chunk[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;triggers_chunk_bh=triggers_chunk_bh[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;tm_behav=tm_behav[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;A_chunks=A_chunks[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;wheel_chunk=wheel_chunk[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;triggers_chunk_fluo=triggers_chunk_fluo[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;pos_examples_chunks=pos_examples_chunks[idx_sorted]<span class="comment">#[:27]</span></div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">#names_trials=[]</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">#last_dir=&#39;&#39;</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">#for nms in names_chunks:</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">#    new_dir = os.path.dirname(nms)</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">#    if last_dir != new_dir:</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">#        print new_dir</span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">#        last_dir = new_dir</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">#        templ_file=glob.glob(os.path.join())</span></div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa3f61613df61762e00f930768adef481">  225</a></span>&#160;talmo_file_name=[<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/dropbox/final_outputs/b35.mat&#39;</span>,<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/dropbox/final_outputs/b37.mat&#39;</span>]</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">  228</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">unroll_Talmo_data</a>(matr_list,is_nose=False):</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    files=[]</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="keywordflow">for</span> xx <span class="keywordflow">in</span> matr_list:</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        trials=[]</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        <span class="keywordflow">for</span> xxx <span class="keywordflow">in</span> xx[0]:</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;            <span class="keywordflow">if</span> is_nose:</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                trials.append(np.nanmean(xxx[0],0))</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                print((np.shape(xxx[0])))</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;            <span class="keywordflow">else</span>:</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;                trials.append(xxx[0][0])  </div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;        files.append(trials)       </div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    <span class="keywordflow">return</span> files    </div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;exptNames_TM=[]</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;trials_TM=[]</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;timestamps_TM=[]</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;wheel_mms_TM=[]</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;nose_TM=[]</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;nose_vel_TM=[]</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;animal_TM=[]</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="keywordflow">for</span> tfile <span class="keywordflow">in</span> talmo_file_name:</div><div class="line"><a name="l00254"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a52eb8ebd51523f9793a2f527790f0892">  254</a></span>&#160;    ld=scipy.io.loadmat(tfile)</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    print((list(ld.keys())))    </div><div class="line"><a name="l00256"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2630d201db47ba24c554095f2a01efbd">  256</a></span>&#160;    exptNames_TM=exptNames_TM+[xxp[0][0] <span class="keywordflow">for</span> xxp <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;exptNames&#39;</span>]]</div><div class="line"><a name="l00257"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a92301d6bf0e5f1b949e09fd34f72c83b">  257</a></span>&#160;    animal_TM=animal_TM+[os.path.split(tfile)[-1][:-4]]*len(exptNames_TM)</div><div class="line"><a name="l00258"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa4cad57ba2ee299ba948ea30b71c2b01">  258</a></span>&#160;    trials_TM=trials_TM+[xxp[0] <span class="keywordflow">for</span> xxp <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;trials&#39;</span>]]</div><div class="line"><a name="l00259"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a31c48cf290577b1895afeebd35bdd2fb">  259</a></span>&#160;    timestamps_TM=timestamps_TM+<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">unroll_Talmo_data</a>(ld[<span class="stringliteral">&#39;timestamps&#39;</span>])        </div><div class="line"><a name="l00260"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a341500c7bb7d7614072055acc193df47">  260</a></span>&#160;    wheel_mms_TM=wheel_mms_TM+<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">unroll_Talmo_data</a>(ld[<span class="stringliteral">&#39;wheel_mms&#39;</span>])        </div><div class="line"><a name="l00261"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a64f8ed63e7f9bbc5f2d5a8866c1800c4">  261</a></span>&#160;    nose_TM=nose_TM+<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">unroll_Talmo_data</a>(ld[<span class="stringliteral">&#39;nose&#39;</span>],is_nose=<span class="keyword">True</span>) </div><div class="line"><a name="l00262"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a42ebbe22a90ac952e99298165e9ef3e3">  262</a></span>&#160;    nose_vel_TM=nose_vel_TM+<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">unroll_Talmo_data</a>(ld[<span class="stringliteral">&#39;nose_vel&#39;</span>],is_nose=<span class="keyword">True</span>) </div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00264"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aaa648d0b360927c2bd1f3e95c5f24868">  264</a></span>&#160;tiff_names_chunks=[] </div><div class="line"><a name="l00265"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a612cf517f82e24ec730227ced7f2f9dc">  265</a></span>&#160;sess_name_chunks=[]</div><div class="line"><a name="l00266"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a44e2cd7ce45e00cf4f45f6eef7ed2840">  266</a></span>&#160;idx_trials_chunks=[]</div><div class="line"><a name="l00267"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8a24cf9eef75734e6d1d1d898c4d8bb1">  267</a></span>&#160;animal_chunks=[]</div><div class="line"><a name="l00268"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a07ea1e18401daf33ed6ec189d74c4f08">  268</a></span>&#160;timestamps_TM_chunk=[]</div><div class="line"><a name="l00269"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a46f5e20fbe11cc2a43eeaabfb3e917b8">  269</a></span>&#160;wheel_mms_TM_chunk=[]</div><div class="line"><a name="l00270"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a542d5d23c3865cbd4d22219924656242">  270</a></span>&#160;nose_vel_TM_chunk=[]</div><div class="line"><a name="l00271"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb4f06d0f75b41be74a9ad6a8df82824">  271</a></span>&#160;conversion_to_cm_sec=10</div><div class="line"><a name="l00272"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a968ae7783d5d4a0970a9984cfb663c3b">  272</a></span>&#160;scale_eye=.14</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="keywordflow">for</span> tr_fl,tr_bh,eye,whe,tm,fl,nm,pos_examples,A <span class="keywordflow">in</span> zip(triggers_chunk_fluo, triggers_chunk_bh, eyelid_chunk, wheel_chunk, tm_behav, fluo_chunk,names_chunks,pos_examples_chunks,A_chunks):</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    print(nm)</div><div class="line"><a name="l00275"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a978c1602c1c480e86c09f3c3a1b8cc98">  275</a></span>&#160;    init,delta=(np.int(nm.split(<span class="stringliteral">&#39;/&#39;</span>)[-1].split(<span class="stringliteral">&#39;#&#39;</span>)[0][-12:-7]),np.int(nm.split(<span class="stringliteral">&#39;/&#39;</span>)[-1].split(<span class="stringliteral">&#39;#&#39;</span>)[1][1:4].replace(<span class="stringliteral">&#39;_&#39;</span>,<span class="stringliteral">&#39;&#39;</span>)))</div><div class="line"><a name="l00276"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac2b5da21193b63655dcfb17190eed1c1">  276</a></span>&#160;    idx_names=np.arange(init,init+delta)</div><div class="line"><a name="l00277"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a41823cfc1a3bd9b29063d77847bce24f">  277</a></span>&#160;    fnames_behavior_talmo_tmp=[]</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    sess_name_chunks.append(nm.split(<span class="stringliteral">&#39;#&#39;</span>)[0].split(<span class="stringliteral">&#39;/&#39;</span>)[-2])</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    animal_chunks.append(nm.split(<span class="stringliteral">&#39;#&#39;</span>)[0].split(<span class="stringliteral">&#39;/&#39;</span>)[-3])</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae2e3d050e7bb4d748a449b1b2831f0ca">  281</a></span>&#160;    idx_sess = np.where([sess_name_chunks[-1] == xp <span class="keywordflow">for</span> xp <span class="keywordflow">in</span> exptNames_TM])[0]</div><div class="line"><a name="l00282"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a46dc2b240b1b87eb06912d44a1c4c47a">  282</a></span>&#160;    wheel_tmp=wheel_mms_TM[idx_sess]</div><div class="line"><a name="l00283"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5bec65d31217489cf3d674a8757d9d15">  283</a></span>&#160;    nose_tmp=nose_vel_TM[idx_sess]</div><div class="line"><a name="l00284"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aff9ba3ba39266c98ffbe52fab9fe36be">  284</a></span>&#160;    time_TM_tmp=timestamps_TM[idx_sess]</div><div class="line"><a name="l00285"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a661d71c505b85c0706e566de1f07ee4f">  285</a></span>&#160;    tm_=[]</div><div class="line"><a name="l00286"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0e072ba42710b0861f033c246124dd79">  286</a></span>&#160;    wh_=[]</div><div class="line"><a name="l00287"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a89d4924a67595da4ffa0cbb1ec903cf6">  287</a></span>&#160;    ns_=[]</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="keywordflow">for</span> idx_name <span class="keywordflow">in</span> idx_names:          </div><div class="line"><a name="l00289"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8a99870f43842689c9a474d0b0bc9acc">  289</a></span>&#160;        nm_tmp=nm.split(<span class="stringliteral">&#39;#&#39;</span>)[0][:-10] + str(idx_name).zfill(3)</div><div class="line"><a name="l00290"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac46e6087ddc50939ea50c9373b62cce2">  290</a></span>&#160;        target_file = glob(nm_tmp + <span class="stringliteral">&#39;*.tif&#39;</span>)</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;        <span class="keywordflow">if</span> len(target_file ) != 1:</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">#               print len(target_file)</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;            <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Zero or too many matches&#39;</span>)               </div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;        fnames_behavior_talmo_tmp.append(target_file)   </div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;        wh_.append(old_div(wheel_tmp[idx_name-1],conversion_to_cm_sec))</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">#           print len(nose_tmp[idx_name-1])</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        ns_.append(nose_tmp[idx_name-1]/np.median(np.diff(time_TM_tmp[idx_name-1]))*scale_eye/conversion_to_cm_sec)</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        tm_.append(time_TM_tmp[idx_name-1])</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">#           timestamps_TM_chunk_TMP.append()</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">#           wheel_mms_TM_chunk_TMP.append()</span></div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;    <span class="keywordflow">if</span> len(fnames_behavior_talmo_tmp) != len(tr_bh):</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Triggers not matching&#39;</span>)     </div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;    tiff_names_chunks.append(fnames_behavior_talmo_tmp)   </div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    idx_trials_chunks.append(idx_names)</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    timestamps_TM_chunk.append(np.array(tm_))</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    wheel_mms_TM_chunk.append(np.array(wh_))</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    nose_vel_TM_chunk.append(np.array(ns_))</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">#%% define zones with big neurons</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="keywordflow">if</span> <span class="keyword">False</span>:</div><div class="line"><a name="l00313"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1ea8996b18bf5cd8e60325cf134421f0">  313</a></span>&#160;    min_pix=20</div><div class="line"><a name="l00314"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad790116dd051f2b8072c467458e6b8b7">  314</a></span>&#160;    max_pix=492</div><div class="line"><a name="l00315"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abea1e9f6e0c60a20ff31142cce325e32">  315</a></span>&#160;    good_neurons_chunk=[]</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    <span class="keywordflow">for</span> fl,nm, pos_examples, A, tiff_names  <span class="keywordflow">in</span>  zip(fluo_chunk,names_chunks,pos_examples_chunks,A_chunks,tiff_names_chunks):</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;        print(nm)</div><div class="line"><a name="l00318"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a403776649ddb048f53466fb5c178e87f">  318</a></span>&#160;        idx_large_neurons=[]</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        with np.load(glob(os.path.join(os.path.dirname(nm),<span class="stringliteral">&#39;*template*.npz&#39;</span>))[0]) <span class="keyword">as</span> ld:</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;            pl.cla()</div><div class="line"><a name="l00321"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a86d0d51ceb4bc3bd26707520f257a5a4">  321</a></span>&#160;            img=np.median(ld[<span class="stringliteral">&#39;template_each&#39;</span>],0)</div><div class="line"><a name="l00322"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#adad90fa030af56592ad194a41341ffcd">  322</a></span>&#160;        masks=cse.utilities.nf_read_roi_zip(os.path.join(os.path.dirname(nm),<span class="stringliteral">&#39;RoiSet.zip&#39;</span>),(512,512))        </div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        <span class="keywordflow">for</span> mask <span class="keywordflow">in</span> masks:</div><div class="line"><a name="l00324"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a401c559d8e4a7fd7c1e1b825817bb7f2">  324</a></span>&#160;            mask_flat=np.reshape(mask,(512*512),order=<span class="stringliteral">&#39;F&#39;</span>)</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;            idx_large_neurons=idx_large_neurons+list(np.where(A.T.dot(mask_flat))[0])</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;        idx_large_neurons=np.unique(idx_large_neurons) </div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af6e13f59db4997e800590585332e2c52">  329</a></span>&#160;        f_perc=np.array([np.percentile(f,90,1) <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fl])</div><div class="line"><a name="l00330"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a44524fbb126722b457692771476e5249">  330</a></span>&#160;        too_active_neurons=np.where(np.mean(f_perc,0)&gt;=4)[0]</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="comment">#        cb.movie(img,fr=1).save(os.path.join(os.path.dirname(nm),&#39;template_large_neurons.tif&#39;))</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;    <span class="comment">#    lq,hq=np.percentile(img,[1, 99])</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;    <span class="comment">#    pl.imshow(img,cmap=&#39;gray&#39;,vmin=lq,vmax=hq)</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    <span class="comment">#    pl.imshow(np.sum(masks,0),cmap=&#39;hot&#39;,alpha=.3,vmax=3)</span></div><div class="line"><a name="l00335"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a304f5995e31fc2154d12062899457cd1">  335</a></span>&#160;        fl_tot=np.concatenate(fl,1)</div><div class="line"><a name="l00336"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a46a1998e8caf29d775ca749a64105249">  336</a></span>&#160;        fitness,erfc=cse.utilities.compute_event_exceptionality(fl_tot)</div><div class="line"><a name="l00337"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#adb5fa60c90fd0edc65820292aa458df3">  337</a></span>&#160;        good_traces=np.where(fitness&lt;-10)[0]</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac08d90552f6d0fcfee33d5d1616ad1a0">  339</a></span>&#160;        coms=cse.utilities.com(A.todense(),512,512)    </div><div class="line"><a name="l00340"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a819a60e0f103c556613457ca2872f09c">  340</a></span>&#160;        border_neurons=np.unique(np.concatenate([np.where(coms[:,0]&gt;max_pix)[0],</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;        np.where(coms[:,0]&lt;min_pix)[0],</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;        np.where(coms[:,1]&gt;max_pix)[0],</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;        np.where(coms[:,1]&lt;min_pix)[0]]))  </div><div class="line"><a name="l00344"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a28095841409e8a45905cac46e01b0fd1">  344</a></span>&#160;        final_examples=np.setdiff1d(pos_examples,border_neurons)</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;        final_examples=np.setdiff1d(final_examples,idx_large_neurons)</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        final_examples=np.setdiff1d(final_examples,too_active_neurons)</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;        final_examples=np.intersect1d(final_examples,good_traces)</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;        good_neurons_chunk.append(final_examples)</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        print((len(final_examples),np.shape(A)[-1]))    </div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;        img=A.tocsc()[:,final_examples].sum(1).reshape((512,512),order=<span class="stringliteral">&#39;F&#39;</span>)</div><div class="line"><a name="l00351"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a96135a7b659062db97bd3c8f41f859a8">  351</a></span>&#160;        lq,hq=np.percentile(img,[1, 99])</div><div class="line"><a name="l00352"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa8bf729ba75cfc1e378ba8b5a4ef782b">  352</a></span>&#160;        pl.imshow(img,cmap=<span class="stringliteral">&#39;gray&#39;</span>,alpha=1,vmin=lq,vmax=hq)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        pl.pause(.01)</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    np.savez(<span class="stringliteral">&#39;good_neurons_chunk.npz&#39;</span>,good_neurons_chunk=good_neurons_chunk)    </div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    with np.load(<span class="stringliteral">&#39;good_neurons_chunk.npz&#39;</span>)  <span class="keyword">as</span> ld:</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        good_neurons_chunk=ld[<span class="stringliteral">&#39;good_neurons_chunk&#39;</span>]</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="comment">#%%           </span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="comment">#triggers_chunk_fluo=  triggers_chunk_fluo[idx_sorted]</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">#triggers_chunk_bh=  triggers_chunk_bh[idx_sorted]</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">#eyelid_chunk=  eyelid_chunk[idx_sorted] </span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">#wheel_chunk=  wheel_chunk[idx_sorted] </span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;<span class="comment">#tm_behav=  tm_behav[idx_sorted]</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="comment">#fluo_chunk=  fluo_chunk[idx_sorted]</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;<span class="comment">#pos_examples_chunks=  pos_examples_chunks[idx_sorted]</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;<span class="comment">#A_chunks=  A_chunks[idx_sorted]</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;<span class="comment">#%% ** PARAMS ****</span></div><div class="line"><a name="l00369"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acbb3060491f0937f72fcf05bb0542964">  369</a></span>&#160;thresh_middle=.15</div><div class="line"><a name="l00370"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af7cfd8e1a6562b67ab52c8bcd6bb0546">  370</a></span>&#160;thresh_advanced=.4</div><div class="line"><a name="l00371"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a611c309db2a3dac4a48020f616a76bb3">  371</a></span>&#160;thresh_late=.8</div><div class="line"><a name="l00372"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a107d4d1c63a85e2de8df293c3740c8d3">  372</a></span>&#160;time_CR_on=-.1</div><div class="line"><a name="l00373"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a00a2a84db4928c34b48e9d4ddd1f5c64">  373</a></span>&#160;time_US_on=.035</div><div class="line"><a name="l00374"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1bca48e068cf27ba43b8a0566a98a52c">  374</a></span>&#160;thresh_mov=2</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="comment">#thresh_MOV_iqr=100</span></div><div class="line"><a name="l00376"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a727ae5d0feb6d80d0b4e053d48211656">  376</a></span>&#160;time_CS_on_MOV=-.25</div><div class="line"><a name="l00377"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3edfc1d56f8f98f4ce7e255d419fe431">  377</a></span>&#160;time_US_on_MOV=0</div><div class="line"><a name="l00378"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d7de1871921d7abdd4f1badfbf22796">  378</a></span>&#160;thresh_CR = 0.1,</div><div class="line"><a name="l00379"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4a0e3eb0ed53393ba93583d1a3a6dfa9">  379</a></span>&#160;thresh_CR_whisk=0.15</div><div class="line"><a name="l00380"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a571d364049716d1323cc3e277688d216">  380</a></span>&#160;threshold_responsiveness=0.1</div><div class="line"><a name="l00381"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a88c21210c8737a674203460a0e573377">  381</a></span>&#160;time_bef=2.9</div><div class="line"><a name="l00382"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af16a4b1a1363393556fb3eb427f1ab60">  382</a></span>&#160;time_aft=4.5</div><div class="line"><a name="l00383"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af1f85a3b712eb50e3e69841fb96eaed0">  383</a></span>&#160;f_rate_fluo=old_div(1,30.0)</div><div class="line"><a name="l00384"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a498f288a00f713841466c37a1b5c9a27">  384</a></span>&#160;ISI=.25</div><div class="line"><a name="l00385"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4ce11e53f3e245ad26b9fbf58b4465e6">  385</a></span>&#160;min_trials=8 <span class="comment"># was 8</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3df6e04c30535a9ea0e4942db271164b">  387</a></span>&#160;thresh_wheel = 5</div><div class="line"><a name="l00388"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a51553ab80d2bbbac023e65d3f73a476d">  388</a></span>&#160;thresh_nose = 1 </div><div class="line"><a name="l00389"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a49ed8d10b35b9f58ee56e2f9272ac36b">  389</a></span>&#160;thresh_eye = .1 </div><div class="line"><a name="l00390"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a200ea3a7f4fbc6044d8c7f69593436b5">  390</a></span>&#160;thresh_fluo_log=-10        </div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="comment">#%% compute all binned behavior</span></div><div class="line"><a name="l00392"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3c0d994be1c715797f5e56dd1a384f00">  392</a></span>&#160;all_nose_binned=[]</div><div class="line"><a name="l00393"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a66aebf86f8f2180fa00992becded1b80">  393</a></span>&#160;all_wheel_binned=[]</div><div class="line"><a name="l00394"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a59cf13c89d0371949cc42b507bb8cf06">  394</a></span>&#160;all_binned_eye=[]</div><div class="line"><a name="l00395"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a205334cf2d1e1dc942efed70a9092829">  395</a></span>&#160;all_binned_UR=[]</div><div class="line"><a name="l00396"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a01cf6c5854d91322e2c190c0cca7e57d">  396</a></span>&#160;all_binned_CR=[]</div><div class="line"><a name="l00397"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af4bebcfddccb8a16780a3434aab2200b">  397</a></span>&#160;mouse_now=<span class="stringliteral">&#39;&#39;</span>      </div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="keywordflow">for</span> tr_fl, tr_bh, eye, whe, tm, fl, nm, pos_examples, A, tiff_names, timestamps_TM_ ,wheel_mms_TM_, nose_vel_TM_ <span class="keywordflow">in</span>\</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    zip(triggers_chunk_fluo, triggers_chunk_bh, eyelid_chunk, wheel_chunk, tm_behav, fluo_chunk,names_chunks,good_neurons_chunk,A_chunks,tiff_names_chunks,timestamps_TM_chunk,wheel_mms_TM_chunk,nose_vel_TM_chunk):</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;</div><div class="line"><a name="l00402"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa0823e1ff851f7526e7fc5487718a051">  402</a></span>&#160;    session=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[8]</div><div class="line"><a name="l00403"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae8bf5a756cf15252b4e514a258bbbde9">  403</a></span>&#160;    day=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[8][:8]</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    print(nm)</div><div class="line"><a name="l00405"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a82ea9104f52769a0b124b074bf4ce36e">  405</a></span>&#160;    mouse=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[7]</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="keywordflow">if</span> mouse != mouse_now:</div><div class="line"><a name="l00407"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab962698e36f27034c78e895fd47d5b28">  407</a></span>&#160;        cell_counter=0</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;        mouse_now=mouse</div><div class="line"><a name="l00409"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a23182f9f7cb123b4779c1f9b78eb24b4">  409</a></span>&#160;        session_id = 0</div><div class="line"><a name="l00410"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9518ca549fd92ccc74aaff1ac9e587ab">  410</a></span>&#160;        session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l00411"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab888ee482c0e8ac91b65025c93c42702">  411</a></span>&#160;        learning_phase=0</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        print(<span class="stringliteral">&#39;early&#39;</span>)</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        <span class="keywordflow">if</span> day != session_now:</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;            session_id += 1</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            session_now=day</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4180e227b48ebb1901dbb822f1fc95f6">  420</a></span>&#160;    chunk=re.search(<span class="stringliteral">&#39;_00[0-9][0-9][0-9]_&#39;</span>,nm.split(<span class="stringliteral">&#39;/&#39;</span>)[9]).group(0)[3:-1]</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div><div class="line"><a name="l00422"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a15e3c2922e60f17a3bb8cb68c9ad2f6b">  422</a></span>&#160;    idx_CS_US=np.where(tr_bh[:,-2]==2)[0]</div><div class="line"><a name="l00423"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac4976ca3d8753184a953ba9383e8063d">  423</a></span>&#160;    idx_US=np.where(tr_bh[:,-2]==1)[0]</div><div class="line"><a name="l00424"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a035a49da0a4e38078a747d0627f435da">  424</a></span>&#160;    idx_CS=np.where(tr_bh[:,-2]==0)[0]</div><div class="line"><a name="l00425"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a358647b58b31adb966c22d6b9d58baf6">  425</a></span>&#160;    idx_ALL=np.sort(np.hstack([idx_CS_US,idx_US,idx_CS]))</div><div class="line"><a name="l00426"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a669a99f67f2b96208097f47c655c1148">  426</a></span>&#160;    eye_traces,amplitudes_at_US, trig_CRs=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a548726920163e9294689515308c625ca">process_eyelid_traces</a>(eye,tm,idx_CS_US,idx_US,idx_CS,thresh_CR=thresh_CR,time_CR_on=time_CR_on,time_US_on=time_US_on)        </div><div class="line"><a name="l00427"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3ddd469661d8f14178f03776ca1d89bf">  427</a></span>&#160;    idxCSUSCR = trig_CRs[<span class="stringliteral">&#39;idxCSUSCR&#39;</span>]</div><div class="line"><a name="l00428"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa690167b16ea72829e5182bbe1356932">  428</a></span>&#160;    idxCSUSNOCR = trig_CRs[<span class="stringliteral">&#39;idxCSUSNOCR&#39;</span>]</div><div class="line"><a name="l00429"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8c2b57b9dd59f0b4b244e2b196dca54b">  429</a></span>&#160;    idxCSCR = trig_CRs[<span class="stringliteral">&#39;idxCSCR&#39;</span>]</div><div class="line"><a name="l00430"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4e6c9582d2bc622f83e52c3c9880da1b">  430</a></span>&#160;    idxCSNOCR = trig_CRs[<span class="stringliteral">&#39;idxCSNOCR&#39;</span>]</div><div class="line"><a name="l00431"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a27625d5790508ef73555f2869d8498be">  431</a></span>&#160;    idxNOCR = trig_CRs[<span class="stringliteral">&#39;idxNOCR&#39;</span>]</div><div class="line"><a name="l00432"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4fde82ade2a033e470e913661580aa3c">  432</a></span>&#160;    idxCR = trig_CRs[<span class="stringliteral">&#39;idxCR&#39;</span>]</div><div class="line"><a name="l00433"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3ee331a9a59c18d08f4f6812ba02a82b">  433</a></span>&#160;    idxUS = trig_CRs[<span class="stringliteral">&#39;idxUS&#39;</span>]</div><div class="line"><a name="l00434"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa71d2cfcca07f65aa2981eeca13c79eb">  434</a></span>&#160;    idxCSCSUS=np.concatenate([idx_CS,idx_CS_US]) </div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    <span class="keywordflow">if</span> 0:</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;        <span class="comment"># ANDREA&#39;S WHEEL</span></div><div class="line"><a name="l00439"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae2529d2bd95fb76b3f6ee12e4309e3c3">  439</a></span>&#160;        wheel_traces, movement_at_CS, trigs_mov = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#ac9cde14ba363f17139f7a84a7164e5f4">process_wheel_traces</a>(np.array(whe),tm,thresh_MOV_iqr=thresh_MOV_iqr,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV)  </div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        <span class="comment"># TALMO&#39;S WHEEL</span></div><div class="line"><a name="l00443"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1cf26fc3f7938b5eb2c643c960412213">  443</a></span>&#160;        wheel_traces, movement_at_CS, trigs_mov = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a9e7ada950fa11b7fa54ea6bffa5ca746">process_wheel_traces_talmo</a>(wheel_mms_TM_,timestamps_TM_.copy(),tm,thresh_MOV=thresh_mov,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV) </div><div class="line"><a name="l00444"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa8b183281ee4ba69903dc8a53c23d25d">  444</a></span>&#160;        nose_traces, movement_at_CS_nose, trigs_mov_nose = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a9e7ada950fa11b7fa54ea6bffa5ca746">process_wheel_traces_talmo</a>(nose_vel_TM_,timestamps_TM_.copy(),tm,thresh_MOV=0,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV) </div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div><div class="line"><a name="l00447"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af62495e46c23d2f51b79ee57ed258b08">  447</a></span>&#160;        n_samples_ISI = np.int(old_div(ISI,np.median(np.diff(tm))))</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        <span class="comment"># FIX FOR US SHIFT IN DATA</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        wheel_traces[idxUS]=np.concatenate([wheel_traces[idxUS,:n_samples_ISI].copy(),wheel_traces[idxUS,:-n_samples_ISI].copy()],1)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        nose_traces[idxUS]=np.concatenate([nose_traces[idxUS,:n_samples_ISI].copy(),nose_traces[idxUS,:-n_samples_ISI].copy()],1)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    print((<span class="stringliteral">&#39;fraction with movement:&#39;</span>    + str(len(trigs_mov[<span class="stringliteral">&#39;idxMOV&#39;</span>])*1./(len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])+len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])))))</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;</div><div class="line"><a name="l00457"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a568facb8c67fa2ae19927a66839c2835">  457</a></span>&#160;    mn_idx_CS_US =np.intersect1d(idx_CS_US,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00458"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a72eb1cb0aacdf4ea7d85f884e2f32ab3">  458</a></span>&#160;    nm_idx_US= idx_US</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div><div class="line"><a name="l00460"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a955e3147e4a6cb74c143022fd0ffcf76">  460</a></span>&#160;    nm_idx_CS= np.intersect1d(idx_CS,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00461"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a58b4b4682d4db437616605002cefadf2">  461</a></span>&#160;    nm_idxCSUSCR = np.intersect1d(idxCSUSCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00462"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a568ffd192bd75c88de757aa696ebee64">  462</a></span>&#160;    nm_idxCSUSNOCR = np.intersect1d(idxCSUSNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00463"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5745a5b30c81ea399be0a6cc7d90e201">  463</a></span>&#160;    nm_idxCSCR = np.intersect1d(idxCSCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00464"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a52d2c9411bf83a6c6abc4a9231a2c851">  464</a></span>&#160;    nm_idxCSNOCR = np.intersect1d(idxCSNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00465"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2d4cea86af68edf6218a92bc484f8795">  465</a></span>&#160;    nm_idxNOCR = np.intersect1d(idxNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1dec837f76ba3ed6a4e698e61584ee79">  466</a></span>&#160;    nm_idxCR = np.intersect1d(idxCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00467"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6165156fb6d56ac7c43a4e3828b0e93c">  467</a></span>&#160;    nm_idxCSCSUS = np.intersect1d(idxCSCSUS,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])  </div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac90efd7e096e1b16c9bd770c63ff357d">  471</a></span>&#160;    trial_names=[<span class="stringliteral">&#39;&#39;</span>]*wheel_traces.shape[0]</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    <span class="keywordflow">for</span> CSUSNoCR <span class="keywordflow">in</span> nm_idxCSUSNOCR:</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;        trial_names[CSUSNoCR]=<span class="stringliteral">&#39;CSUSNoCR&#39;</span>  </div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="keywordflow">for</span> CSUSwCR <span class="keywordflow">in</span> nm_idxCSUSCR:</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        trial_names[CSUSwCR]=<span class="stringliteral">&#39;CSUSwCR&#39;</span>  </div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="keywordflow">for</span> US <span class="keywordflow">in</span> nm_idx_US:</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        trial_names[US]=<span class="stringliteral">&#39;US&#39;</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="keywordflow">for</span> CSwCR <span class="keywordflow">in</span> nm_idxCSCR:</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        trial_names[CSwCR]=<span class="stringliteral">&#39;CSwCR&#39;</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">for</span> CSNoCR <span class="keywordflow">in</span> nm_idxCSNOCR:</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;        trial_names[CSNoCR]=<span class="stringliteral">&#39;CSNoCR&#39;</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0ceb0337feb5652981ecdb41e53afa43">  486</a></span>&#160;    len_min=np.min([np.array(f).shape <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fl]) <span class="comment"># minimal length of trial</span></div><div class="line"><a name="l00487"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d85a403a5511da7f6041ea7957638c5">  487</a></span>&#160;    selct = <span class="keyword">lambda</span> cs,us: np.int(cs) <span class="keywordflow">if</span> np.isnan(us) <span class="keywordflow">else</span> np.int(us)</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <span class="comment"># index of US</span></div><div class="line"><a name="l00489"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab36f3d34e11dbcc9d0f8ae8d03cb9db5">  489</a></span>&#160;    trigs_US=[<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d85a403a5511da7f6041ea7957638c5">selct</a>(cs,us) <span class="keywordflow">for</span> cs,us <span class="keywordflow">in</span> zip(tr_fl[:,0],tr_fl[:,1])]     </div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="comment">#for binning</span></div><div class="line"><a name="l00492"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac71af6e0147e139c7c31aefe5eeb0f02">  492</a></span>&#160;    samplbef=np.int(old_div(time_bef,f_rate_fluo))</div><div class="line"><a name="l00493"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aea73f83ea6b775a30339510b9f3b2153">  493</a></span>&#160;    samplaft=np.int(old_div(time_aft,f_rate_fluo)) </div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    <span class="comment"># create fluorescence matrix</span></div><div class="line"><a name="l00496"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab3ff0708d91f2bcf1e4e73fe84a71aa1">  496</a></span>&#160;    f_flat=np.concatenate([f[:,tr - samplbef:samplaft+tr] <span class="keywordflow">for</span> tr,f <span class="keywordflow">in</span> zip(trigs_US,fl)],1)</div><div class="line"><a name="l00497"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab605ee43c5085e8be20ef0cb1a6ee254">  497</a></span>&#160;    f_mat=np.concatenate([f[:,tr -samplbef:samplaft+tr][np.newaxis,:] <span class="keywordflow">for</span> tr,f <span class="keywordflow">in</span> zip(trigs_US,fl)],0)</div><div class="line"><a name="l00498"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0a22486c43580b31f6902e166e037cf5">  498</a></span>&#160;    time_fl=np.arange(-samplbef,samplaft)*f_rate_fluo </div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <span class="comment"># remove baseline</span></div><div class="line"><a name="l00500"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abf52f9a4b69cf415055160aa94b0e1fa">  500</a></span>&#160;    f_mat_bl=f_mat-np.median(f_mat[:,:,np.logical_and(time_fl&gt;-1,time_fl&lt;-ISI)],axis=(2))[:,:,np.newaxis]   </div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9439f9bfc4363e871e807d6643990ed1">  502</a></span>&#160;    amplitudes_responses=np.mean(f_mat_bl[:,:,np.logical_and(time_fl&gt;-.03,time_fl&lt;.04)],-1)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div><div class="line"><a name="l00505"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5bc145ba89fbd1bbf94942fcead052d0">  505</a></span>&#160;    cell_responsiveness=np.median(amplitudes_responses[nm_idxCSCSUS],axis=0)</div><div class="line"><a name="l00506"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a03e1b70cc9b45304f62f50a9a981cc5d">  506</a></span>&#160;    idx_responsive = np.where(cell_responsiveness&gt;threshold_responsiveness)[0]</div><div class="line"><a name="l00507"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4562f50f9cf0734b29c66eda0ba9ef1f">  507</a></span>&#160;    fraction_responsive=len(np.where(cell_responsiveness&gt;threshold_responsiveness)[0])*1./np.shape(f_mat_bl)[1]</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="comment">#    a=pd.DataFrame(data=f_mat[0,idx_components[:10],:],columns=np.arange(-30,30)*.033,index=idx_components[:10])</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    <span class="comment"># only take the preselected components</span></div><div class="line"><a name="l00512"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0bc71701eadbbfaba0da75c3d52f5de7">  512</a></span>&#160;    idx_components_final=pos_examples</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    idx_responsive = np.intersect1d(idx_responsive,idx_components_final)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;    cell_counter=cell_counter+len(idx_components_final)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    print(cell_counter)    </div><div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae72f55d650d9441596fdea32c4edd7f6">  517</a></span>&#160;    f_mat_bl_part=f_mat[:,idx_components_final,:].copy()</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    <span class="comment"># compute periods of activity for each neuron</span></div><div class="line"><a name="l00520"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d867786833d48fb08c9a89d159e6898">  520</a></span>&#160;    f_mat_bl_erfc=f_mat_bl_part.transpose([1,0,2]).reshape((-1,np.shape(f_mat_bl_part)[0]*np.shape(f_mat_bl_part)[-1]))            </div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    f_mat_bl_erfc[np.isnan(f_mat_bl_erfc)]=0            </div><div class="line"><a name="l00522"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a18f05aeddc212b523b40818fa2b87b33">  522</a></span>&#160;    fitness, f_mat_bl_erfc,_ = <a class="code" href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">compute_event_exceptionality</a>(f_mat_bl_erfc)</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;    f_mat_bl_erfc=f_mat_bl_erfc.reshape([-1, np.shape(f_mat_bl_part)[0], np.shape(f_mat_bl_part)[-1]]).transpose([1,0,2])        </div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac8d13b4338b21cc435b143d396052b94">  526</a></span>&#160;    bin_edge=np.arange(-3,4.5,.1)</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7ab0f6d3a0c198191854a5b4ff9a1ff6">  528</a></span>&#160;    bins=pd.cut(time_fl,bins=bin_edge)</div><div class="line"><a name="l00529"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9a0e7053b5fe58cb47e7d4754cf3c797">  529</a></span>&#160;    bins_tm=pd.cut(tm,bins=bin_edge)</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;</div><div class="line"><a name="l00531"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a747aa3b6e3d408377844fb2b86764cbe">  531</a></span>&#160;    time_bef_edge=-0.25</div><div class="line"><a name="l00532"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6d5c58fce5365f0b7c1d6b1f168fabc3">  532</a></span>&#160;    time_aft_edge=1.5    </div><div class="line"><a name="l00533"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9a53e526aa8f6d9b7a64c397ab12a101">  533</a></span>&#160;    min_r=-1.1 <span class="comment"># 0</span></div><div class="line"><a name="l00534"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0ffacac98b2d3e048a5420f3abfd8365">  534</a></span>&#160;    min_confidence=100<span class="comment">#.01</span></div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div><div class="line"><a name="l00537"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2c0cf3dabc718b01fbc20ca81ede46bb">  537</a></span>&#160;    idx_good_samples=np.where(np.logical_or(time_fl&lt;=time_bef_edge,time_fl&gt;=time_aft_edge))[0]</div><div class="line"><a name="l00538"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a25e59b5f2960e9effde2274f35c1eb82">  538</a></span>&#160;    idx_good_samples_tm=np.where(np.logical_or(tm&lt;=time_bef_edge,tm&gt;=time_aft_edge))[0]</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div><div class="line"><a name="l00540"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8df3a02d40f5084094720895996749b2">  540</a></span>&#160;    time_ds_idx=np.where(np.logical_or(bin_edge&lt;=time_bef_edge,bin_edge&gt;=time_aft_edge))[0][1:]-1</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad3d6ab41a0b86791bd38c8c5cc9b669d">  542</a></span>&#160;    dfs=[pd.DataFrame(f_mat_bl_part[:,ii,:].T,index=time_fl) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_part)[1])]</div><div class="line"><a name="l00543"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad3eb20075e1e1c9ceb8d287bb18473c3">  543</a></span>&#160;    binned_fluo=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    binned_fluo[np.isnan(binned_fluo)]=0</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;    dfs=[pd.DataFrame(wheel_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(wheel_traces)[0])]</div><div class="line"><a name="l00547"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a20983d1ad46ef005de796f5ea2a8e70d">  547</a></span>&#160;    binned_wheel=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    binned_wheel[np.isnan(binned_wheel)]=0        </div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    dfs=[pd.DataFrame(eye_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(eye_traces)[0])]</div><div class="line"><a name="l00551"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9194568fb0c76d9ac368182a4df596a8">  551</a></span>&#160;    binned_eye=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;    binned_eye[np.isnan(binned_eye)]=0</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    dfs=[pd.DataFrame(nose_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(nose_traces)[0])]</div><div class="line"><a name="l00555"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#adee2e06ed1f0df9c3b1c504f7de09ebb">  555</a></span>&#160;    binned_nose=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    binned_nose[np.isnan(binned_nose)]=0</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    dfs=[pd.DataFrame(f_mat_bl_erfc[:,ii,:].T,index=time_fl) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_erfc)[1])]            </div><div class="line"><a name="l00559"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac3ac9512170368bda866a28a66c2f864">  559</a></span>&#160;    binned_fluo_erfc=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    binned_fluo_erfc[np.isnan(binned_fluo_erfc)]=0</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    all_nose_binned.append(binned_nose)</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    all_wheel_binned.append(binned_wheel)</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    all_binned_eye.append(binned_eye)</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;</div><div class="line"><a name="l00569"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae25d84e71ba4b38d038859a7b5a93a23">  569</a></span>&#160;    amplitudes_responses_US_fl=f_mat_bl[idx_US,:,:,][:,idx_components_final,:,][:,:,np.logical_and(time_fl&gt;0.03,time_fl&lt;.75)]</div><div class="line"><a name="l00570"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3cd075659d21b5a790239cf74ba52e0f">  570</a></span>&#160;    ampl_UR_eye=scipy.signal.resample(eye_traces[idx_US,:][:,np.logical_and(tm&gt;.03,tm&lt;.75)],np.shape(amplitudes_responses_US_fl)[-1],axis=1)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    all_binned_UR.append(ampl_UR_eye)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;</div><div class="line"><a name="l00574"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad749668c9dd96de41518e17fdccb3905">  574</a></span>&#160;    amplitudes_responses_CR_fl=f_mat_bl[idxCSCSUS,:,:,][:,idx_components_final,:,][:,:,np.logical_and(time_fl&gt;-0.5,time_fl&lt;0.03)]</div><div class="line"><a name="l00575"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac91f07d41abc8d623a021af956ebb620">  575</a></span>&#160;    ampl_CR_eye=scipy.signal.resample(eye_traces[idxCSCSUS,:][:,np.logical_and(tm&gt;-.5,tm&lt;.03)],np.shape(amplitudes_responses_CR_fl)[-1],axis=1)</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;    all_binned_CR.append(ampl_CR_eye)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af4a0c8dc795f9a5a16b600645a1df9d6">  581</a></span>&#160;mat_all_nose=np.concatenate(all_nose_binned,0)   </div><div class="line"><a name="l00582"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6a9544fc7beea18d0bb0e0a77cc9088b">  582</a></span>&#160;mat_all_wheel=np.concatenate(all_wheel_binned,0)  </div><div class="line"><a name="l00583"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5e6f3278a8732f3c593de0278d87f117">  583</a></span>&#160;mat_all_eye=np.concatenate(all_binned_eye,0)   </div><div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad3240a8040944280ddcfa98a0d6c28c7">  584</a></span>&#160;mat_all_UR=np.concatenate(all_binned_UR,0)  </div><div class="line"><a name="l00585"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a666e78d2d7afc10123a850e668eac425">  585</a></span>&#160;mat_all_CR=np.concatenate(all_binned_CR,0)    </div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;pl.plot(np.mean(mat_all_nose,0))</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;pl.plot(np.mean(mat_all_wheel,0))</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;pl.plot(np.mean(mat_all_eye,0))</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;pl.plot(np.mean(mat_all_UR,0))</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;pl.plot(np.mean(mat_all_CR,0))</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">#%% define functions to perform evaluation</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> make_scorer</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score,ShuffleSplit</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="keyword">from</span> sklearn <span class="keyword">import</span> linear_model</div><div class="line"><a name="l00597"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af08d82dec3d2c26b2eb5eae6f2a3b561">  597</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af08d82dec3d2c26b2eb5eae6f2a3b561">my_custom_loss_func</a>(ground_truth, predictions):</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;    r = scipy.stats.pearsonr(ground_truth, predictions)</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;    <span class="keywordflow">return</span> r[0]</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5aa1ef714b2b06ce5b17a6e90feb7265">  601</a></span>&#160;score_ = make_scorer(my_custom_loss_func, greater_is_better=<span class="keyword">True</span>)</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5d193a58dc4764896ad3eb46db3fb20b">  603</a></span>&#160;lr = linear_model.LinearRegression()</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">#lr.fit(X,Y)</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;<span class="comment">#scipy.stats.pearsonr(Y.squeeze(),lr.predict(X).squeeze())</span></div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="comment">#scipy.stats.pearsonr(Y.squeeze(),cross_val_predict(lr, X, Y, cv=None).squeeze())</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="comment">#predicted = cross_val_predict(lr, X, Y, cv=20)</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;<span class="comment">#%% **********</span></div><div class="line"><a name="l00609"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">  609</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(X,*args,**kwargs):</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">return</span> np.nanmedian(X,*args,**kwargs)</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;mouse_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;session_id = 0</div><div class="line"><a name="l00615"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aff1abd4a1c28ffeae55d3b289f0d2e6d">  615</a></span>&#160;compute_redundancy = <span class="keyword">False</span></div><div class="line"><a name="l00616"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a31279cee848b2b71c47b68e9a5a22e3a">  616</a></span>&#160;check_timing= <span class="keyword">True</span></div><div class="line"><a name="l00617"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a01f46c229110788ec67a73b587bfbeb6">  617</a></span>&#160;redundancy=[]</div><div class="line"><a name="l00618"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7cfaced9a8091bda284390314a1c9528">  618</a></span>&#160;max_fluo_range=np.inf</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">#single_session = True</span></div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8426301833f76f45d63ea27b10bdff35">  621</a></span>&#160;cr_ampl=pd.DataFrame()</div><div class="line"><a name="l00622"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae474ea870ce2b76fbc8e380a6c190c49">  622</a></span>&#160;bh_correl=pd.DataFrame()</div><div class="line"><a name="l00623"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a566f14b7e5ede10573718a8aa2589067">  623</a></span>&#160;all_nose=[]  </div><div class="line"><a name="l00624"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#afe916e8deb835467309df4a82922bbfe">  624</a></span>&#160;all_wheel=[]  </div><div class="line"><a name="l00625"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7eefb40b5a43effa0470707d0f05921f">  625</a></span>&#160;session_nice_trials=[<span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b35/20160714143248/20160714143248_00061_00001-#-51_d1_512_d2_512_d3_1_order_C_frames_3535_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160629123648/20160629123648_00061_00001-#-40_d1_512_d2_512_d3_1_order_C_frames_2780_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160630120544/20160630120544_00121_00001-#-58_d1_512_d2_512_d3_1_order_C_frames_4029_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160701113525/20160701113525_00151_00001-#-39_d1_512_d2_512_d3_1_order_C_frames_2713_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160702152950/20160702152950_00151_00001-#-45_d1_512_d2_512_d3_1_order_C_frames_3125_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160703173620/20160703173620_00121_00001-#-50_d1_512_d2_512_d3_1_order_C_frames_3479_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160704130454/20160704130454_00151_00001-#-40_d1_512_d2_512_d3_1_order_C_frames_2791_.results_analysis_traces.pk&#39;</span>,</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160; <span class="stringliteral">&#39;/mnt/ceph/users/agiovann/ImagingData/eyeblink/b37/20160705103903/20160705103903_00121_00001-#-57_d1_512_d2_512_d3_1_order_C_frames_3977_.results_analysis_traces.pk&#39;</span>]  </div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;<span class="comment">#session_nice_trials=[]</span></div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;cell_counter=[]</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keywordflow">for</span> tr_fl, tr_bh, eye, whe, tm, fl, nm, pos_examples, A, tiff_names, timestamps_TM_ ,wheel_mms_TM_, nose_vel_TM_ <span class="keywordflow">in</span>\</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    zip(triggers_chunk_fluo, triggers_chunk_bh, eyelid_chunk, wheel_chunk,\</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;     tm_behav, fluo_chunk,names_chunks,good_neurons_chunk,A_chunks,tiff_names_chunks,\</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;     timestamps_TM_chunk,wheel_mms_TM_chunk,nose_vel_TM_chunk):</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keywordflow">if</span>  nm !=  session_nice_trials[-1]:</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        print(nm)</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;        <span class="keywordflow">continue</span>  </div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="comment">#        1       </span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    <span class="keywordflow">if</span> len(whe)&lt;20:</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;        print(<span class="stringliteral">&#39;skipping small files&#39;</span>)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;        <span class="keywordflow">continue</span></div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    session=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[8]</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    day=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[8][:8]</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    print(nm)</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    mouse=nm.split(<span class="stringliteral">&#39;/&#39;</span>)[7]</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    <span class="keywordflow">if</span> mouse != mouse_now:</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;        cell_counter=0</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;        mouse_now=mouse</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;        session_id = 0</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;        session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        learning_phase=0</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        print(<span class="stringliteral">&#39;early&#39;</span>)</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;        <span class="keywordflow">if</span> day != session_now:</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;            session_id += 1</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;            session_now=day</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    chunk=re.search(<span class="stringliteral">&#39;_00[0-9][0-9][0-9]_&#39;</span>,nm.split(<span class="stringliteral">&#39;/&#39;</span>)[9]).group(0)[3:-1]</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    idx_CS_US=np.where(tr_bh[:,-2]==2)[0]</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;    idx_US=np.where(tr_bh[:,-2]==1)[0]</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    idx_CS=np.where(tr_bh[:,-2]==0)[0]</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    idx_ALL=np.sort(np.hstack([idx_CS_US,idx_US,idx_CS]))</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    eye_traces,amplitudes_at_US, trig_CRs=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a548726920163e9294689515308c625ca">process_eyelid_traces</a>(eye,tm,idx_CS_US,idx_US,idx_CS,thresh_CR=thresh_CR,time_CR_on=time_CR_on,time_US_on=time_US_on)        </div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;    idxCSUSCR = trig_CRs[<span class="stringliteral">&#39;idxCSUSCR&#39;</span>]</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    idxCSUSNOCR = trig_CRs[<span class="stringliteral">&#39;idxCSUSNOCR&#39;</span>]</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    idxCSCR = trig_CRs[<span class="stringliteral">&#39;idxCSCR&#39;</span>]</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    idxCSNOCR = trig_CRs[<span class="stringliteral">&#39;idxCSNOCR&#39;</span>]</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;    idxNOCR = trig_CRs[<span class="stringliteral">&#39;idxNOCR&#39;</span>]</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    idxCR = trig_CRs[<span class="stringliteral">&#39;idxCR&#39;</span>]</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    idxUS = trig_CRs[<span class="stringliteral">&#39;idxUS&#39;</span>]</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;    idxCSCSUS=np.concatenate([idx_CS,idx_CS_US]) </div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">if</span> 0:</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="comment"># ANDREA&#39;S WHEEL</span></div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        wheel_traces, movement_at_CS, trigs_mov = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#ac9cde14ba363f17139f7a84a7164e5f4">process_wheel_traces</a>(np.array(whe),tm,thresh_MOV_iqr=thresh_MOV_iqr,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV)  </div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;        <span class="comment"># TALMO&#39;S WHEEL</span></div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;        wheel_traces, movement_at_CS, trigs_mov = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a9e7ada950fa11b7fa54ea6bffa5ca746">process_wheel_traces_talmo</a>(wheel_mms_TM_,timestamps_TM_.copy(),tm,thresh_MOV=thresh_mov,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV) </div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;        nose_traces, movement_at_CS_nose, trigs_mov_nose = <a class="code" href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a9e7ada950fa11b7fa54ea6bffa5ca746">process_wheel_traces_talmo</a>(nose_vel_TM_,timestamps_TM_.copy(),tm,thresh_MOV=0,time_CS_on=time_CS_on_MOV,time_US_on=time_US_on_MOV) </div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        n_samples_ISI = np.int(old_div(ISI,np.median(np.diff(tm))))</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;        <span class="comment"># FIX FOR US SHIFT IN DATA</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        wheel_traces[idxUS]=np.concatenate([wheel_traces[idxUS,:n_samples_ISI].copy(),wheel_traces[idxUS,:-n_samples_ISI].copy()],1)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        nose_traces[idxUS]=np.concatenate([nose_traces[idxUS,:n_samples_ISI].copy(),nose_traces[idxUS,:-n_samples_ISI].copy()],1)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    print((<span class="stringliteral">&#39;fraction with movement:&#39;</span>    + str(len(trigs_mov[<span class="stringliteral">&#39;idxMOV&#39;</span>])*1./(len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])+len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])))))</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;</div><div class="line"><a name="l00704"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6989feee83269e5b0a19f1b103e1d3bc">  704</a></span>&#160;    fraction_movement=len(trigs_mov[<span class="stringliteral">&#39;idxMOV&#39;</span>])*1./(len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])+len(trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>]))</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    mn_idx_CS_US =np.intersect1d(idx_CS_US,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    nm_idx_US= idx_US</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    nm_idx_CS= np.intersect1d(idx_CS,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    nm_idxCSUSCR = np.intersect1d(idxCSUSCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;    nm_idxCSUSNOCR = np.intersect1d(idxCSUSNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    nm_idxCSCR = np.intersect1d(idxCSCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    nm_idxCSNOCR = np.intersect1d(idxCSNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    nm_idxNOCR = np.intersect1d(idxNOCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    nm_idxCR = np.intersect1d(idxCR,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    nm_idxCSCSUS = np.intersect1d(idxCSCSUS,trigs_mov[<span class="stringliteral">&#39;idxNO_MOV&#39;</span>])  </div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;    trial_names=[<span class="stringliteral">&#39;&#39;</span>]*wheel_traces.shape[0]</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;    <span class="keywordflow">for</span> CSUSNoCR <span class="keywordflow">in</span> nm_idxCSUSNOCR:</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        trial_names[CSUSNoCR]=<span class="stringliteral">&#39;CSUSNoCR&#39;</span>  </div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    <span class="keywordflow">for</span> CSUSwCR <span class="keywordflow">in</span> nm_idxCSUSCR:</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;        trial_names[CSUSwCR]=<span class="stringliteral">&#39;CSUSwCR&#39;</span>  </div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    <span class="keywordflow">for</span> US <span class="keywordflow">in</span> nm_idx_US:</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        trial_names[US]=<span class="stringliteral">&#39;US&#39;</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">for</span> CSwCR <span class="keywordflow">in</span> nm_idxCSCR:</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        trial_names[CSwCR]=<span class="stringliteral">&#39;CSwCR&#39;</span></div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    <span class="keywordflow">for</span> CSNoCR <span class="keywordflow">in</span> nm_idxCSNOCR:</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;        trial_names[CSNoCR]=<span class="stringliteral">&#39;CSNoCR&#39;</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    len_min=np.min([np.array(f).shape <span class="keywordflow">for</span> f <span class="keywordflow">in</span> fl]) <span class="comment"># minimal length of trial</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    selct = <span class="keyword">lambda</span> cs,us: np.int(cs) <span class="keywordflow">if</span> np.isnan(us) <span class="keywordflow">else</span> np.int(us)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    <span class="comment"># index of US</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    trigs_US=[<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d85a403a5511da7f6041ea7957638c5">selct</a>(cs,us) <span class="keywordflow">for</span> cs,us <span class="keywordflow">in</span> zip(tr_fl[:,0],tr_fl[:,1])]     </div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">#for binning</span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    samplbef=np.int(old_div(time_bef,f_rate_fluo))</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    samplaft=np.int(old_div(time_aft,f_rate_fluo)) </div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    <span class="comment"># create fluorescence matrix</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    f_flat=np.concatenate([f[:,tr - samplbef:samplaft+tr] <span class="keywordflow">for</span> tr,f <span class="keywordflow">in</span> zip(trigs_US,fl)],1)</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    f_mat=np.concatenate([f[:,tr -samplbef:samplaft+tr][np.newaxis,:] <span class="keywordflow">for</span> tr,f <span class="keywordflow">in</span> zip(trigs_US,fl)],0)</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    time_fl=np.arange(-samplbef,samplaft)*f_rate_fluo </div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="comment"># remove baseline</span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;    f_mat_bl=f_mat-np.median(f_mat[:,:,np.logical_and(time_fl&gt;-1,time_fl&lt;-ISI)],axis=(2))[:,:,np.newaxis]   </div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;    amplitudes_responses=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(f_mat_bl[:,:,np.logical_and(time_fl&gt;-.03,time_fl&lt;.04)],-1)</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">#    if  session==&#39;20160628162522&#39;:</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment">#        raise Exception(&#39;right trial&#39;)    </span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">#    else:</span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">#        continue</span></div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    cell_responsiveness=np.median(amplitudes_responses[nm_idxCSCSUS],axis=0)</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    idx_responsive = np.where(cell_responsiveness&gt;threshold_responsiveness)[0]</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    fraction_responsive=len(np.where(cell_responsiveness&gt;threshold_responsiveness)[0])*1./np.shape(f_mat_bl)[1]</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="comment">#    a=pd.DataFrame(data=f_mat[0,idx_components[:10],:],columns=np.arange(-30,30)*.033,index=idx_components[:10])</span></div><div class="line"><a name="l00761"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a658b75bdce1ceb4fa556137ef3f90b2d">  761</a></span>&#160;    ampl_CR=pd.DataFrame()</div><div class="line"><a name="l00762"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a84069bad095e6c4120e798ff44f9900b">  762</a></span>&#160;    bh_correl_tmp=pd.DataFrame()</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="comment"># only take the preselected components</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment">#    idx_components_final=pos_examples</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    idx_components_final=np.intersect1d(pos_examples,np.where((np.max(f_flat,1)-np.min(f_flat,1))&lt;max_fluo_range)[0])</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;    idx_responsive = np.intersect1d(idx_responsive,idx_components_final)</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;neuron_id&#39;</span>]=cell_counter+np.arange(len(idx_components_final))</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    cell_counter=cell_counter+len(idx_components_final)</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    print(cell_counter)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    f_mat_bl_part=f_mat[:,idx_components_final,:].copy()</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="comment"># compute periods of activity for each neuron</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;    f_mat_bl_erfc=f_mat_bl_part.transpose([1,0,2]).reshape((-1,np.shape(f_mat_bl_part)[0]*np.shape(f_mat_bl_part)[-1]))            </div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;    f_mat_bl_erfc[np.isnan(f_mat_bl_erfc)]=0            </div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    fitness, f_mat_bl_erfc,_ = <a class="code" href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">compute_event_exceptionality</a>(f_mat_bl_erfc)</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    f_mat_bl_erfc=f_mat_bl_erfc.reshape([-1, np.shape(f_mat_bl_part)[0], np.shape(f_mat_bl_part)[-1]]).transpose([1,0,2])        </div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordflow">if</span> check_timing: <span class="comment">#compute timing lag granule eyelid</span></div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        bin_edge=np.arange(-3,4.5,.034)</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        bins=pd.cut(time_fl,bins=bin_edge)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        bins_tm=pd.cut(tm,bins=bin_edge)</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;        time_bef_edge=0</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        time_aft_edge=0    </div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        bin_edge=np.arange(-3,4.5,.1)</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        bins=pd.cut(time_fl,bins=bin_edge)</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;        bins_tm=pd.cut(tm,bins=bin_edge)</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        time_bef_edge=-0.25</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;        time_aft_edge=1.5    </div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    min_r=-1.1 <span class="comment"># 0</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;    min_confidence=100<span class="comment">#.01</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    idx_good_samples=np.where(np.logical_or(time_fl&lt;=time_bef_edge,time_fl&gt;=time_aft_edge))[0]</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    idx_good_samples_tm=np.where(np.logical_or(tm&lt;=time_bef_edge,tm&gt;=time_aft_edge))[0]</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    time_ds_idx=np.where(np.logical_or(bin_edge&lt;=time_bef_edge,bin_edge&gt;=time_aft_edge))[0][1:]-1</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;    dfs=[pd.DataFrame(f_mat_bl_part[:,ii,:].T,index=time_fl) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_part)[1])]</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;    binned_fluo=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    binned_fluo[np.isnan(binned_fluo)]=0</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    dfs=[pd.DataFrame(wheel_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(wheel_traces)[0])]</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    binned_wheel=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    binned_wheel[np.isnan(binned_wheel)]=0        </div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;    dfs=[pd.DataFrame(eye_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(eye_traces)[0])]</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    binned_eye=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;    binned_eye[np.isnan(binned_eye)]=0</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    dfs=[pd.DataFrame(nose_traces[ii],index=tm) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(nose_traces)[0])]</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    binned_nose=np.array([df.groupby(bins_tm).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    binned_nose[np.isnan(binned_nose)]=0</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    dfs=[pd.DataFrame(f_mat_bl_erfc[:,ii,:].T,index=time_fl) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_erfc)[1])]            </div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    binned_fluo_erfc=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;    binned_fluo_erfc[np.isnan(binned_fluo_erfc)]=0</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;active_during_nose&#39;</span>]=np.sum((binned_nose&gt;thresh_nose)*(binned_fluo_erfc[:,:,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_nose&gt;thresh_nose);</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;active_during_wheel&#39;</span>]=np.sum((binned_wheel&gt;thresh_wheel)*(binned_fluo_erfc[:,:,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_wheel&gt;thresh_wheel);</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;active_during_eye&#39;</span>]=np.sum((binned_eye&gt;thresh_eye)*(binned_fluo_erfc[:,:,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_eye&gt;thresh_eye)                </div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;avg_activity_during_locomotion&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(binned_fluo[:,binned_nose&gt;thresh_nose],1)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;</div><div class="line"><a name="l00841"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6d6c4599fd69da2ae5626e31abcab16b">  841</a></span>&#160;    r_nose_fluo=[scipy.stats.pearsonr(binned_nose.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    r_nose_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_nose_fluo])</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;    </div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a224e32fa8af07c43a1415077d7443c6d">  845</a></span>&#160;    r_wheel_fluo=[scipy.stats.pearsonr(binned_wheel.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    r_wheel_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_wheel_fluo])</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;</div><div class="line"><a name="l00848"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a12eeb92e3868baffeb87ce1f1a08f57a">  848</a></span>&#160;    r_eye_fluo=[scipy.stats.pearsonr(binned_eye.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    r_eye_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_eye_fluo])</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo&#39;</span>]=r_nose_fluo</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>]=r_wheel_fluo</div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_eye_fluo&#39;</span>]=r_eye_fluo</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    </div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment">#    if not check_timing:</span></div><div class="line"><a name="l00857"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa386bf2193443a327e7640da9cb435e1">  857</a></span>&#160;    mat_rnd=mat_all_nose[np.random.permutation(np.shape(mat_all_nose)[0])[:np.shape(binned_nose)[1]]]</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="comment">#        r_nose_fluo_rnd=[scipy.stats.pearsonr(binned_nose[np.random.permutation(np.shape(binned_nose)[0])].flatten(),bf.flatten()) for bf in binned_fluo]</span></div><div class="line"><a name="l00859"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5b52c880f7535c7e8ee71f77d6abd8a5">  859</a></span>&#160;    r_nose_fluo_rnd=[scipy.stats.pearsonr(mat_rnd.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    r_nose_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_nose_fluo_rnd])</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    mat_rnd=mat_all_wheel[np.random.permutation(np.shape(mat_all_wheel)[0])[:np.shape(binned_wheel)[1]]]</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;<span class="comment">#        r_nose_fluo_rnd=[scipy.stats.pearsonr(binned_nose[np.random.permutation(np.shape(binned_nose)[0])].flatten(),bf.flatten()) for bf in binned_fluo]</span></div><div class="line"><a name="l00865"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3092e46ba466f848fb6fa397d72d78a2">  865</a></span>&#160;    r_wheel_fluo_rnd=[scipy.stats.pearsonr(mat_rnd.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]    </div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    r_wheel_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_wheel_fluo_rnd])</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    mat_rnd=mat_all_eye[np.random.permutation(np.shape(mat_all_eye)[0])[:np.shape(binned_eye)[1]]]</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;<span class="comment">#        r_nose_fluo_rnd=[scipy.stats.pearsonr(binned_nose[np.random.permutation(np.shape(binned_nose)[0])].flatten(),bf.flatten()) for bf in binned_fluo]</span></div><div class="line"><a name="l00871"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad929e8b604befc872c15481885915928">  871</a></span>&#160;    r_eye_fluo_rnd=[scipy.stats.pearsonr(mat_rnd.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]  </div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    r_eye_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_eye_fluo_rnd])</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo_rnd&#39;</span>]=r_wheel_fluo_rnd</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo_rnd&#39;</span>]=r_nose_fluo_rnd</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_eye_fluo_rnd&#39;</span>]=r_eye_fluo_rnd</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    </div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9058d630dbb3fa7822a337f6c46ecf7f">  880</a></span>&#160;    fluo_crpl=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxCR,:][:,idx_responsive],0)    </div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;</div><div class="line"><a name="l00882"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa07d6145d46691fecabfb760926662a7">  882</a></span>&#160;    fluo_crmn=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxNOCR,:][:,idx_responsive],0)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    amplitudes_responses_US_fl=f_mat_bl[idx_US,:,:,][:,idx_components_final,:,][:,:,np.logical_and(time_fl&gt;0.03,time_fl&lt;.75)]</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    ampl_UR_eye=scipy.signal.resample(eye_traces[idx_US,:][:,np.logical_and(tm&gt;.03,tm&lt;.75)],np.shape(amplitudes_responses_US_fl)[-1],axis=1)</div><div class="line"><a name="l00886"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3a640da93178dd4e88ce2f7a481a64a7">  886</a></span>&#160;    r_UR_fluo=[scipy.stats.pearsonr(bf.flatten(),ampl_UR_eye.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_US_fl.transpose([1,0,2])]</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;    r_UR_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_UR_fluo])</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;    mat_rnd=mat_all_UR[np.random.permutation(np.shape(mat_all_UR)[0])[:np.shape(amplitudes_responses_US_fl)[0]]]</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;</div><div class="line"><a name="l00891"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af43c234459bdf387cf39a96922172b91">  891</a></span>&#160;    r_UR_fluo_rnd=[scipy.stats.pearsonr(bf.flatten(),mat_rnd.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_US_fl.transpose([1,0,2])]</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;<span class="comment">#        r_UR_fluo_rnd=[scipy.stats.pearsonr(bf.flatten(),ampl_UR_eye.flatten()[np.random.permutation(np.shape(ampl_UR_eye.flatten())[0])]) for bf in amplitudes_responses_US_fl.transpose([1,0,2])]</span></div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    r_UR_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_UR_fluo_rnd])</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_UR_eye_fluo&#39;</span>]=r_UR_fluo</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_UR_eye_fluo_rnd&#39;</span>]=r_UR_fluo_rnd</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;<span class="comment">#        if np.any([r&lt;-.6 and r is not None for r in r_wheel_fluo]):</span></div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;<span class="comment">#            raise Exception </span></div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;    amplitudes_responses_CR_fl=f_mat_bl[idxCSCSUS,:,:,][:,idx_components_final,:,][:,:,np.logical_and(time_fl&gt;-0.5,time_fl&lt;0.03)]</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    ampl_CR_eye=scipy.signal.resample(eye_traces[idxCSCSUS,:][:,np.logical_and(tm&gt;-.5,tm&lt;.03)],np.shape(amplitudes_responses_CR_fl)[-1],axis=1)</div><div class="line"><a name="l00905"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6603580ffca546cdf5f8c01737b43768">  905</a></span>&#160;    CR_eye_fluo=[scipy.stats.pearsonr(bf.flatten(),ampl_CR_eye.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_CR_fl.transpose([1,0,2])]</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    CR_eye_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> CR_eye_fluo])</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    mat_rnd=mat_all_CR[np.random.permutation(np.shape(mat_all_CR)[0])[:np.shape(amplitudes_responses_CR_fl)[0]]]        </div><div class="line"><a name="l00908"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6a0e49aede434e38f084da1bacdd68a9">  908</a></span>&#160;    CR_eye_fluo_rnd=np.array([scipy.stats.pearsonr(bf.flatten(),mat_rnd.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_CR_fl.transpose([1,0,2])])</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="comment">#        CR_eye_fluo_rnd=[scipy.stats.pearsonr(bf.flatten(),ampl_CR_eye.flatten()[np.random.permutation(np.shape(ampl_CR_eye.flatten())[0])]) for bf in amplitudes_responses_CR_fl.transpose([1,0,2])]</span></div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    CR_eye_fluo_rnd=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> CR_eye_fluo_rnd]</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="keywordflow">if</span> check_timing: <span class="comment"># plot nice delay binned</span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="comment">#            pl.plot(bin_edge[idx_good_samples[1:-1]],binned_fluo[100].mean(0)-.2)</span></div><div class="line"><a name="l00914"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a18a8b01d1d8259073eda1ce96e7fdd22">  914</a></span>&#160;        min_r_CR = .3</div><div class="line"><a name="l00915"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af256dc24b6c473550f22e8d583a9e879">  915</a></span>&#160;        time_binned_data=bin_edge[idx_good_samples[1:-1]]</div><div class="line"><a name="l00916"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a652b08b7100b3950d33c05c1df601c2e">  916</a></span>&#160;        binned_fluo_norm=old_div((binned_fluo-np.percentile(binned_fluo[...,5:50],50,(1,2))[:,np.newaxis,np.newaxis]),np.std(binned_fluo[...,5:50],(1,2))[:,np.newaxis,np.newaxis])</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        binned_fluo_norm=np.mean(binned_fluo_norm[:,idxCR,:],1)</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        binned_fluo_norm=old_div((binned_fluo_norm-np.percentile(binned_fluo_norm[...,5:50],50,(-1))[:,np.newaxis]),np.std(binned_fluo_norm[...,5:50],(-1))[:,np.newaxis])</div><div class="line"><a name="l00919"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6deaa7ea3392b2a225df7d364fd4a6cb">  919</a></span>&#160;        binned_eye_norm=old_div((binned_eye-np.percentile(binned_eye[...,5:50],50,(-1))[:,np.newaxis]),np.std(binned_eye[...,5:50],(-1))[:,np.newaxis])</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        binned_eye_norm=binned_eye_norm[idxCR].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(0)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        binned_eye_norm = binned_eye_norm - np.percentile(binned_eye_norm[np.logical_and(time_binned_data[:]&gt;-1,time_binned_data[:]&lt;-.25)],50)</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;                </div><div class="line"><a name="l00924"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae0319bfbe1a8d7cd64d6e336e65789d1">  924</a></span>&#160;        binned_nose_norm=old_div((binned_nose-np.percentile(binned_nose[...,5:50],50,(-1))[:,np.newaxis]),np.std(binned_nose[...,5:50],(-1))[:,np.newaxis])</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        binned_nose_norm=binned_nose_norm[idxCR].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(0)</div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;        binned_nose_norm = binned_nose_norm - np.percentile(binned_nose_norm[np.logical_and(time_binned_data[:]&gt;-1,time_binned_data[:]&lt;-.25)],50)</div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;</div><div class="line"><a name="l00928"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2e3555ca485229e3afc38dc8a8227b57">  928</a></span>&#160;        idx_during_cs= np.where((time_binned_data&gt;-0.22) &amp; (time_binned_data&lt;0.03))[0]</div><div class="line"><a name="l00929"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a34e431926863fbb1b247f30fbd53ec95">  929</a></span>&#160;        idx_max_eye=np.where(binned_eye_norm[idx_during_cs]&gt;3)[0][0]</div><div class="line"><a name="l00930"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aaeb986dff1812536a2058f52b4a4a69c">  930</a></span>&#160;        idx_max_nose=np.where(binned_nose_norm[idx_during_cs]&gt;2)[0][0]</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;        pl.subplot(1,2,1)</div><div class="line"><a name="l00933"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8fa675eb2fcec5b95d9d21c670da7f30">  933</a></span>&#160;        ax=pl.gca()</div><div class="line"><a name="l00934"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5e6449cb2b41f8979e300d8b9be95809">  934</a></span>&#160;        l1 = pl.plot(time_binned_data[:],binned_fluo_norm[CR_eye_fluo&gt;min_r_CR][:,:].T,color=<span class="stringliteral">&#39;lightgray&#39;</span>)</div><div class="line"><a name="l00935"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acdb4eb6c176ec707dba81563fa194a8c">  935</a></span>&#160;        l2 = pl.plot(time_binned_data[:],binned_eye_norm[:],<span class="stringliteral">&#39;k&#39;</span>,linewidth=2,label=<span class="stringliteral">&#39;Inline label&#39;</span>)</div><div class="line"><a name="l00936"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a04b2665990c1a7394914f938a7cac991">  936</a></span>&#160;        l3 = pl.plot(time_binned_data[:],binned_nose_norm[:],<span class="stringliteral">&#39;r&#39;,linewidth=2,label=&#39;</span>Inline label&#39;)</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        l1[0].set_label(<span class="stringliteral">&#39;Granule cells with r_CR&gt;0.3&#39;</span>)</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;        l2[0].set_label(<span class="stringliteral">&#39;Eyelid&#39;</span>)</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;        l3[0].set_label(<span class="stringliteral">&#39;Nose&#39;</span>)</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        pl.legend()</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        pl.xlabel(<span class="stringliteral">&#39;Time to US (s)&#39;</span>)</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        pl.ylabel(<span class="stringliteral">&#39;z-score&#39;</span>)</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        pl.xlim([-.4,0.03])</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        pl.ylim([-3,30])</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        <span class="comment"># find fr each trial and neuron the first index larger than 1 std</span></div><div class="line"><a name="l00946"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6ae6cc6fda356009af303f4b1c6e285d">  946</a></span>&#160;        bins_sign_fluo=np.array([np.where(binned_fluo_norm[iid_neuro][idx_during_cs]&gt;3)[0][0] <span class="keywordflow">if</span> np.max(binned_fluo_norm[iid_neuro][idx_during_cs])&gt;3 <span class="keywordflow">else</span> np.nan <span class="keywordflow">for</span> iid_neuro <span class="keywordflow">in</span> range(np.shape(binned_fluo_norm)[0]) ])</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;<span class="comment">#            bins_sign_fluo=[bisect.bisect(binned_fluo_norm[iid_neuro][idx_during_cs],3) for iid_neuro in range(np.shape(binned_fluo_norm)[0])]</span></div><div class="line"><a name="l00949"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae0e27d403a3b24ed50adef27d85d1217">  949</a></span>&#160;        bins_hist = time_binned_data[np.logical_and(time_binned_data[:]&gt;-.25,time_binned_data[:]&lt;.25)]</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        pl.subplot(1,2,2)</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;        pl.hist(0.034*(idx_max_eye-np.array(bins_sign_fluo)[np.logical_and(CR_eye_fluo&gt;min_r_CR,~np.isnan(bins_sign_fluo))]),bins=bins_hist)</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        pl.hist(0.034*(idx_max_nose-np.array(bins_sign_fluo)[np.logical_and(CR_eye_fluo&gt;min_r_CR,~np.isnan(bins_sign_fluo))]),bins=bins_hist)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;</div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;        pl.xlabel(<span class="stringliteral">&#39;time lag  (s)&#39;</span>)</div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        pl.ylabel(<span class="stringliteral">&#39;Cell count N=&#39;</span> +str(np.sum([CR_eye_fluo&gt;min_r_CR])))</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        pl.xlim([-.1,.25])</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        pl.legend([<span class="stringliteral">&#39;granule - eyelid (&gt;3 std)&#39;</span>,<span class="stringliteral">&#39;granule - snout (&gt;2 std)&#39;</span>])</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;        </div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;        <span class="comment">#pl.ylim([3,8])</span></div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        </div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;        print(<span class="stringliteral">&quot;skipping lags&quot;</span>)</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keywordflow">if</span> compute_redundancy:</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;</div><div class="line"><a name="l00968"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aadbb65e212decd5369cd61861bd67e47">  968</a></span>&#160;        _trials_,_n_nr,_timesteps_ = amplitudes_responses_CR_fl.shape</div><div class="line"><a name="l00969"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac51b57a703ba1c5869228690c93e1701">  969</a></span>&#160;        X = np.reshape(amplitudes_responses_CR_fl.transpose([1,0,2]),[_n_nr,_trials_ * _timesteps_]).T</div><div class="line"><a name="l00970"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0867f43e27585e019c13f7f4b7c4ab6b">  970</a></span>&#160;        Y = ampl_CR_eye.flatten()</div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        CR_eye_fluo=np.array(CR_eye_fluo,dtype=np.float)</div><div class="line"><a name="l00972"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3f5ad055ef7fc7dcbb5980ec8ec6c4a2">  972</a></span>&#160;        idx_significant=np.where(CR_eye_fluo&gt;np.percentile(CR_eye_fluo_rnd,95))[0]</div><div class="line"><a name="l00973"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aac1113e50f7f1460beeaeeba69f63701">  973</a></span>&#160;        ls=sklearn.linear_model.LassoCV(n_alphas=100,eps=1e-3)</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;<span class="comment">#            np.nanmean(cross_val_score(ls, X, Y, cv=ShuffleSplit(10,test_size=.5),scoring=score_))</span></div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;<span class="comment">#            scores = cross_val_score(lr, X, Y, cv=ShuffleSplit(30,test_size=.5),scoring=score_)</span></div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;</div><div class="line"><a name="l00978"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3c4968541657724b5e9a326460a45cd6">  978</a></span>&#160;        r_neurons=np.array(CR_eye_fluo[idx_significant],dtype=np.float)<span class="comment">#[idxHighCorr][::-1]</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        X = X[:,idx_significant]</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        ls.fit(X,Y)</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;</div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;        print((np.sum(ls.coef_&gt;0)))</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        print((len(idx_significant)))</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;        print((np.mean(CR_eye_fluo[idx_significant])))            </div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;        print((np.std(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        print((np.max(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        print((np.median(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        print(<span class="stringliteral">&#39;*&#39;</span>)            </div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        print((np.mean(CR_eye_fluo)))              </div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;        print((np.std(CR_eye_fluo)))</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        print((np.max(CR_eye_fluo)))</div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        print((np.median(CR_eye_fluo)))</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;</div><div class="line"><a name="l00996"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a01919eb56e17cb47c9edcca02b6fc41e">  996</a></span>&#160;        r_classif_naive=cross_val_score(lr, X, Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l00997"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2da412164315edab09e28d1d8384a41c">  997</a></span>&#160;        r_classif=np.mean(r_classif_naive)   </div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;        print((np.mean(r_classif))) </div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;</div><div class="line"><a name="l01001"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aee53ad29845bff45ba00b2ae3fecdd4a"> 1001</a></span>&#160;        r_classif_lasso=cross_val_score(lr, X[:,ls.coef_&gt;0], Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;        r_classif=np.mean(r_classif_lasso)</div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;        r_neurons=r_neurons[ls.coef_&gt;0]</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="comment">#            r_classif=[np.mean(cross_val_score(lr, X[:,:iidd+1], Y, cv=ShuffleSplit(30,test_size=.5),scoring=score_)) for iidd in range(_n_nr)][::-1] </span></div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        print((np.mean(r_classif)))</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        <span class="comment">#r_classif=np.array(r_classif).T</span></div><div class="line"><a name="l01010"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7e82ed320d4bc12463cb15c4fd319e6b"> 1010</a></span>&#160;        idx_good=np.where((r_neurons != np.array(<span class="keywordtype">None</span>)) &amp; (~np.isnan(r_neurons)))[0]</div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        <span class="comment">#r_classif=r_classif[idx_good]            </span></div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;        r_neurons=r_neurons[idx_good] </div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;</div><div class="line"><a name="l01014"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8cc2e7240164328fdc3f0e5e21032c56"> 1014</a></span>&#160;        N=len(r_neurons);</div><div class="line"><a name="l01015"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aec52934424bbf3a8fddbb37bf9bb4d18"> 1015</a></span>&#160;        I_neurons = -0.5*np.log(1-r_neurons**2)/np.log(2)</div><div class="line"><a name="l01016"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a99a5b22f69baba29202cdbd7e8f82e27"> 1016</a></span>&#160;        I_classif = -0.5*np.log(1-r_classif**2)/np.log(2)</div><div class="line"><a name="l01017"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4331d07ae6d8d3d5e8556e404833d4d4"> 1017</a></span>&#160;        Icum_neurons = np.sum(I_neurons)</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;<span class="comment">#            I_classif=I_classif[::-1]</span></div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        redundancy.append(old_div(np.max(Icum_neurons),np.max(I_classif)))</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        print((<span class="stringliteral">&#39;Redundancy:&#39;</span> + str(old_div(np.max(Icum_neurons),np.max(I_classif)))))</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        print((len(I_neurons)))</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        </div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        </div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        print(<span class="stringliteral">&#39;SKIPPED REDUNDANCY&#39;</span>)</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;</div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    <span class="keywordflow">if</span> 0: <span class="comment"># for plotting  example redundancy use Ag0515 </span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;</div><div class="line"><a name="l01029"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a45cec349ab109a70cf295d8a29626775"> 1029</a></span>&#160;        scores = cross_val_score(lr, X, Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l01030"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4ef5e651f9a511a47e9338ca6b6fc545"> 1030</a></span>&#160;        vls,bns,_=pl.hist(CR_eye_fluo,bins=np.arange(-.1,1,.05))</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;        pl.cla()</div><div class="line"><a name="l01032"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab6bd0613528e80b57cd74cfa155c538a"> 1032</a></span>&#160;        vl_distr=scipy.signal.savgol_filter(vls,1,0)</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        vl_distr=old_div(vl_distr,np.sum(vl_distr))</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;        pl.plot(bns[1:],vl_distr,<span class="stringliteral">&#39;r&#39;)</span></div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="stringliteral">        lq,hq = np.percentile(CR_eye_fluo_rnd,[5,95])</span></div><div class="line"><a name="l01036"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a37dbdc30935031c05304482e1be89d8f"> 1036</a></span>&#160;<span class="stringliteral">        pl.fill_between([lq,hq],[.35,.35],alpha=.3,color=&#39;c&#39;</span>)</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;        lq,hq = np.percentile(scores,[5,95])</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;        pl.fill_between([lq,hq],[.35,.35],alpha=.3,color=[.8, .8, .8])</div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;        pl.plot([np.mean(scores),np.mean(scores)],[0,.35],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        pl.xlabel(<span class="stringliteral">&#39;Person\&#39;s r&#39;</span>)</div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        pl.ylabel(<span class="stringliteral">&#39;Probability&#39;</span>)</div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;</div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;        pl.figure()   </div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;        pl.plot(Icum_neurons,<span class="stringliteral">&#39;-r&#39;</span>)</div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        pl.plot(I_classif,<span class="stringliteral">&#39;-k&#39;</span>)</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;        pl.xlabel(<span class="stringliteral">&#39;Number of neurons&#39;</span>)</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;        pl.legend([<span class="stringliteral">&#39;sum of individual GrCs&#39;</span>,<span class="stringliteral">&#39;classifier&#39;</span>])</div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;        pl.ylabel(<span class="stringliteral">&#39;Cumulative information (bits)&#39;</span>)</div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;        pl.xlim([-1, N-1])</div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;        pl.ylim([0, 1.5])</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;        pl.title(<span class="stringliteral">&#39;Redundancy calculation&#39;</span>)</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]=CR_eye_fluo</div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;r_CR_eye_fluo_rnd&#39;</span>]=CR_eye_fluo_rnd</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> len(idxUS)&gt;4:</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idxUS,:,:][:,:,np.logical_and(time_fl&gt;.15,time_fl&lt;.3)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;        print(<span class="stringliteral">&#39;** NOT ENOUGH TRIALS **&#39;</span>)</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR&#39;</span>]=np.nan</div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;</div><div class="line"><a name="l01067"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a613ea5d82461c5639c21af699daf0d1c"> 1067</a></span>&#160;    all_idx_neg=np.union1d(idxUS,idxNOCR)         </div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    <span class="keywordflow">if</span> len(all_idx_neg)&gt;min_trials:</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR_NOCR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[all_idx_neg,:,:][:,:,np.logical_and(time_fl&gt;.15,time_fl&lt;.3)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;        print(<span class="stringliteral">&#39;** NOT ENOUGH TRIALS **&#39;</span>)</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR_NOCR&#39;</span>]=np.nan    </div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;active_during_CS&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idxNOCR,:,:][:,:,np.logical_and(time_fl&gt;-.05,time_fl&lt;-.03)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;</div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    <span class="keywordflow">if</span> len(idxCR)&gt;min_trials:</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_CR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idxCR,:,:][:,:,np.logical_and(time_fl&gt;-.05,time_fl&lt;-.03)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_CR&#39;</span>]=np.nan</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="keywordflow">if</span> learning_phase&gt;1 <span class="keywordflow">and</span> binned_nose.shape[0]&gt;30 <span class="keywordflow">and</span> <span class="keyword">False</span>:</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;<span class="comment">#        session_nice_trials.append(nm)</span></div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;</div><div class="line"><a name="l01084"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af8dd95942a665dc2de84d6fb11fe52e5"> 1084</a></span>&#160;        ax1 = pl.subplot(2,1,1)</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        pl.cla()</div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;        ax1.plot(scipy.signal.savgol_filter(binned_nose.flatten()*5,3,1)-.25)</div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;        ax1.plot(scipy.signal.savgol_filter(old_div(binned_wheel.flatten(),10)+2,5,1))</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        ax1.plot(scipy.signal.savgol_filter(binned_eye.flatten()+4,5,1))</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;        pl.legend([<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;wheel&#39;</span>,<span class="stringliteral">&#39;eye&#39;</span>])</div><div class="line"><a name="l01091"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3adf294ce5390ecfe6de8b4c606c2367"> 1091</a></span>&#160;        ax2 = pl.subplot(2,1,2,sharex=ax1)</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        pl.cla()</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        ax2.plot(scipy.signal.savgol_filter(binned_fluo[np.argsort(r_nose_fluo)[-6:-1:2]].reshape((3,-1)).T,7,1,axis=0))</div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;        ax2.plot(scipy.signal.savgol_filter(binned_fluo[np.argsort(r_wheel_fluo)[-6:-1:2]].reshape((3,-1)).T+2,7,1,axis=0))</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        ax2.plot(scipy.signal.savgol_filter(binned_fluo[np.argsort(r_eye_fluo)[-6:-1:2]].reshape((3,-1)).T+4,7,1,axis=0))</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        ax2.plot(scipy.signal.savgol_filter(binned_fluo[np.argsort(CR_eye_fluo)[-6:-1:2]].reshape((3,-1)).T+6,7,1,axis=0))</div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;        ax2.plot(scipy.signal.savgol_filter(binned_fluo[np.argsort(r_UR_fluo)[-6:-1:2]].reshape((3,-1)).T+8,7,1,axis=0))</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        pl.pause(10)</div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;</div><div class="line"><a name="l01104"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a658d9612eeea0548b23681013682ec7a"> 1104</a></span>&#160;    fluo_crpl_all=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxCR,:][:,idx_components_final],0)    </div><div class="line"><a name="l01105"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6d2cc6989cb6ea6e9b524b87c792d235"> 1105</a></span>&#160;    fluo_crmn_all=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxNOCR,:][:,idx_components_final],0)</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    fluo_crpl=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxCR,:][:,idx_responsive],0)    </div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    fluo_crmn=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_responses[idxNOCR,:][:,idx_responsive],0)</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;<span class="comment">#    ampl_no_CR=pd.DataFrame(np.median(amplitudes_responses[idxNOCR,:][:,idx_components_final],0))</span></div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    <span class="keywordflow">if</span> len(nm_idxCR)&gt;min_trials:</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;        ampl_CR[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=fluo_crpl</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;        ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_at_US[nm_idxCR])</div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=fluo_crpl_all</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_at_US[nm_idxCR])</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    <span class="keywordflow">else</span>:        </div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;        ampl_CR[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=np.nan</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=np.nan</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=np.nan</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=np.nan</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <span class="keywordflow">if</span> len(nm_idxNOCR)&gt;min_trials:       </div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;        ampl_CR[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=fluo_crmn</div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=fluo_crmn_all</div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;        ampl_CR[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=np.nan</div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=np.nan</div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;</div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    ampl_CR[<span class="stringliteral">&#39;session&#39;</span>]=session;</div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    ampl_CR[<span class="stringliteral">&#39;mouse&#39;</span>]=mouse;</div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    ampl_CR[<span class="stringliteral">&#39;chunk&#39;</span>]=chunk    </div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;</div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;session&#39;</span>]=session;</div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>]=mouse;</div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;chunk&#39;</span>]=chunk    </div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;</div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;num_trials&#39;</span>]=len(whe)</div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    ampl_CR[<span class="stringliteral">&#39;num_trials&#39;</span>]=len(whe)  </div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;</div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;</div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;</div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;ampl_FOV&#39;</span>]=512</div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;fluo_range&#39;</span>]=(np.max(f_flat,1)-np.min(f_flat,1))[idx_components_final]</div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;idx_components_final&#39;</span>]=idx_components_final</div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;perc_CR&#39;</span>]=len(nm_idxCR)*1./len(nm_idxCSCSUS)  </div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;fraction_movement&#39;</span>]=fraction_movement</div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;</div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    ampl_CR[<span class="stringliteral">&#39;ampl_FOV&#39;</span>]=500*500 </div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;    ampl_CR[<span class="stringliteral">&#39;perc_CR&#39;</span>]=len(nm_idxCR)*1./len(nm_idxCSCSUS)</div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;</div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    ampl_CR[<span class="stringliteral">&#39;fluo_range_responsive&#39;</span>]=(np.max(f_flat,1)-np.min(f_flat,1))[idx_responsive]  </div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment">#    ampl_CR[&#39;fluo_range_final&#39;]=(np.max(f_flat,1)-np.min(f_flat,1))[idx_components_final]    </span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    ampl_CR[<span class="stringliteral">&#39;idx_component&#39;</span>]=idx_responsive</div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment">#    ampl_CR[&#39;idx_components_final&#39;]=idx_components_final</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;</div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;</div><div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <span class="keywordflow">if</span>  len(nm_idxCR)*1./len(nm_idxCSCSUS)&gt; thresh_middle <span class="keywordflow">and</span> learning_phase==0:</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;        learning_phase=1</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        print(<span class="stringliteral">&#39;middle&#39;</span>)</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    <span class="keywordflow">elif</span> len(nm_idxCR)*1./len(nm_idxCSCSUS)&gt; thresh_advanced <span class="keywordflow">and</span> learning_phase==1:</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        learning_phase=2</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        print(<span class="stringliteral">&#39;advanced&#39;</span>)</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;    <span class="keywordflow">elif</span> len(nm_idxCR)*1./len(nm_idxCSCSUS)&gt; thresh_late <span class="keywordflow">and</span> learning_phase==2:</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        learning_phase=3</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        print(<span class="stringliteral">&#39;late&#39;</span>)</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    ampl_CR[<span class="stringliteral">&#39;learning_phase&#39;</span>]= learning_phase          </div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_at_US[nm_idxCSCSUS])</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    ampl_CR[<span class="stringliteral">&#39;session_id&#39;</span>]=session_id</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    cr_ampl=pd.concat([cr_ampl,ampl_CR])</div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;learning_phase&#39;</span>]= learning_phase          </div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(amplitudes_at_US[nm_idxCSCSUS])</div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;session_id&#39;</span>]=session_id</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    bh_correl=pd.concat([bh_correl,bh_correl_tmp])</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;</div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;</div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;</div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;</div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;<span class="keywordflow">if</span> <span class="keyword">False</span>:</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    thresh_middle=.05</div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    thresh_advanced=.35</div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    thresh_late=.9</div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    time_CR_on=-.1</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    time_US_on=.035</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;    thresh_mov=2</div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;    <span class="comment">#thresh_MOV_iqr=100</span></div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    time_CS_on_MOV=-.25</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;    time_US_on_MOV=0</div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;    thresh_CR = 0.1,</div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;    threshold_responsiveness=0.1</div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    time_bef=2.9</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;    time_aft=4.5</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;    f_rate_fluo=old_div(1,30.0)</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    ISI=.25</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    min_trials=8</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    mouse_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    session_id = 0</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;</div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    thresh_wheel = 5</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;    thresh_nose = 1 </div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    thresh_eye = .1 </div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;    thresh_fluo_log=-10</div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;</div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="comment">#single_session = True</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;</div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;    cr_ampl=pd.DataFrame()</div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    bh_correl=pd.DataFrame()    </div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;</div><div class="line"><a name="l01216"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acd4c2878a1dd920a71658e2e02bab299"> 1216</a></span>&#160;bh_correl_old=bh_correl.copy()</div><div class="line"><a name="l01217"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a73eb38d5fe23f60cac2012e58c10b14c"> 1217</a></span>&#160;cr_ampl_old=cr_ampl.copy()    </div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01219"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aeda4f3a5fbb2af7538f240c945b35862"> 1219</a></span>&#160;last_session=<span class="keyword">False</span></div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l01221"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4bc5a41f6d0c3366c271380e7e1ac595"> 1221</a></span>&#160;mat_summaries=[</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/imaging/eyeblink/MAT_SUMMARIES/gc-AGGC6f-031213-03/python_out.mat&#39;</span>,</div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/imaging/eyeblink/MAT_SUMMARIES/gc-AG052014-02/python_out.mat&#39;</span>,</div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/imaging/eyeblink/MAT_SUMMARIES/AG052014-01/python_out.mat&#39;</span>,</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/imaging/eyeblink/MAT_SUMMARIES/AG051514-01/python_out.mat&#39;</span>]</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;<span class="keywordflow">for</span> mat_summary <span class="keywordflow">in</span> mat_summaries[-1:]:</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    ld=scipy.io.loadmat(mat_summary)</div><div class="line"><a name="l01228"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4aaf7aac446172b874b78764b8ce0647"> 1228</a></span>&#160;    cr_ampl_dic=dict()</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;trials&#39;</span>]=np.array([a[0][0][0] <span class="keywordflow">for</span> a <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_trials&#39;</span>]])</div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_trialsTypeOrig&#39;</span>]]</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;trialName&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_trialName&#39;</span>]]    </div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;session&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_session&#39;</span>]]</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;animal&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_animal&#39;</span>]]</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;day&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_day&#39;</span>]]</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_realDay&#39;</span>]]</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;</div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;</div><div class="line"><a name="l01238"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa170e880ba09faea4beb3be20f2e934f"> 1238</a></span>&#160;    mat_time=np.array([css[0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_time&#39;</span>]])</div><div class="line"><a name="l01239"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a29cd49c86561a6a3f147d78e204e1dd8"> 1239</a></span>&#160;    mat_wheel=np.array([css <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_wheel&#39;</span>]])</div><div class="line"><a name="l01240"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9491517f9be395d6d56381dde35ce57b"> 1240</a></span>&#160;    mat_eyelid=np.array([css <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_eyelid&#39;</span>]])</div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;</div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&#39;python_trials_talmo&#39;</span> <span class="keywordflow">in</span> ld:</div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;</div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;trials_talmo&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_trials_talmo&#39;</span>]]</div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;nose_talmo&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_nose_talmo&#39;</span>]]</div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;timestamps_talmo&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_timestamps_talmo&#39;</span>]]</div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;exptNames_talmo&#39;</span>]=[css[0][0] <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_exptNames_talmo&#39;</span>]]</div><div class="line"><a name="l01248"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a94478f3255919030716ecf0b7562c928"> 1248</a></span>&#160;        mat_wheel_talmo=np.array([css <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_wheel_cms_talmo&#39;</span>]])</div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        mat_wheel_talmo=np.abs(mat_wheel_talmo)</div><div class="line"><a name="l01250"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aaca8ffa260631c1606c791986c4dcad0"> 1250</a></span>&#160;        mat_nose_talmo=np.array([css <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_nose_vel_talmo&#39;</span>]])    </div><div class="line"><a name="l01251"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a960d4021d91c455d3b66653c6715d072"> 1251</a></span>&#160;        wheel_ampl_while_CS=np.nanmax(mat_wheel_talmo[np.logical_and(mat_time &gt; -ISI,mat_time &lt; time_US_on) ,:],0)</div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;        mat_nose_talmo=mat_nose_talmo*.12/conversion_to_cm_sec</div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;        print((np.nanmean(mat_nose_talmo)))</div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;        print(<span class="stringliteral">&#39;********   Talmo Behavior Not found *******&#39;</span>)</div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;nose_talmo&#39;</span>]=<span class="keywordtype">None</span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;timestamps_talmo&#39;</span>]=<span class="keywordtype">None</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        cr_ampl_dic[<span class="stringliteral">&#39;exptNames_talmo&#39;</span>]=<span class="keywordtype">None</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        mat_wheel_talmo=<span class="keywordtype">None</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        mat_wheel_talmo=<span class="keywordtype">None</span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        mat_nose_talmo=<span class="keywordtype">None</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        wheel_ampl_while_CS=np.nanmax(mat_wheel[np.logical_and(mat_time &gt; -ISI,mat_time &lt; time_US_on) ,:],0)*0</div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;</div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;</div><div class="line"><a name="l01265"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae96732dad6a02bf904d7c41306f66d77"> 1265</a></span>&#160;    mat_ampl_at_US=np.nanmedian(mat_eyelid[np.logical_and(mat_time &gt; -.05,mat_time &lt; time_US_on) ,:],0)    </div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;</div><div class="line"><a name="l01267"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5f1200407bbe2a16871d142f81a142ec"> 1267</a></span>&#160;    mat_fluo=np.concatenate([np.atleast_3d(css) <span class="keywordflow">for</span> css <span class="keywordflow">in</span> ld[<span class="stringliteral">&#39;python_fluo_traces&#39;</span>]],-1)</div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;    <span class="keywordflow">if</span> ( mouse_now == <span class="stringliteral">&#39;AG052014-01&#39;</span>) <span class="keywordflow">or</span> ( mouse_now == <span class="stringliteral">&#39;gc-AG052014-02&#39;</span>):        </div><div class="line"><a name="l01269"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad31b447faaaec5db5fb9e99dc1f185ea"> 1269</a></span>&#160;        mat_idxCR_orig=np.where([np.logical_and(t <span class="keywordflow">in</span> [<span class="stringliteral">&#39;CSUS&#39;</span>,<span class="stringliteral">&#39;CS&#39;</span>],ampl&gt;=thresh_CR_whisk) <span class="keywordflow">for</span> t,ampl <span class="keywordflow">in</span> zip(cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>],mat_ampl_at_US)])[0]    </div><div class="line"><a name="l01270"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a50518c39c19898b797380f92efc4c8f2"> 1270</a></span>&#160;        mat_idxNOCR_orig=np.where([np.logical_and(t <span class="keywordflow">in</span> [<span class="stringliteral">&#39;CSUS&#39;</span>,<span class="stringliteral">&#39;CS&#39;</span>],ampl&lt;thresh_CR_whisk) <span class="keywordflow">for</span> t,ampl <span class="keywordflow">in</span> zip(cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>],mat_ampl_at_US)])[0]</div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;</div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;</div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        mat_idxCR_orig=np.where([np.logical_and(t <span class="keywordflow">in</span> [<span class="stringliteral">&#39;CSUS&#39;</span>,<span class="stringliteral">&#39;CS&#39;</span>],ampl&gt;=thresh_CR) <span class="keywordflow">for</span> t,ampl <span class="keywordflow">in</span> zip(cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>],mat_ampl_at_US)])[0]    </div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;        mat_idxNOCR_orig=np.where([np.logical_and(t <span class="keywordflow">in</span> [<span class="stringliteral">&#39;CSUS&#39;</span>,<span class="stringliteral">&#39;CS&#39;</span>],ampl&lt;thresh_CR) <span class="keywordflow">for</span> t,ampl <span class="keywordflow">in</span> zip(cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>],mat_ampl_at_US)])[0]</div><div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;</div><div class="line"><a name="l01277"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7f87d9e097d959b2370bf4ae6d4783e1"> 1277</a></span>&#160;    mat_idxCSCSUS_orig=np.union1d(mat_idxCR_orig,mat_idxNOCR_orig)</div><div class="line"><a name="l01278"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab5d45b5366d6744a25657fac926c7464"> 1278</a></span>&#160;    mat_idxUS_orig=np.where([t <span class="keywordflow">in</span> [<span class="stringliteral">&#39;US&#39;</span>] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> cr_ampl_dic[<span class="stringliteral">&#39;trialsTypeOrig&#39;</span>]])[0]</div><div class="line"><a name="l01279"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0db1eb4978c34f02aeb7eb88931360e0"> 1279</a></span>&#160;    idx_no_mov=np.where(wheel_ampl_while_CS&lt;=thresh_mov)[0]</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    print((<span class="stringliteral">&#39;******************************** Fraction with movement:&#39;</span> + str(1- len(idx_no_mov) * 1./   len(wheel_ampl_while_CS))))</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;    fraction_movement = str(1- len(idx_no_mov) * 1./   len(wheel_ampl_while_CS))</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div><div class="line"><a name="l01284"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5c91621d1e37dd8f4cfc0a55cbd67d2e"> 1284</a></span>&#160;    mat_idxCR= np.intersect1d(mat_idxCR_orig,idx_no_mov)</div><div class="line"><a name="l01285"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a47b92c0612bc4b081624f837c8594f4d"> 1285</a></span>&#160;    mat_idxNOCR= np.intersect1d(mat_idxNOCR_orig,idx_no_mov)</div><div class="line"><a name="l01286"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a07235ec391c9d54e7bbf61b5106ab32a"> 1286</a></span>&#160;    mat_idxUS = np.intersect1d(mat_idxUS_orig,idx_no_mov)</div><div class="line"><a name="l01287"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a119541a2aedba84b2913d08e0e623abe"> 1287</a></span>&#160;    mat_idxCSCSUS = np.intersect1d(mat_idxCSCSUS_orig,idx_no_mov)</div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;</div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;    mouse_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;    session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01291"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a643a20c0c59588a0f741a6095e2025fd"> 1291</a></span>&#160;    sess_,order_,_,_=np.unique(cr_ampl_dic[<span class="stringliteral">&#39;session&#39;</span>],return_index=<span class="keyword">True</span>, return_inverse=<span class="keyword">True</span>, return_counts=<span class="keyword">True</span>)</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;    sess_=sess_[np.argsort(order_)]</div><div class="line"><a name="l01293"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a3c2948fb89e86fa5ca6452bdb7765703"> 1293</a></span>&#160;    idx_neurons=np.arange(mat_fluo.shape[1])</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;    mouse=cr_ampl_dic[<span class="stringliteral">&#39;animal&#39;</span>][0]</div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;    <span class="comment">#cr_ampl=pd.DataFrame()</span></div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;    <span class="keywordflow">if</span> ~last_session:</div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div><div class="line"><a name="l01298"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab6113455663f1226d2b03baa264dd80f"> 1298</a></span>&#160;        idx_CR=mat_idxCR_orig</div><div class="line"><a name="l01299"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a332772dee44d9a24162c131abd60c10b"> 1299</a></span>&#160;        idx_NOCR=mat_idxNOCR_orig</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        idx_US=mat_idxUS_orig</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        idxCSCSUS=mat_idxCSCSUS_orig</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        idx_sess = list(range(mat_fluo.shape[0]))</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;    <span class="keywordflow">else</span>:       </div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;</div><div class="line"><a name="l01306"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8f60c8102d29fcd525162d02eed4566b"> 1306</a></span>&#160;        ss=cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>][-1]</div><div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;        idx_sess=np.where([item == ss <span class="keywordflow">for</span> item <span class="keywordflow">in</span> cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>]])[0]</div><div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;        print(ss)</div><div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;</div><div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;        session=cr_ampl_dic[<span class="stringliteral">&#39;day&#39;</span>][idx_sess[0]]    </div><div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;        day=cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>][idx_sess[0]]  </div><div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;</div><div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        session_id = len(np.unique(cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>]))</div><div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;</div><div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;</div><div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;        learning_phase=np.nan</div><div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;</div><div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;</div><div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        idx_CR=np.intersect1d(idx_sess,mat_idxCR_orig)</div><div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        idx_NOCR=np.intersect1d(idx_sess,mat_idxNOCR_orig)</div><div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;        idx_US=np.intersect1d(idx_sess,mat_idxUS_orig)</div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;        idxCSCSUS=np.intersect1d(idx_sess,mat_idxCSCSUS_orig)</div><div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    bh_correl_tmp=pd.DataFrame()</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;neuron_id&#39;</span>]=np.arange(len(idx_neurons))</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    <span class="keywordflow">if</span> 1:    </div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;        f_mat_bl_part=mat_fluo[idx_sess].copy()</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;        f_mat_bl_erfc=mat_fluo.transpose([1,0,2]).reshape((-1,np.shape(mat_fluo)[0]*np.shape(mat_fluo)[-1]))            </div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        f_mat_bl_erfc[np.isnan(f_mat_bl_erfc)]=0            </div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;        fitness, f_mat_bl_erfc,_ = <a class="code" href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">compute_event_exceptionality</a>(f_mat_bl_erfc)</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;        f_mat_bl_erfc=f_mat_bl_erfc.reshape(-1, np.shape(mat_fluo)[0], np.shape(mat_fluo)[-1]).transpose([1,0,2])</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        <span class="keywordflow">if</span> check_timing:</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;            bin_edge=np.arange(mat_time[0],mat_time[-1],.064)</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;            bins=pd.cut(mat_time,bins=bin_edge)</div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;            time_bef_edge=0</div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;            time_aft_edge=0    </div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;</div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;            bin_edge=np.arange(mat_time[0],mat_time[-1],.1)</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;            bins=pd.cut(mat_time,bins=bin_edge)</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;</div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;            time_bef_edge=-0.4</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;            time_aft_edge=1.7    </div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;</div><div class="line"><a name="l01361"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4fea17a70f6ecafd73be201d7bde7c2c"> 1361</a></span>&#160;        mat_eyelid_part = mat_eyelid[:,idx_sess]</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        <span class="comment"># choose samples</span></div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        idx_good_samples=np.where(np.logical_or(mat_time&lt;=time_bef_edge,mat_time&gt;=time_aft_edge))[0]</div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;</div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;        time_ds_idx=np.where(np.logical_or(bin_edge&lt;=time_bef_edge,bin_edge&gt;=time_aft_edge))[0][1:]-1</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;</div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;        dfs=[pd.DataFrame(f_mat_bl_part[:,ii,:].T,index=mat_time) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_part)[1])]</div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        binned_fluo=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;        binned_fluo[np.isnan(binned_fluo)]=0</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;        dfs=[pd.DataFrame(f_mat_bl_erfc[:,ii,:].T,index=mat_time) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(f_mat_bl_erfc)[1])]            </div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;        binned_fluo_erfc=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.T <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,:,time_ds_idx].squeeze()</div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        dfs=[pd.DataFrame(mat_eyelid_part.T[ii],index=mat_time) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(mat_eyelid_part.T)[0])]</div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;        binned_eye=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        binned_eye[np.isnan(binned_eye)]=0</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        r_eye_fluo=[scipy.stats.pearsonr(binned_eye.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        r_eye_fluo=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_eye_fluo]</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_eye_fluo&#39;</span>]=r_eye_fluo</div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;        r_eye_fluo_rnd=[scipy.stats.pearsonr(binned_eye[np.random.permutation(np.shape(binned_eye)[0])].flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;        r_eye_fluo_rnd=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_eye_fluo_rnd]</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_eye_fluo_rnd&#39;</span>]=r_eye_fluo_rnd            </div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;</div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;        <span class="keywordflow">if</span> mat_nose_talmo <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01388"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0f120211d8e5a56a6388822df7fb57eb"> 1388</a></span>&#160;            mat_nose_talmo_part = mat_nose_talmo[:,idx_sess]</div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;            dfs=[pd.DataFrame(mat_nose_talmo_part.T[ii],index=mat_time) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(mat_nose_talmo_part.T)[0])]</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;            binned_nose=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            binned_nose[np.isnan(binned_nose)]=0</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            r_nose_fluo=[scipy.stats.pearsonr(binned_nose.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            r_nose_fluo=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_nose_fluo]</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo&#39;</span>]=r_nose_fluo</div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;            r_nose_fluo_rnd=[scipy.stats.pearsonr(binned_nose[np.random.permutation(np.shape(binned_nose)[0])].flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;            r_nose_fluo_rnd=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_nose_fluo_rnd]</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo_rnd&#39;</span>]=r_nose_fluo_rnd</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_nose&#39;</span>]=np.sum((binned_nose&gt;thresh_nose)*(binned_fluo_erfc[:,idx_sess,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_nose&gt;thresh_nose)</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo&#39;</span>]=np.nan</div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_nose_fluo_rnd&#39;</span>]=np.nan                </div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_nose&#39;</span>]=np.nan</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;</div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;        <span class="keywordflow">if</span> mat_wheel_talmo <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l01410"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a975449823927253a64fe0ef7fe0f7ca0"> 1410</a></span>&#160;            mat_wheel_talmo_part=mat_wheel_talmo[:,idx_sess]</div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;            dfs=[pd.DataFrame(mat_wheel_talmo_part.T[ii],index=mat_time) <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> range(np.shape(mat_wheel_talmo_part.T)[0])]</div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;</div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;            binned_wheel=np.array([df.groupby(bins).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().values.squeeze() <span class="keywordflow">for</span> df <span class="keywordflow">in</span> dfs])[:,time_ds_idx]    </div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;            binned_wheel[np.isnan(binned_wheel)]=0</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;            r_wheel_fluo=[scipy.stats.pearsonr(binned_wheel.flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;            r_wheel_fluo=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_wheel_fluo]</div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>]=r_wheel_fluo</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;            r_wheel_fluo_rnd=[scipy.stats.pearsonr(binned_wheel[np.random.permutation(np.shape(binned_wheel)[0])].flatten(),bf.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> binned_fluo]</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;            r_wheel_fluo_rnd=[rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_wheel_fluo_rnd]</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo_rnd&#39;</span>]=r_wheel_fluo_rnd</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_wheel&#39;</span>]=np.sum((binned_wheel&gt;thresh_wheel)*(binned_fluo_erfc[:,idx_sess,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_wheel&gt;thresh_wheel)</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;avg_activity_during_locomotion&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(binned_fluo[:,binned_nose&gt;thresh_nose],1)</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;            <span class="keywordflow">if</span> np.any([r&lt;-.5 <span class="keywordflow">and</span> r <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> r <span class="keywordflow">in</span> r_wheel_fluo]):</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                <span class="keywordflow">raise</span> Exception </div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;</div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;</div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>]=np.nan</div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo_rnd&#39;</span>]=np.nan</div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_wheel&#39;</span>]=np.nan</div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;</div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_eye&#39;</span>]=np.sum((binned_eye&gt;thresh_eye)*(binned_fluo_erfc[:,idx_sess,:]&lt;thresh_fluo_log),(1,2))*1./np.sum(binned_eye&gt;thresh_eye)</div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;        amplitudes_responses_US_fl=mat_fluo[idxUS,:,:,][:,:,:,][:,:,np.logical_and(mat_time&gt;0.03,mat_time&lt;.75)]</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;        ampl_UR_eye=mat_eyelid.T[idxUS,:][:,np.logical_and(mat_time&gt;.03,mat_time&lt;.75)]</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;        r_UR_fluo=[scipy.stats.pearsonr(bf.flatten(),ampl_UR_eye.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_US_fl.transpose([1,0,2])]</div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;        r_UR_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_UR_fluo])</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        r_UR_fluo_rnd=[scipy.stats.pearsonr(bf.flatten(),ampl_UR_eye.flatten()[np.random.permutation(np.shape(ampl_UR_eye.flatten())[0])]) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_US_fl.transpose([1,0,2])]</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        r_UR_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> r_UR_fluo_rnd])</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_UR_eye_fluo&#39;</span>]=r_UR_fluo</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_UR_eye_fluo_rnd&#39;</span>]=r_UR_fluo_rnd</div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;</div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;</div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        amplitudes_responses_CR_fl=mat_fluo[idxCSCSUS,:,:,][:,:,:,][:,:,np.logical_and(mat_time&gt;-0.5,mat_time&lt;0.03)]</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;        ampl_CR_eye=mat_eyelid.T[idxCSCSUS,:][:,np.logical_and(mat_time&gt;-.5,mat_time&lt;.03)]</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        CR_eye_fluo=[scipy.stats.pearsonr(bf.flatten(),ampl_CR_eye.flatten()) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_CR_fl.transpose([1,0,2])]</div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;        CR_eye_fluo=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> CR_eye_fluo])</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;        CR_eye_fluo_rnd=[scipy.stats.pearsonr(bf.flatten(),ampl_CR_eye.flatten()[np.random.permutation(np.shape(ampl_CR_eye.flatten())[0])]) <span class="keywordflow">for</span> bf <span class="keywordflow">in</span> amplitudes_responses_CR_fl.transpose([1,0,2])]</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;        CR_eye_fluo_rnd=np.array([rnf[0] <span class="keywordflow">if</span> rnf[1]&lt;min_confidence <span class="keywordflow">and</span> rnf[0]&gt;min_r <span class="keywordflow">else</span> <span class="keywordtype">None</span> <span class="keywordflow">for</span> rnf <span class="keywordflow">in</span> CR_eye_fluo_rnd])</div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;        <span class="keywordflow">if</span> check_timing: <span class="comment"># plot nic edelay binned</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment">#            pl.plot(bin_edge[idx_good_samples[1:-1]],binned_fluo[100].mean(0)-.2)</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="comment">#            pl.plot(bin_edge[idx_good_samples[1:-1]],binned_eye.mean(0))</span></div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;            min_r_CR=0.3</div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;            time_binned_data=bin_edge[1:]<span class="comment">#[(bin_edge&gt;time_bef_edge) &amp; (bin_edge&lt;time_aft_edge)]</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;</div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;<span class="comment">#                time_bl_idx=np.where((time_binned_data&gt;-.2) &amp; (time_binned_data&lt;-.45)</span></div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;            binned_fluo_norm=old_div((binned_fluo-np.percentile(binned_fluo[...,1:20],50,(1,2))[:,np.newaxis,np.newaxis]),np.std(binned_fluo[...,1:20],(1,2))[:,np.newaxis,np.newaxis])</div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;            binned_fluo_norm=np.mean(binned_fluo_norm[:,idx_CR,:],1)</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;            binned_fluo_norm=old_div((binned_fluo_norm-np.percentile(binned_fluo_norm[...,1:20],50,(-1))[:,np.newaxis]),np.std(binned_fluo_norm[...,1:20],(-1))[:,np.newaxis])</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;            binned_eye_norm=old_div((binned_eye-np.percentile(binned_eye[...,1:20],50,(-1))[:,np.newaxis]),np.std(binned_eye[...,1:20],(-1))[:,np.newaxis])</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;            binned_eye_norm=binned_eye_norm[idx_CR].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(0)</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;            binned_nose_norm=old_div((binned_nose-np.percentile(binned_nose[...,1:20],50,(-1))[:,np.newaxis]),np.std(binned_nose[...,1:20],(-1))[:,np.newaxis])</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;            binned_nose_norm=binned_nose_norm[idx_CR].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(0)</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;            idx_during_cs= np.where((time_binned_data&gt;-ISI) &amp; (time_binned_data&lt;0.03))[0]</div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;            idx_max_eye=np.where(binned_eye_norm[idx_during_cs]&gt;3)[0][0]</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;            idx_max_nose=np.where(binned_nose_norm[idx_during_cs]&gt;3)[0][0]</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;            </div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;            pl.subplot(1,2,1)</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;            ax=pl.gca()</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;            l1 = pl.plot(time_binned_data[:],binned_fluo_norm[CR_eye_fluo&gt;min_r_CR,:].T,color=<span class="stringliteral">&#39;lightgray&#39;</span>)</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;            l2 = pl.plot(time_binned_data[:],binned_eye_norm[:],<span class="stringliteral">&#39;k&#39;</span>,linewidth=2,label=<span class="stringliteral">&#39;Inline label&#39;</span>)</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;            l3 = pl.plot(time_binned_data[:],binned_nose_norm[:],<span class="stringliteral">&#39;r&#39;,linewidth=2,label=&#39;</span>Inline label&#39;)</div><div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;            l1[0].set_label(<span class="stringliteral">&#39;Granule cells with r_CR&gt;0.3&#39;</span>)</div><div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;            l2[0].set_label(<span class="stringliteral">&#39;Eyelid&#39;</span>)</div><div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;            l2[0].set_label(<span class="stringliteral">&#39;Snout&#39;</span>)</div><div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;            pl.legend()</div><div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;            pl.xlabel(<span class="stringliteral">&#39;Time to US (s)&#39;</span>)</div><div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;            pl.ylabel(<span class="stringliteral">&#39;z-score&#39;</span>)</div><div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;            pl.xlim([-.5,0.03])</div><div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;            pl.ylim([-3,10])</div><div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;            <span class="comment"># find fr each trial and neuron the first index larger than 1 std</span></div><div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;            bins_sign_fluo=np.array([np.where(binned_fluo_norm[iid_neuro][idx_during_cs]&gt;3)[0][0] <span class="keywordflow">if</span> np.max(binned_fluo_norm[iid_neuro][idx_during_cs])&gt;3 <span class="keywordflow">else</span> np.nan <span class="keywordflow">for</span> iid_neuro <span class="keywordflow">in</span> range(np.shape(binned_fluo_norm)[0]) ])</div><div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;</div><div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;</div><div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;<span class="comment">#            bins_sign_fluo=[bisect.bisect(binned_fluo_norm[iid_neuro][idx_during_cs],3) for iid_neuro in range(np.shape(binned_fluo_norm)[0])]</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;</div><div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;            pl.subplot(1,2,2)</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;            pl.hist(0.064*(idx_max_eye-np.array(bins_sign_fluo)[CR_eye_fluo&gt;min_r_CR]),bins=10)</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;            pl.hist(0.064*(idx_max_nose-np.array(bins_sign_fluo)[CR_eye_fluo&gt;min_r_CR]),bins=10)</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;            pl.xlabel(<span class="stringliteral">&#39;time lag granule - eyelid (s)&#39;</span>)</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;            pl.ylabel(<span class="stringliteral">&#39;Cell count N=&#39;</span> +str(np.sum([CR_eye_fluo&gt;min_r_CR])))</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;            pl.xlim([-.1,.2])</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;            lsl</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;            <span class="comment">#pl.ylim([3,8])</span></div><div class="line"><a name="l01505"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0c25dbf29459e30a8d0fd400bff3511b"> 1505</a></span>&#160;            all_neurons_lag=np.concatenate([np.load(a) <span class="keywordflow">for</span> a <span class="keywordflow">in</span> [<span class="stringliteral">&#39;timing_lag_AG051501_sec.npy&#39;</span>,<span class="stringliteral">&#39;timing_lag_b35_sec.npy&#39;</span>,<span class="stringliteral">&#39;timing_lag_b37_sec.npy&#39;</span>,<span class="stringliteral">&#39;timing_lag_gc-AGGC6f-031213-03_sec.npy&#39;</span>]])</div><div class="line"><a name="l01506"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae5da1d870f42561a9453ed3ecb7f2bb5"> 1506</a></span>&#160;            all_nose_lag=np.concatenate([np.load(a)[<span class="stringliteral">&#39;arr_0&#39;</span>] <span class="keywordflow">for</span> a <span class="keywordflow">in</span> [<span class="stringliteral">&#39;lags_AG051515-01.npy.npz&#39;</span>,<span class="stringliteral">&#39;lags_b37.npy.npz&#39;</span>]])</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;            pl.hist(all_neurons_lag,bins=np.arange(-.3,.3,.032))</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;            pl.hist(all_nose_lag,bins=np.arange(-.3,.3,.032))</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;            pl.xlabel(<span class="stringliteral">&#39;time lag granule - eyelid (s)&#39;</span>)</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;            pl.ylabel(<span class="stringliteral">&#39;Cell count&#39;</span>)</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;            pl.legend([<span class="stringliteral">&#39;eyelid - GrC&#39;</span>,<span class="stringliteral">&#39;nose Grc&#39;</span>])</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="comment">#            idxHighCorr=np.argsort(CR_eye_fluo)[::-1]</span></div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;        <span class="comment"># redundancy calculation            </span></div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;<span class="comment">#             </span></div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        <span class="keywordflow">if</span> compute_redundancy:</div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            _trials_,_n_nr,_timesteps_ = amplitudes_responses_CR_fl.shape</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;            X = np.reshape(amplitudes_responses_CR_fl.transpose([1,0,2]),[_n_nr,_trials_ * _timesteps_]).T</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;            Y = ampl_CR_eye.flatten()</div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;            CR_eye_fluo=np.array(CR_eye_fluo,dtype=np.float)</div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;            idx_significant=np.where(CR_eye_fluo&gt;np.percentile(CR_eye_fluo_rnd,95))[0]</div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;            ls=sklearn.linear_model.LassoCV(n_alphas=100,eps=1e-3)</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;</div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="comment">#            np.nanmean(cross_val_score(ls, X, Y, cv=ShuffleSplit(10,test_size=.5),scoring=score_))</span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;<span class="comment">#            scores = cross_val_score(lr, X, Y, cv=ShuffleSplit(30,test_size=.5),scoring=score_)</span></div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;</div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;            r_neurons=np.array(CR_eye_fluo[idx_significant],dtype=np.float)<span class="comment">#[idxHighCorr][::-1]</span></div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;            X = X[:,idx_significant]</div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;            ls.fit(X,Y)</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;            print((np.sum(ls.coef_&gt;0)))</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;</div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;            print((len(idx_significant)))</div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;            print((np.mean(CR_eye_fluo[idx_significant])))            </div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;            print((np.std(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;            print((np.max(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;            print((np.median(CR_eye_fluo[idx_significant])))</div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;            print(<span class="stringliteral">&#39;*&#39;</span>)            </div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;            print((np.nanmean(CR_eye_fluo)))              </div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;            print((np.nanstd(CR_eye_fluo)))</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;            print((np.nanmax(CR_eye_fluo)))</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;            print((np.nanmedian(CR_eye_fluo)))</div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;            r_classif_naive=cross_val_score(lr, X, Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;            r_classif=np.mean(r_classif_naive)   </div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;            print((np.mean(r_classif))) </div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;            r_classif_lasso=cross_val_score(lr, X[:,ls.coef_&gt;0], Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;            r_classif=np.mean(r_classif_lasso)</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;            r_neurons=r_neurons[ls.coef_&gt;0]</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;<span class="comment">#            r_classif=[np.mean(cross_val_score(lr, X[:,:iidd+1], Y, cv=ShuffleSplit(30,test_size=.5),scoring=score_)) for iidd in range(_n_nr)][::-1] </span></div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;            print((np.mean(r_classif)))</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;</div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;            <span class="comment">#r_classif=np.array(r_classif).T</span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;            idx_good=np.where((r_neurons != np.array(<span class="keywordtype">None</span>)) &amp; (~np.isnan(r_neurons)))[0]</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;            <span class="comment">#r_classif=r_classif[idx_good]            </span></div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;            r_neurons=r_neurons[idx_good] </div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;            N=len(r_neurons);</div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;            I_neurons = -0.5*np.log(1-r_neurons**2)/np.log(2)</div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;            I_classif = -0.5*np.log(1-r_classif**2)/np.log(2)</div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;            Icum_neurons = np.sum(I_neurons)</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="comment">#            I_classif=I_classif[::-1]</span></div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;            redundancy.append(old_div(np.max(Icum_neurons),np.max(I_classif)))</div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;            print((<span class="stringliteral">&#39;Redundancy:&#39;</span> + str(old_div(np.max(Icum_neurons),np.max(I_classif)))))</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;            print((len(I_neurons)))</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;            print(<span class="stringliteral">&#39;SKIPPED REDUNDANCY&#39;</span>)</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;</div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;</div><div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;        <span class="keywordflow">if</span> 0: <span class="comment"># for examples images use Ag0515           </span></div><div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;            scores = cross_val_score(lr, X, Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)</div><div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;            vls,bns,_=pl.hist(CR_eye_fluo,bins=np.arange(-.1,1,.05))</div><div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;            pl.cla()</div><div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;            vl_distr=scipy.signal.savgol_filter(vls,1,0)</div><div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;            vl_distr=old_div(vl_distr,np.sum(vl_distr))</div><div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160;            pl.plot(bns[1:],vl_distr,<span class="stringliteral">&#39;r&#39;)</span></div><div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;<span class="stringliteral">            lq,hq = np.percentile(CR_eye_fluo_rnd,[5,95])</span></div><div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;<span class="stringliteral">            pl.fill_between([lq,hq],[.35,.35],alpha=.3,color=&#39;c&#39;</span>)</div><div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160;            lq,hq = np.percentile(scores,[5,95])</div><div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;            pl.fill_between([lq,hq],[.35,.35],alpha=.3,color=[.8, .8, .8])</div><div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;            pl.plot([np.mean(scores),np.mean(scores)],[0,.35],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;            pl.xlabel(<span class="stringliteral">&#39;Person\&#39;s r&#39;</span>)</div><div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;            pl.ylabel(<span class="stringliteral">&#39;Probability&#39;</span>)</div><div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;</div><div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;            pl.figure()   </div><div class="line"><a name="l01594"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae318f4f5c6ed7206c5c6975e2cbbe2e4"> 1594</a></span>&#160;            r_each=[np.mean(cross_val_score(lr, X[:,iidd:iidd+1], Y, cv=ShuffleSplit(100,test_size=.5),scoring=score_)) <span class="keywordflow">for</span> iidd <span class="keywordflow">in</span> range(_n_nr)][::-1]</div><div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;<span class="comment">#                r_neurons=np.array(r_each)</span></div><div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;<span class="comment">#                I_neurons = -0.5*np.log(1-r_neurons**2)/np.log(2)</span></div><div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;<span class="comment">#                I_classif = -0.5*np.log(1-r_classif**2)/np.log(2)</span></div><div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;<span class="comment">#                Icum_neurons = np.cumsum(I_neurons)[::-1]</span></div><div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;            pl.plot(Icum_neurons,<span class="stringliteral">&#39;-r&#39;</span>)</div><div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;            pl.plot(I_classif,<span class="stringliteral">&#39;-k&#39;</span>)</div><div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160;</div><div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;            pl.xlabel(<span class="stringliteral">&#39;Number of neurons&#39;</span>)</div><div class="line"><a name="l01603"></a><span class="lineno"> 1603</span>&#160;            pl.legend([<span class="stringliteral">&#39;sum of individual GrCs&#39;</span>,<span class="stringliteral">&#39;classifier&#39;</span>])</div><div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;            pl.ylabel(<span class="stringliteral">&#39;Cumulative information (bits)&#39;</span>)</div><div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;            pl.xlim([-1, N-1])</div><div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;            pl.ylim([0, 1.5])</div><div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;            pl.title(<span class="stringliteral">&#39;Redundancy calculation&#39;</span>)</div><div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160;</div><div class="line"><a name="l01609"></a><span class="lineno"> 1609</span>&#160;</div><div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;</div><div class="line"><a name="l01611"></a><span class="lineno"> 1611</span>&#160;</div><div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;</div><div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]=CR_eye_fluo</div><div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;r_CR_eye_fluo_rnd&#39;</span>]=CR_eye_fluo_rnd</div><div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;</div><div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;        <span class="keywordflow">if</span> len(idx_US)&gt;2:</div><div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idx_US,:,:][:,:,np.logical_and(mat_time&gt;.15,mat_time&lt;.3)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;            print(<span class="stringliteral">&#39;** NOT ENOUGH TRIALS **&#39;</span>)</div><div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR&#39;</span>]=np.nan</div><div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;</div><div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        all_idx_neg=np.union1d(idx_US,idx_NOCR)         </div><div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;        <span class="keywordflow">if</span> len(all_idx_neg)&gt;min_trials:</div><div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR_NOCR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[all_idx_neg,:,:][:,:,np.logical_and(mat_time&gt;.15,mat_time&lt;.3)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160;            print(<span class="stringliteral">&#39;** NOT ENOUGH TRIALS **&#39;</span>)</div><div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR_NOCR&#39;</span>]=np.nan    </div><div class="line"><a name="l01628"></a><span class="lineno"> 1628</span>&#160;</div><div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;</div><div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;active_during_CS&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idx_NOCR,:,:][:,:,np.logical_and(mat_time&gt;-.05,mat_time&lt;-.03)],-1)&lt;thresh_fluo_log,0) </div><div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;</div><div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;        <span class="keywordflow">if</span> len(idx_CR)&gt;min_trials:            </div><div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_CR&#39;</span>]=np.mean(np.min(f_mat_bl_erfc[idx_CR,:,:][:,:,np.logical_and(mat_time&gt;-.05,mat_time&lt;-.03)],-1)&lt;thresh_fluo_log,0)     </div><div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;            bh_correl_tmp[<span class="stringliteral">&#39;active_during_CR&#39;</span>]=np.nan </div><div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;</div><div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;</div><div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>]=mouse</div><div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        print(mouse)</div><div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;</div><div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;idx_component&#39;</span>]=idx_neurons</div><div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;</div><div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;perc_CR&#39;</span>]=len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))</div><div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;</div><div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;</div><div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(mat_ampl_at_US[np.union1d(idx_NOCR,idx_CR)])</div><div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;</div><div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;num_trials&#39;</span>]=len(idxCSCSUS)+len(idx_US) </div><div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fraction_movement&#39;</span>]=fraction_movement</div><div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;ampl_FOV&#39;</span>]=130*50</div><div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;fluo_range&#39;</span>]=3</div><div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;        bh_correl_tmp[<span class="stringliteral">&#39;idx_components_final&#39;</span>]=idx_neurons</div><div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;</div><div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;</div><div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;    <span class="keywordflow">for</span> ss <span class="keywordflow">in</span> sess_:</div><div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;</div><div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;        idx_sess=np.where([item == ss <span class="keywordflow">for</span> item <span class="keywordflow">in</span> cr_ampl_dic[<span class="stringliteral">&#39;session&#39;</span>]])[0]</div><div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;        print(ss)</div><div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160;</div><div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;        session=cr_ampl_dic[<span class="stringliteral">&#39;day&#39;</span>][idx_sess[0]]    </div><div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        day=cr_ampl_dic[<span class="stringliteral">&#39;realDay&#39;</span>][idx_sess[0]]   </div><div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160;        <span class="keywordflow">if</span> mouse != mouse_now:</div><div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;            mouse_now=mouse</div><div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;            session_id = 0</div><div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;            session_now=<span class="stringliteral">&#39;&#39;</span></div><div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;            learning_phase=0</div><div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160;            print(<span class="stringliteral">&#39;early&#39;</span>)</div><div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;            <span class="keywordflow">if</span> day != session_now:</div><div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;                session_id += 1</div><div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;                session_now=day</div><div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;</div><div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160;        idx_CR=np.intersect1d(idx_sess,mat_idxCR)</div><div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;        idx_NOCR=np.intersect1d(idx_sess,mat_idxNOCR)</div><div class="line"><a name="l01675"></a><span class="lineno"> 1675</span>&#160;        idx_US=np.intersect1d(idx_sess,mat_idxUS)</div><div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;        idxCSCSUS=np.intersect1d(idx_sess,mat_idxCSCSUS)</div><div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;<span class="comment">#        if len(idxCSCSUS)+len(idx_US)  &lt; 10:</span></div><div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160;<span class="comment">#            ksks</span></div><div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;</div><div class="line"><a name="l01680"></a><span class="lineno"> 1680</span>&#160;</div><div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;</div><div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;</div><div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;        ampl_CR=pd.DataFrame()</div><div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;</div><div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;</div><div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160;        <span class="keywordflow">if</span> len(idx_CR)&gt;min_trials:    </div><div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;            fluo_crpl=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(mat_fluo[idx_CR,:,:][:,:,np.logical_and(mat_time &gt; -.05,mat_time &lt; time_US_on)],(0,-1))</div><div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160;            ampl_CR[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=fluo_crpl</div><div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;            ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(mat_ampl_at_US[idx_CR])</div><div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;</div><div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;        <span class="keywordflow">else</span>:        </div><div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;            ampl_CR[<span class="stringliteral">&#39;fluo_plus&#39;</span>]=np.nan*idx_neurons</div><div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;            ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>]=np.nan*idx_neurons</div><div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;</div><div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;</div><div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;        <span class="keywordflow">if</span> len(idx_NOCR)&gt;min_trials:       </div><div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            fluo_crmn=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(mat_fluo[idx_NOCR,:,:][:,:,np.logical_and(mat_time &gt; -.05,mat_time &lt; time_US_on)],(0,-1))</div><div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;            ampl_CR[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=fluo_crmn</div><div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;</div><div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;            ampl_CR[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=np.nan*idx_neurons</div><div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;</div><div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;</div><div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;</div><div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;</div><div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;        ampl_CR[<span class="stringliteral">&#39;session&#39;</span>]=session</div><div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;        ampl_CR[<span class="stringliteral">&#39;mouse&#39;</span>]=mouse;</div><div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;        ampl_CR[<span class="stringliteral">&#39;chunk&#39;</span>]=ss    </div><div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;</div><div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;</div><div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;</div><div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;</div><div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;        ampl_CR[<span class="stringliteral">&#39;idx_component&#39;</span>]=idx_neurons</div><div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160;        ampl_CR[<span class="stringliteral">&#39;perc_CR&#39;</span>]=len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))</div><div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;</div><div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;</div><div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;</div><div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <span class="keywordflow">if</span> len(sess_)&gt;1:</div><div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;</div><div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;            <span class="keywordflow">if</span>  len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))&gt; thresh_middle <span class="keywordflow">and</span> learning_phase==0:</div><div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;                learning_phase=1</div><div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;                print(<span class="stringliteral">&#39;middle&#39;</span>)</div><div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;            <span class="keywordflow">elif</span> len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))&gt; thresh_advanced <span class="keywordflow">and</span> learning_phase==1:</div><div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;                learning_phase=2</div><div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;                print(<span class="stringliteral">&#39;advanced&#39;</span>)</div><div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;            <span class="keywordflow">elif</span> len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))&gt; thresh_late <span class="keywordflow">and</span> learning_phase==3:</div><div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;                learning_phase=3</div><div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;                print(<span class="stringliteral">&#39;late&#39;</span>)</div><div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160;</div><div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l01731"></a><span class="lineno"> 1731</span>&#160;            <span class="keywordflow">if</span> (len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))) &gt; thresh_late:</div><div class="line"><a name="l01732"></a><span class="lineno"> 1732</span>&#160;                learning_phase=3</div><div class="line"><a name="l01733"></a><span class="lineno"> 1733</span>&#160;                print(<span class="stringliteral">&#39;late&#39;</span>)</div><div class="line"><a name="l01734"></a><span class="lineno"> 1734</span>&#160;            <span class="keywordflow">elif</span> len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))&gt; thresh_advanced:</div><div class="line"><a name="l01735"></a><span class="lineno"> 1735</span>&#160;                learning_phase=2</div><div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160;                print(<span class="stringliteral">&#39;advanced&#39;</span>)</div><div class="line"><a name="l01737"></a><span class="lineno"> 1737</span>&#160;            <span class="keywordflow">elif</span>  len(idx_CR)*1./(len(idx_NOCR)+len(idx_CR))&gt; thresh_middle:</div><div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;                learning_phase=1</div><div class="line"><a name="l01739"></a><span class="lineno"> 1739</span>&#160;                print(<span class="stringliteral">&#39;middle&#39;</span>)</div><div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;</div><div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;</div><div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;</div><div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;        ampl_CR[<span class="stringliteral">&#39;learning_phase&#39;</span>]= learning_phase          </div><div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160;        ampl_CR[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>]=<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">func_avg_fluo</a>(mat_ampl_at_US[np.union1d(idx_NOCR,idx_CR)])</div><div class="line"><a name="l01745"></a><span class="lineno"> 1745</span>&#160;        ampl_CR[<span class="stringliteral">&#39;session_id&#39;</span>]=session_id        </div><div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;</div><div class="line"><a name="l01747"></a><span class="lineno"> 1747</span>&#160;        print((len(idxCSCSUS)+len(idx_US)))  </div><div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;        ampl_CR[<span class="stringliteral">&#39;num_trials&#39;</span>]=len(idxCSCSUS)+len(idx_US)  </div><div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;        ampl_CR[<span class="stringliteral">&#39;ampl_FOV&#39;</span>]=130*50 </div><div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;        ampl_CR[<span class="stringliteral">&#39;fluo_range_responsive&#39;</span>]=3  </div><div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;</div><div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;</div><div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;</div><div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;</div><div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;        cr_ampl=pd.concat([cr_ampl,ampl_CR]) </div><div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;</div><div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;    print(learning_phase)</div><div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;    bh_correl_tmp[<span class="stringliteral">&#39;learning_phase&#39;</span>] = learning_phase    </div><div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;</div><div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;</div><div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;    bh_correl=pd.concat([bh_correl,bh_correl_tmp])</div><div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;</div><div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;print((bh_correl.isnull().sum()))</div><div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;print((cr_ampl.isnull().sum()))         </div><div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;<span class="comment">#%%    </span></div><div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;<span class="comment">#print mat_idxCR.size</span></div><div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160;<span class="comment">#amplitudes_responses=np.nanmedian(mat_fluo[:,:,np.logical_and(mat_time &gt; -.05,mat_time &lt; time_US_on)],(-1))</span></div><div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;<span class="comment">#mat_cr_ampl=pd.DataFrame()</span></div><div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;<span class="comment">#mat_cr_ampl_tmp=pd.DataFrame()</span></div><div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;<span class="comment">#for counter,resp in enumerate(amplitudes_responses):</span></div><div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;fluo&#39;]=resp</span></div><div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;trial_counter&#39;]=counter</span></div><div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;trialName&#39;]=cr_ampl_dic[&#39;trialName&#39;][counter]</span></div><div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;trials&#39;]=cr_ampl_dic[&#39;trials&#39;][counter]</span></div><div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;trialsTypeOrig&#39;]=cr_ampl_dic[&#39;trialsTypeOrig&#39;][counter]</span></div><div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;session&#39;]=cr_ampl_dic[&#39;session&#39;][counter]</span></div><div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;mouse&#39;]=cr_ampl_dic[&#39;animal&#39;][counter]</span></div><div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;day&#39;]=cr_ampl_dic[&#39;day&#39;][counter]</span></div><div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;session_id&#39;]=cr_ampl_dic[&#39;realDay&#39;][counter]</span></div><div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160;<span class="comment">#    mat_cr_ampl_tmp[&#39;amplAtUs&#39;]=mat_ampl_at_US[counter]</span></div><div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;<span class="comment">#    if any(sstr in cr_ampl_dic[&#39;trialName&#39;][counter] for sstr in [&#39;CSUSwCR&#39;,&#39;CSwCR&#39;]):        </span></div><div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;<span class="comment">#        mat_cr_ampl_tmp[&#39;type_CR&#39;]=1</span></div><div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;<span class="comment">#    elif any(sstr in cr_ampl_dic[&#39;trialName&#39;][counter] for sstr in [&#39;US&#39;]):</span></div><div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;<span class="comment">#        mat_cr_ampl_tmp[&#39;type_CR&#39;]=np.nan</span></div><div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;<span class="comment">#    else:</span></div><div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;<span class="comment">#        mat_cr_ampl_tmp[&#39;type_CR&#39;]=0</span></div><div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160;<span class="comment">#    mat_cr_ampl = pd.concat([mat_cr_ampl,mat_cr_ampl_tmp])</span></div><div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;<span class="comment">#sess_grp=mat_cr_ampl.groupby(&#39;session&#39;)</span></div><div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160;<span class="comment">#for nm,idxs in sess_grp.indices.iteritems():</span></div><div class="line"><a name="l01795"></a><span class="lineno"> 1795</span>&#160;<span class="comment">#    print nm</span></div><div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="comment">#    mat_cr_ampl_tmp=mat_cr_ampl[idxs]</span></div><div class="line"><a name="l01797"></a><span class="lineno"> 1797</span>&#160;<span class="comment">#    nm_idxCR=np.where(mat_cr_ampl_tmp[&#39;type_CR&#39;])[0]    </span></div><div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;<span class="comment">#    print (len(nm_idxCR))</span></div><div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;<span class="comment">#    if len(nm_idxCR)&gt;min_trials:</span></div><div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;<span class="comment">#        ampl_CR[&#39;fluo_plus&#39;]=fluo_crpl</span></div><div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;<span class="comment">#        ampl_CR[&#39;ampl_eyelid_CR&#39;]=np.mean(amplitudes_at_US[nm_idxCR])</span></div><div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;<span class="comment">#    else:        </span></div><div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;<span class="comment">#        ampl_CR[&#39;fluo_plus&#39;]=np.nan</span></div><div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;<span class="comment">#        ampl_CR[&#39;ampl_eyelid_CR&#39;]=np.nan</span></div><div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l01807"></a><span class="lineno"> 1807</span>&#160;<span class="comment">#    if len(nm_idxNOCR)&gt;min_trials:       </span></div><div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="comment">#        ampl_CR[&#39;fluo_minus&#39;]=fluo_crmn</span></div><div class="line"><a name="l01809"></a><span class="lineno"> 1809</span>&#160;<span class="comment">#    else:</span></div><div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;<span class="comment">#        ampl_CR[&#39;fluo_minus&#39;]=np.nan</span></div><div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;<span class="comment">#        </span></div><div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;<span class="comment">#    ampl_CR[&#39;session&#39;]=session;</span></div><div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;<span class="comment">#    ampl_CR[&#39;mouse&#39;]=mouse;</span></div><div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;<span class="comment">#    ampl_CR[&#39;chunk&#39;]=chunk    </span></div><div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;<span class="comment">#    ampl_CR[&#39;idx_component&#39;]=idx_components_final;</span></div><div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;<span class="comment">#    ampl_CR[&#39;perc_CR&#39;]=len(nm_idxCR)*1./len(nm_idxCSCSUS)</span></div><div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;<span class="comment">#    if  len(nm_idxCR)*1./len(nm_idxCSCSUS)&gt; thresh_middle and learning_phase==0:</span></div><div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;<span class="comment">#        learning_phase=1</span></div><div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160;<span class="comment">#        print &#39;middle&#39;</span></div><div class="line"><a name="l01820"></a><span class="lineno"> 1820</span>&#160;<span class="comment">#    elif len(nm_idxCR)*1./len(nm_idxCSCSUS)&gt; thresh_late and learning_phase==1:</span></div><div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="comment">#        learning_phase=2</span></div><div class="line"><a name="l01822"></a><span class="lineno"> 1822</span>&#160;<span class="comment">#        print &#39;late&#39;</span></div><div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;<span class="comment">#    ampl_CR[&#39;learning_phase&#39;]= learning_phase          </span></div><div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;<span class="comment">#    ampl_CR[&#39;ampl_eyelid_CSCSUS&#39;]=np.mean(amplitudes_at_US[nm_idxCSCSUS])</span></div><div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;<span class="comment">#    ampl_CR[&#39;session_id&#39;]=session_id</span></div><div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;<span class="comment">#    cr_ampl=pd.concat([cr_ampl,ampl_CR])</span></div><div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;<span class="comment">#mat_eyelid=mat_eyelid-np.nanmean(mat_eyelid[mat_time &lt; -.44,:],0)[np.newaxis,:]</span></div><div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;<span class="comment">#UR_size=np.median(np.nanmax(mat_eyelid[np.logical_and(mat_time &gt; .03,mat_time &lt; .25) ,:],0))</span></div><div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;<span class="comment">#mat_eyelid=mat_eyelid/UR_size</span></div><div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160;<span class="comment">#bins_trials=pd.cut(mat_cr_ampl[&#39;trial_counter&#39;],[0,200,600,822],include_lowest=True)    </span></div><div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;<span class="comment">#grouped_session=mat_cr_ampl.groupby([&#39;mouse&#39;,bins_trials,&#39;type_CR&#39;])  </span></div><div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;<span class="comment">#mean_plus=grouped_session.mean().loc[&#39;AG051514-01&#39;].loc[(slice(None),[1.0]),:]</span></div><div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;<span class="comment">#mean_minus=grouped_session.mean().loc[&#39;AG051514-01&#39;].loc[(slice(None),[0.0]),:]</span></div><div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;<span class="comment">#std_plus=grouped_session.sem().loc[&#39;AG051514-01&#39;].loc[(slice(None),[1.0]),:]</span></div><div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160;<span class="comment">#std_minus=grouped_session.sem().loc[&#39;AG051514-01&#39;].loc[(slice(None),[0.0]),:]</span></div><div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;</div><div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;cr_ampl_old=cr_ampl.copy()</div><div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;cr_ampl=cr_ampl_old.copy()</div><div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;<span class="comment">#%% ****** INIT ANALYSIS</span></div><div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160;pl.rcParams[<span class="stringliteral">&#39;pdf.fonttype&#39;</span>] = 42</div><div class="line"><a name="l01850"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6cd5922b1316a58f3ac11f4478bc123d"> 1850</a></span>&#160;font = {<span class="stringliteral">&#39;family&#39;</span> : <span class="stringliteral">&#39;Myriad Pro&#39;</span>,</div><div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;        <span class="stringliteral">&#39;weight&#39;</span> : <span class="stringliteral">&#39;regular&#39;</span>,</div><div class="line"><a name="l01852"></a><span class="lineno"> 1852</span>&#160;        <span class="stringliteral">&#39;size&#39;</span>   : 20}</div><div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;</div><div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;</div><div class="line"><a name="l01857"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af7f25bd168750e4be6797c3fa6c1404b"> 1857</a></span>&#160;grouped_session=cr_ampl.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>])  </div><div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;</div><div class="line"><a name="l01859"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af29bf3f6d2f23d226d35910fb0b1723a"> 1859</a></span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;b35&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;b35&#39;</span>]))))</div><div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;b37&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;b37&#39;</span>]))))</div><div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;gc-AGGC6f-031213-03&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;gc-AGGC6f-031213-03&#39;</span>]))))</div><div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]))))</div><div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;AG052014-01&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;AG052014-01&#39;</span>]))))</div><div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;grouped_session.mean().loc[<span class="stringliteral">&#39;AG051514-01&#39;</span>][[<span class="stringliteral">&#39;ampl_eyelid_CR&#39;</span>,<span class="stringliteral">&#39;perc_CR&#39;</span>]].plot(kind=<span class="stringliteral">&#39;line&#39;</span>,subplots=<span class="keyword">True</span>,layout=(2,1),marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,xticks=list(range(len(grouped_session.mean().loc[<span class="stringliteral">&#39;AG051514-01&#39;</span>]))))</div><div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;</div><div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;<span class="comment">#pl.ylim([0,.5])</span></div><div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01869"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae8b31000f68152a5834e996b507ddeb3"> 1869</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae8b31000f68152a5834e996b507ddeb3">get_stats</a>(group):</div><div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;    <span class="keywordflow">return</span> {<span class="stringliteral">&#39;min&#39;</span>: group.min(), <span class="stringliteral">&#39;max&#39;</span>: group.max(), <span class="stringliteral">&#39;count&#39;</span>: group.count(), <span class="stringliteral">&#39;mean&#39;</span>: group.mean()}</div><div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;min_trials_pd=8</div><div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;max_range_fluo_pd=4</div><div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160;min_neuron_number_pd=8</div><div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;cr_ampl_sel=cr_ampl[(cr_ampl.fluo_range_responsive&lt;=max_range_fluo_pd) &amp; (cr_ampl.num_trials&gt;=min_trials_pd)].copy()</div><div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;bh_correl_sel=bh_correl[(bh_correl.fluo_range&lt;=max_range_fluo_pd) &amp; (bh_correl.num_trials&gt;=min_trials_pd)].copy()</div><div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160;    <span class="comment">#%% NUMBER OF NEURONS PER FOV</span></div><div class="line"><a name="l01878"></a><span class="lineno"> 1878</span>&#160;bh_correl_tmp=bh_correl_sel.copy()</div><div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;bh_correl_tmp.groupby(<span class="stringliteral">&#39;mouse&#39;</span>).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01880"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad5e0c1e7fb03ba418f3430b94ffce3b1"> 1880</a></span>&#160;large_fovs_number_of_neurons = bh_correl_tmp.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>,<span class="stringliteral">&#39;chunk&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).agg([np.mean,scipy.stats.sem])</div><div class="line"><a name="l01881"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa4cbb814d2e3339e8c758b80a30e2dac"> 1881</a></span>&#160;small_fovs_number_of_neurons = bh_correl_tmp.groupby([<span class="stringliteral">&#39;mouse&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;</div><div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;small_fovs_number_of_neurons = bh_correl_sel.groupby([<span class="stringliteral">&#39;mouse&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;small_fovs_number_of_neurons = small_fovs_number_of_neurons[[<span class="stringliteral">&#39;b3&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> ii <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> small_fovs_number_of_neurons.index]].values</div><div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;<span class="comment">#%% COUNT REPONDING NEURONS, JUST USE LAST SESSION or ALL SESSION  FFOLLOWED TRUE</span></div><div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;bh_correl_tmp=bh_correl_sel.copy()</div><div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;</div><div class="line"><a name="l01888"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac50d5a7d80a141132766efda44b18684"> 1888</a></span>&#160;b37_last_sess = bh_correl_tmp[(bh_correl_tmp.mouse==<span class="stringliteral">&#39;b37&#39;</span>) &amp;  (bh_correl_tmp.session == <span class="stringliteral">&#39;20160705103903&#39;</span>) &amp; (bh_correl_tmp.chunk == <span class="stringliteral">&#39;121&#39;</span>)]</div><div class="line"><a name="l01889"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a93f67bd9f16511c1fbc9e24f36ae24d6"> 1889</a></span>&#160;b35_last_sess = bh_correl_tmp[(bh_correl_tmp.mouse==<span class="stringliteral">&#39;b35&#39;</span>) &amp;  (bh_correl_tmp.session == <span class="stringliteral">&#39;20160714143248&#39;</span>) &amp; (bh_correl_tmp.chunk == <span class="stringliteral">&#39;061&#39;</span>)]</div><div class="line"><a name="l01890"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a48ee669343c43eadc8c63e2f7cecf638"> 1890</a></span>&#160;AG051514_01_last_sess = bh_correl_tmp[(bh_correl_tmp.mouse==<span class="stringliteral">&#39;AG051514-01&#39;</span>)]</div><div class="line"><a name="l01891"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa16dbab20e588cb20fe680555f91304e"> 1891</a></span>&#160;AG052014_01_last_sess = bh_correl_tmp[(bh_correl_tmp.mouse==<span class="stringliteral">&#39;AG052014-01&#39;</span>)]</div><div class="line"><a name="l01892"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aec53efe9d8350bf5f6a65d742afcd497"> 1892</a></span>&#160;gc_AGGC6f_031213_03_last_sess = bh_correl_tmp[(bh_correl_tmp.mouse==<span class="stringliteral">&#39;gc-AGGC6f-031213-03&#39;</span>)]</div><div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;<span class="comment">#gc_AG052014_02_last_sess =bh_correl_tmp[(bh_correl_tmp.mouse==&#39;gc-AG052014-02&#39;)]</span></div><div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160;</div><div class="line"><a name="l01895"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae95979d2a4483d4f3964dd913180f567"> 1895</a></span>&#160;cr_neurons=[]</div><div class="line"><a name="l01896"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a02e6e207c65b62b053a0ab373a780317"> 1896</a></span>&#160;all_neurons=[]</div><div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;<span class="comment">#for ms in [b37_last_sess, b35_last_sess, AG051514_01_last_sess, AG052014_01_last_sess, gc_AGGC6f_031213_03_last_sess,gc_AG052014_02_last_sess ]:</span></div><div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;<span class="keywordflow">for</span> ms <span class="keywordflow">in</span> [b37_last_sess, b35_last_sess, AG051514_01_last_sess, AG052014_01_last_sess, gc_AGGC6f_031213_03_last_sess]:</div><div class="line"><a name="l01899"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7df33ae4b586fc8b1896bcfbd9037b53"> 1899</a></span>&#160;    ms_1=ms.copy()</div><div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    print((ms_1.mouse.unique()))</div><div class="line"><a name="l01901"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abed946c62f140eb7ff2ac742e6ad9497"> 1901</a></span>&#160;    ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo_rnd&#39;</span>]=ms.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[<span class="stringliteral">&#39;r_CR_eye_fluo_rnd&#39;</span>].transform(<span class="keyword">lambda</span> x: x.quantile(.95))</div><div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;    ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]=ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]-ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo_rnd&#39;</span>]</div><div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    cr_neurons.append(len(ms_1[ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]&gt;0])*1.)</div><div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;    all_neurons.append(len(ms_1))</div><div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160;    print((len(ms_1[ms_1[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>]&gt;0])*1./len(ms_1)))</div><div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;</div><div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;all_neurons=np.array(all_neurons)    </div><div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;cr_neurons=np.array(cr_neurons)   </div><div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;</div><div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;print((np.sum(cr_neurons)*1./np.sum(all_neurons))) </div><div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;print((np.mean(cr_neurons*1/all_neurons))) </div><div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;print((np.std(cr_neurons*1/all_neurons))) </div><div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;print((scipy.stats.sem(cr_neurons*1/all_neurons))) </div><div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;<span class="comment">#%% NUMBER OF NEURONS PER FOV</span></div><div class="line"><a name="l01915"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aee80a042678dac2c980abc8b61dc3bf1"> 1915</a></span>&#160;large_fov_size = 230*230</div><div class="line"><a name="l01916"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6725a07ffbdfcf6727151326dde6440a"> 1916</a></span>&#160;small_fov_size = 130*50</div><div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;bh_correl_tmp=bh_correl_sel.copy()</div><div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;bh_correl_tmp.groupby(<span class="stringliteral">&#39;mouse&#39;</span>).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;large_fovs_number_of_neurons = bh_correl_tmp.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>,<span class="stringliteral">&#39;chunk&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).agg([np.mean,scipy.stats.sem])</div><div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;</div><div class="line"><a name="l01921"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a64fc43f33b2d9d723af065e4af927d44"> 1921</a></span>&#160;neurons_per_100_um2 = large_fovs_number_of_neurons/large_fov_size*100*100</div><div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;</div><div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;small_fovs_number_of_neurons = bh_correl_tmp.groupby([<span class="stringliteral">&#39;mouse&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;</div><div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;</div><div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;</div><div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;small_fovs_number_of_neurons = bh_correl_sel.groupby([<span class="stringliteral">&#39;mouse&#39;</span>]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>].groupby(level=0).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()</div><div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160;small_fovs_number_of_neurons = small_fovs_number_of_neurons[[<span class="stringliteral">&#39;b3&#39;</span> <span class="keywordflow">not</span> <span class="keywordflow">in</span> ii <span class="keywordflow">for</span> ii <span class="keywordflow">in</span> small_fovs_number_of_neurons.index]].values</div><div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;</div><div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;neurons_per_100_um2 =  np.hstack([neurons_per_100_um2.values[:,0].squeeze(),small_fovs_number_of_neurons*1./small_fov_size*100*100])</div><div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;print((np.mean(neurons_per_100_um2)))</div><div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;print((np.std(neurons_per_100_um2)))</div><div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;</div><div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;<span class="comment">#[cr_ampl[&#39;mouse&#39;]==&#39;b37&#39;]</span></div><div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;<span class="comment">#%% OLD BY BY CELL</span></div><div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;<span class="comment">#for jjj in range(10):</span></div><div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;<span class="comment">#    samples_per_FOV=30</span></div><div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;<span class="comment">#    cr_ampl_m=cr_ampl_sel</span></div><div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;<span class="comment">#    cr_ampl_m=cr_ampl_m.groupby([&#39;mouse&#39;,&#39;session&#39;])</span></div><div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;<span class="comment">#    cr_ampl_m = cr_ampl_m.apply(lambda x:x.sample(samples_per_FOV,replace=True))</span></div><div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;<span class="comment">#    print len(cr_ampl_m)</span></div><div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;<span class="comment">#    cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;gc-AG052014-02&#39;]</span></div><div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;<span class="comment">#    #cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;AG052014-01&#39;]</span></div><div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160;<span class="comment">#    grouped_session=cr_ampl_m.groupby([&#39;learning_phase&#39;])    </span></div><div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;<span class="comment">#    means=grouped_session.mean()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]</span></div><div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160;<span class="comment">#    sems=grouped_session.sem()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]</span></div><div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;<span class="comment">#    means.plot(kind=&#39;line&#39;,yerr=sems,marker =&#39;o&#39;,xticks=range(6),markersize=15)</span></div><div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;<span class="comment">#    #grouped_session.mean()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]].plot(kind=&#39;line&#39;,yerr=sems,marker=&#39;o&#39;,markersize=15,xticks=range(len(grouped_session.mean())))</span></div><div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;<span class="comment">#    #pl.rc(&#39;font&#39;, **font)</span></div><div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160;<span class="comment">#    pl.xticks(np.arange(4),[&#39;Naive&#39;,&#39;Learning&#39;,&#39;Advanced&#39;,&#39;Trained&#39;])</span></div><div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;<span class="comment">#    pl.xlabel(&#39;Learning Phase&#39;)</span></div><div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;<span class="comment">#    pl.ylabel(&#39;DF/F&#39;)</span></div><div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160;<span class="comment">#    pl.legend([&#39;CR+&#39;,&#39;CR-&#39;],loc=0)</span></div><div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;<span class="comment">#    pl.xlim([-.1 ,3.1])</span></div><div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;<span class="comment">#    pluss=grouped_session.apply(lambda x: x[[&#39;fluo_plus&#39;]].values).values</span></div><div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160;<span class="comment">#    pl_m=[]</span></div><div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;<span class="comment">#    for pl_ in pluss:</span></div><div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;<span class="comment">#        pl_=np.array(pl_)</span></div><div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160;<span class="comment">#        pl_m.append(pl_[~np.isnan(pl_)])</span></div><div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;<span class="comment">#    pl_m = filter(len,pl_m)</span></div><div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;<span class="comment">#    scipy.stats.f_oneway(*pl_m)    </span></div><div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160;<span class="comment">#    idx2=[]</span></div><div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;<span class="comment">#    idx1=[]</span></div><div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;<span class="comment">#    for ii,pl_ in enumerate(pl_m):</span></div><div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;<span class="comment">#        idx2.append([ii]*len(pl_))</span></div><div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;<span class="comment">#        idx1.append(pl_)</span></div><div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;<span class="comment">#    idx2=np.hstack(idx2)   </span></div><div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160;<span class="comment">#    idx1= np.hstack(idx1)      </span></div><div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;<span class="comment">#    print scipy.stats.pearsonr(idx2, idx1)</span></div><div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;</div><div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;<span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</div><div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160;<span class="comment">#%% values javier</span></div><div class="line"><a name="l02003"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7dd983044e64132abf41cc4a2e04aebb"> 2003</a></span>&#160;cr_ampl_m = cr_ampl.copy()</div><div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;<span class="keywordflow">for</span> mse <span class="keywordflow">in</span> cr_ampl_m.mouse.unique():</div><div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160;    print(mse)</div><div class="line"><a name="l02006"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ac885a73de16bd3131e5d896fe1d79915"> 2006</a></span>&#160;    subset=cr_ampl_m[(cr_ampl_m.mouse==mse)]</div><div class="line"><a name="l02007"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad9db5f1630218a2f27774fa29614ca1e"> 2007</a></span>&#160;    begin=np.vstack(subset[(subset.session_id&lt;2)][[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]].values[:,1]).squeeze()</div><div class="line"><a name="l02008"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#afb358f48b1646c750fb9da6c6585be2b"> 2008</a></span>&#160;    end=np.vstack(subset[(subset.session_id&gt;=subset.session_id.max()-2)][[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]].values[:,0])</div><div class="line"><a name="l02009"></a><span class="lineno"> 2009</span>&#160;    end=end[~np.isnan(end)]</div><div class="line"><a name="l02010"></a><span class="lineno"> 2010</span>&#160;    begin=begin[~np.isnan(begin)]    </div><div class="line"><a name="l02011"></a><span class="lineno"> 2011</span>&#160;    print((scipy.stats.ttest_ind(begin,end)))</div><div class="line"><a name="l02012"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a88a4c2d6a693ff078bafe10426eba7c5"> 2012</a></span>&#160;    end1,end2=np.vstack(subset[(subset.session_id&gt;=subset.session_id.max()-2)][[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]].values)[:,[0,1]]</div><div class="line"><a name="l02013"></a><span class="lineno"> 2013</span>&#160;    end=end[~np.isnan(end)]</div><div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;</div><div class="line"><a name="l02015"></a><span class="lineno"> 2015</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02016"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0192a0f583241c3dad6db66e90bd2f37"> 2016</a></span>&#160;all_rs_plus=[]</div><div class="line"><a name="l02017"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8e13ee3390935c263c8a1094a116b5c7"> 2017</a></span>&#160;all_anova_plus=[]</div><div class="line"><a name="l02018"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a892da407afdf610ba785b63ab183e154"> 2018</a></span>&#160;all_rs_minus=[]</div><div class="line"><a name="l02019"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abadb60818a0b69cf97cc0732a2d62268"> 2019</a></span>&#160;all_anova_minus=[]</div><div class="line"><a name="l02020"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d342e2b05ce32f0039cd4109aaf03ea"> 2020</a></span>&#160;all_ttest_plus_vs_minus=[]</div><div class="line"><a name="l02021"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2b711ea2a36add518dbbbdaf2561ee23"> 2021</a></span>&#160;all_ttest_first_vs_last_plus=[]</div><div class="line"><a name="l02022"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad569bad6489880b45afd56f60226d595"> 2022</a></span>&#160;all_ttest_first_vs_last_minus=[]</div><div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;</div><div class="line"><a name="l02024"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7b2dc4479e031470b4a01846091835ad"> 2024</a></span>&#160;n_all_ttest_plus_vs_minus=[]</div><div class="line"><a name="l02025"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a32eef58ba45af6943dfd7cf8025d7588"> 2025</a></span>&#160;n_all_ttest_first_vs_last_plus=[]</div><div class="line"><a name="l02026"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a289dbf9b8c7597b2a9e92e25cdc7fac9"> 2026</a></span>&#160;n_all_ttest_first_vs_last_minus=[]</div><div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;</div><div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;</div><div class="line"><a name="l02029"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7a92cc9f34498dc39bacbb81a309a5dc"> 2029</a></span>&#160;samples_per_FOV=30</div><div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;<span class="comment">#group_var = &#39;ampl_eyelid_CSCSUS&#39;</span></div><div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;<span class="comment">#bins=[-0.15,.15, .4,  1]</span></div><div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;</div><div class="line"><a name="l02034"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab661757ed8878057d1ae8ed281504ef0"> 2034</a></span>&#160;group_var = <span class="stringliteral">&#39;perc_CR&#39;</span></div><div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160;bins=[0,.2,.4,.6, .8, 1]</div><div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;</div><div class="line"><a name="l02037"></a><span class="lineno"> 2037</span>&#160;</div><div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;<span class="comment">#group_var = &#39;learning_phase&#39;</span></div><div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;<span class="comment">#bins=[0,.1,1,2,3]</span></div><div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;</div><div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;</div><div class="line"><a name="l02042"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2bf213b2892defc5411797be940e6b63"> 2042</a></span>&#160;all_traces_sem=[]</div><div class="line"><a name="l02043"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5e3a6c20143766d56971f801fdab4539"> 2043</a></span>&#160;all_traces_mean=[]</div><div class="line"><a name="l02044"></a><span class="lineno"> 2044</span>&#160;pl.figure()</div><div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="keywordflow">for</span> jjj <span class="keywordflow">in</span> range(40):</div><div class="line"><a name="l02046"></a><span class="lineno"> 2046</span>&#160;    cr_ampl_m=cr_ampl_sel<span class="comment">#[cr_ampl[&#39;mouse&#39;]==&#39;b37&#39;]</span></div><div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    ax=pl.gca()</div><div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    cr_ampl_m=cr_ampl_sel</div><div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    cr_ampl_m=cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>])</div><div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    cr_ampl_m = cr_ampl_m.apply(<span class="keyword">lambda</span> x:x.sample(samples_per_FOV,replace=<span class="keyword">True</span>))</div><div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;</div><div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <span class="comment">#grouped_session=cr_ampl_m.sort([&#39;perc_CR&#39;],ascending=True)</span></div><div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;<span class="comment">#    cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;gc-AG052014-02&#39;]</span></div><div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    <span class="comment">#cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;AG052014-01&#39;]</span></div><div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;    <span class="comment">#cr_ampl_m=cr_ampl_m[(cr_ampl_m.mouse==&#39;AG052014-01&#39;) | (cr_ampl_m.mouse==&#39;gc-AG052014-02&#39;)]</span></div><div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    <span class="comment">#cr_ampl_m=cr_ampl_m[(cr_ampl_m.mouse==&#39;AG052014-01&#39;)]</span></div><div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    cr_ampl_m.dropna()</div><div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    grouped_session=cr_ampl_m.groupby(pd.cut(cr_ampl_m[group_var],bins,include_lowest=<span class="keyword">True</span>)) </div><div class="line"><a name="l02059"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a462c6236d48c791996fa3f95a622bf93"> 2059</a></span>&#160;    means=grouped_session.mean()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]][grouped_session.count()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]&gt;min_neuron_number_pd]</div><div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;    <span class="comment">#sems=grouped_session.apply(lambda x: x.dropna().quantile(.75) - x.dropna().quantile(.25))[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]</span></div><div class="line"><a name="l02061"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a902cc90538899ef761de1386eaae77fd"> 2061</a></span>&#160;    sems=grouped_session.sem()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]][grouped_session.count()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]&gt;min_neuron_number_pd]</div><div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;</div><div class="line"><a name="l02063"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a179d1b96ee8138b34cd91883237d6426"> 2063</a></span>&#160;    means.plot(kind=<span class="stringliteral">&#39;line&#39;</span>,yerr=sems,marker =<span class="stringliteral">&#39;o&#39;</span>,xticks=list(range(6)),markersize=15,ax=ax,color=[<span class="stringliteral">&#39;k&#39;</span>,<span class="stringliteral">&#39;r&#39;])</span></div><div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160;<span class="stringliteral">    pl.xlim([-.1, 5.1])</span></div><div class="line"><a name="l02066"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aeee9f371db14fda0de35d16324a167df"> 2066</a></span>&#160;<span class="stringliteral">    pl.legend([&#39;CR+&#39;</span>,<span class="stringliteral">&#39;CR-&#39;</span>],loc=4)</div><div class="line"><a name="l02067"></a><span class="lineno"> 2067</span>&#160;    pl.xlabel(group_var)</div><div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    pl.ylabel(<span class="stringliteral">&#39;DF/F&#39;</span>)</div><div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    pl.pause(.1)</div><div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;</div><div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;</div><div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;    all_traces_mean.append(means.values)</div><div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;</div><div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;    all_traces_sem.append(sems.values)</div><div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;</div><div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;</div><div class="line"><a name="l02077"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a43f16fc97ab9a5c11735f5d69f1deb26"> 2077</a></span>&#160;    pluss=grouped_session.apply(<span class="keyword">lambda</span> x: x[[<span class="stringliteral">&#39;fluo_plus&#39;</span>]].values).values</div><div class="line"><a name="l02078"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af989a4c2c772ad644a6f5c56fc4a0157"> 2078</a></span>&#160;    pl_m=[]</div><div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;    <span class="keywordflow">for</span> pl_ <span class="keywordflow">in</span> pluss:</div><div class="line"><a name="l02080"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a440f41d0036c9a510f7c48f7701716eb"> 2080</a></span>&#160;        pl_=np.array(pl_)</div><div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;        pl_m.append(pl_[~np.isnan(pl_)])</div><div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;</div><div class="line"><a name="l02083"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad04d626998646c5631249d2af4a2c045"> 2083</a></span>&#160;    plus_for_ttest=pl_m</div><div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;    pl_m = list(filter(len,pl_m))</div><div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;    all_ttest_first_vs_last_plus.append(scipy.stats.ttest_ind(pl_m[0],pl_m[-1]))</div><div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160;    n_all_ttest_first_vs_last_plus.append((len(pl_m[0]),len(pl_m[-2]) ))</div><div class="line"><a name="l02087"></a><span class="lineno"> 2087</span>&#160;</div><div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;</div><div class="line"><a name="l02089"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a70859207f81d2f070cc6138b1f009c4b"> 2089</a></span>&#160;    anova_1 = scipy.stats.f_oneway(*pl_m) </div><div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;</div><div class="line"><a name="l02091"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a23497a489bbae29fd3ce43b3cc059bcd"> 2091</a></span>&#160;    idx2=[]</div><div class="line"><a name="l02092"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a60a033e71a3b9ac921e3e95b6e098a19"> 2092</a></span>&#160;    idx1=[]</div><div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;    <span class="keywordflow">for</span> ii,pl_ <span class="keywordflow">in</span> enumerate(pl_m):</div><div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;        idx2.append([ii]*len(pl_))</div><div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;        idx1.append(pl_)</div><div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;</div><div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    idx2=np.hstack(idx2)   </div><div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;    idx1= np.hstack(idx1)      </div><div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;</div><div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;</div><div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;<span class="comment">#    X = sm.add_constant(idx2, prepend=False)</span></div><div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;<span class="comment">#    y=idx1</span></div><div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;<span class="comment">#    model=sm.OLS(y,X)</span></div><div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="comment">#    results=model.fit()</span></div><div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;<span class="comment">#    print results.summary()</span></div><div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;</div><div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;    all_rs_plus.append(scipy.stats.pearsonr(idx2, idx1))</div><div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    all_anova_plus.append((anova_1.statistic,anova_1.pvalue))</div><div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;</div><div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;</div><div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;</div><div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;</div><div class="line"><a name="l02114"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a509427a1982166dc217e32873dceed51"> 2114</a></span>&#160;    minuss=grouped_session.apply(<span class="keyword">lambda</span> x: x[[<span class="stringliteral">&#39;fluo_minus&#39;</span>]].values).values</div><div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    pl_m=[]</div><div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    <span class="keywordflow">for</span> pl_ <span class="keywordflow">in</span> minuss:</div><div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;        pl_=np.array(pl_)</div><div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        pl_m.append(pl_[~np.isnan(pl_)])</div><div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;</div><div class="line"><a name="l02120"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9be53919db9a6c9df647114f8ddf867d"> 2120</a></span>&#160;    minus_for_ttest=pl_m</div><div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;    pl_m = list(filter(len,pl_m))</div><div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;    all_ttest_first_vs_last_minus.append(scipy.stats.ttest_ind(pl_m[0],pl_m[-2]))</div><div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;</div><div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;    n_all_ttest_first_vs_last_minus.append((len(pl_m[0]),len(pl_m[-2]) ))</div><div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;</div><div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;</div><div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;    anova_1 = scipy.stats.f_oneway(*pl_m)    </div><div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;</div><div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;</div><div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;    idx2=[]</div><div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    idx1=[]</div><div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;    <span class="keywordflow">for</span> ii,pl_ <span class="keywordflow">in</span> enumerate(pl_m):</div><div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160;        idx2.append([ii]*len(pl_))</div><div class="line"><a name="l02134"></a><span class="lineno"> 2134</span>&#160;        idx1.append(pl_)</div><div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;</div><div class="line"><a name="l02136"></a><span class="lineno"> 2136</span>&#160;    idx2=np.hstack(idx2)   </div><div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    idx1= np.hstack(idx1)      </div><div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;</div><div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    all_rs_minus.append(scipy.stats.pearsonr(idx2, idx1))</div><div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;    all_anova_minus.append((anova_1.statistic,anova_1.pvalue))</div><div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;</div><div class="line"><a name="l02142"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7fff4e8ed8b2deb43dc67e5e4854340a"> 2142</a></span>&#160;    ttes_tmp=[]</div><div class="line"><a name="l02143"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad9e822f7902dd3cce336707939601903"> 2143</a></span>&#160;    n_ttest_tmp=[]</div><div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;    <span class="keywordflow">for</span> pls,mns <span class="keywordflow">in</span> zip(plus_for_ttest,minus_for_ttest):</div><div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;        print((1))</div><div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;        ttes_tmp.append(scipy.stats.ttest_ind(pls,mns))</div><div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;        n_ttest_tmp.append((len(pls),len(mns)))</div><div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;</div><div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;    all_ttest_plus_vs_minus.append(ttes_tmp)</div><div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    n_all_ttest_plus_vs_minus.append(n_ttest_tmp)</div><div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;<span class="comment">#    X = sm.add_constant(idx2, prepend=False)</span></div><div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160;<span class="comment">#    y=idx1</span></div><div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;<span class="comment">#    model=sm.OLS(y,X)</span></div><div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;<span class="comment">#    results=model.fit()</span></div><div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;<span class="comment">#    print results.summary()</span></div><div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;</div><div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;</div><div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160;</div><div class="line"><a name="l02159"></a><span class="lineno"> 2159</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;pl.figure()</div><div class="line"><a name="l02161"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a7e578341f85bc42faf7d4b5ba2a3c0b4"> 2161</a></span>&#160;pl.errorbar(bins[1:],np.mean(all_traces_mean,0)[:,0],np.std(all_traces_mean,0)[:,0],linewidth=2)</div><div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;pl.errorbar(bins[1:],np.mean(all_traces_mean,0)[:,1],np.std(all_traces_mean,0)[:,1],linewidth=2)</div><div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;pl.legend([<span class="stringliteral">&#39;CR+&#39;</span>,<span class="stringliteral">&#39;CR-&#39;</span>],loc=4)</div><div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;pl.xlabel(group_var)</div><div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;pl.ylabel(<span class="stringliteral">&#39;DF/F&#39;</span>)</div><div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;<span class="comment">#%% size effects</span></div><div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;old_div((np.mean(all_traces_mean,0)[:,0] - np.mean(all_traces_mean,0)[:,1]),np.sqrt(.5*np.var(all_traces_mean,0)[:,0]+ .5*np.var(all_traces_mean,0)[:,1]))</div><div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;print((np.mean(all_traces_mean,0)[:,0])) </div><div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;print((np.mean(all_traces_mean,0)[:,1]))</div><div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;print((np.std(all_traces_mean,0)[:,0]))</div><div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;print((np.std(all_traces_mean,0)[:,1]))</div><div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;</div><div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160;<span class="comment">#%% r coeff</span></div><div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160;print((np.mean(all_rs_plus,0))) </div><div class="line"><a name="l02175"></a><span class="lineno"> 2175</span>&#160;print((np.std(all_rs_plus,0))) </div><div class="line"><a name="l02176"></a><span class="lineno"> 2176</span>&#160;</div><div class="line"><a name="l02177"></a><span class="lineno"> 2177</span>&#160;</div><div class="line"><a name="l02178"></a><span class="lineno"> 2178</span>&#160;print((np.median(all_rs_plus,0))) </div><div class="line"><a name="l02179"></a><span class="lineno"> 2179</span>&#160;print((np.median(all_rs_minus,0)))   </div><div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160;</div><div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;print((np.median(all_anova_plus,0))) </div><div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;print((np.median(all_anova_minus,0)))   </div><div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160;</div><div class="line"><a name="l02184"></a><span class="lineno"> 2184</span>&#160;</div><div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;</div><div class="line"><a name="l02186"></a><span class="lineno"> 2186</span>&#160;print((<span class="stringliteral">&#39;p&lt;:&#39;</span>,np.percentile(np.array(all_rs_plus)[:,1],[50,25,75],0)))</div><div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;print((np.mean(np.array(all_rs_plus)[:,0],0),np.std(np.array(all_rs_plus)[:,0],0)))</div><div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;</div><div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;print((<span class="stringliteral">&#39;p&lt;:&#39;</span>,np.percentile(np.array(all_rs_minus)[:,1],[50,25,75],0)))</div><div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;print((np.mean(np.array(all_rs_minus)[:,0],0),np.std(np.array(all_rs_minus)[:,0],0)))</div><div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;</div><div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;</div><div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;print((np.nanpercentile(all_ttest_plus_vs_minus,[50,25,75],0).T))</div><div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;print((np.nanpercentile(n_all_ttest_plus_vs_minus,[50],0)))</div><div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;</div><div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;print((np.nanpercentile(all_ttest_first_vs_last_minus,[50,25,75],0).T))</div><div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;</div><div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;print((np.nanpercentile(n_all_ttest_first_vs_last_minus,[50],0).T))</div><div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;</div><div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;</div><div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;print((np.nanpercentile(all_ttest_first_vs_last_plus,[50,25,75],0).T))</div><div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;print((np.nanpercentile(n_all_ttest_first_vs_last_plus,[50],0).T))</div><div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;</div><div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;</div><div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;</div><div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;</div><div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;</div><div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;</div><div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;<span class="comment">#pl.subplot(2,1,1)     </span></div><div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;<span class="comment">#pl.hist(np.array(all_rs_plus).T[1],bins=np.arange(0,.6,.01))</span></div><div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;<span class="comment">#pl.xlabel(&#39;p-value&#39;)</span></div><div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;<span class="comment">#pl.ylabel(&#39;frequency count&#39;)</span></div><div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;<span class="comment">#pl.subplot(2,1,2)</span></div><div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;<span class="comment">#pl.hist(np.array(all_rs_plus).T[0],30)</span></div><div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;<span class="comment">#pl.xlabel(&#39;r coefficient&#39;)</span></div><div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;<span class="comment">#pl.ylabel(&#39;frequency count&#39;)</span></div><div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;<span class="comment">#pl.figure()</span></div><div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;<span class="comment">#pl.subplot(2,1,1)     </span></div><div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;<span class="comment">#pl.hist(np.array(all_rs_minus).T[1],bins=np.arange(0,.6,.01))</span></div><div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;<span class="comment">#pl.xlabel(&#39;p-value&#39;)</span></div><div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;<span class="comment">#pl.ylabel(&#39;frequency count&#39;)</span></div><div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;<span class="comment">#pl.subplot(2,1,2)</span></div><div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;<span class="comment">#pl.hist(np.array(all_rs_minus).T[0],30)</span></div><div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;<span class="comment">#pl.xlabel(&#39;r coefficient&#39;)</span></div><div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;<span class="comment">#pl.ylabel(&#39;frequency count&#39;)</span></div><div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;<span class="comment">#pl.rc(&#39;font&#39;, **font)</span></div><div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;<span class="comment">#%% compute stats for locomotion</span></div><div class="line"><a name="l02234"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0282845dc7326d9a5069ced6b0e0dde8"> 2234</a></span>&#160;idx_last_sessions = ( ((bh_correl_sel.mouse==<span class="stringliteral">&#39;b37&#39;</span>) &amp;  (bh_correl_sel.session == <span class="stringliteral">&#39;20160705103903&#39;</span>) &amp; (bh_correl_sel.chunk == <span class="stringliteral">&#39;121&#39;</span>)) |\</div><div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;b35&#39;</span>) &amp;  (bh_correl_sel.session == <span class="stringliteral">&#39;20160714143248&#39;</span>) &amp; (bh_correl_sel.chunk == <span class="stringliteral">&#39;061&#39;</span>)) |\</div><div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;AG051514-01&#39;</span>)) |\</div><div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;AG052014-01&#39;</span>)) |\</div><div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;<span class="comment">#                              ((bh_correl_sel.mouse==&#39;gc-AGGC6f-031213-03&#39;)) |\</span></div><div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>)) ) </div><div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;</div><div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;</div><div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160;</div><div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;</div><div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;<span class="comment">#bh_correl_tmp =  bh_correl_sel[idx_last_sessions].copy()    </span></div><div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160;bh_correl_tmp =  bh_correl_sel.copy()    </div><div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;<span class="comment">#print bh_correl_sel.groupby([&#39;mouse&#39;,&#39;session&#39;,&#39;chunk&#39;]).count().loc[[&#39;b37&#39;,&#39;b35&#39;]][&#39;ampl_eyelid_CSCSUS&#39;].describe()</span></div><div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;<span class="comment">#print bh_correl_sel.groupby([&#39;mouse&#39;]).count().loc[[&#39;gc-AGGC6f-031213-03&#39;, &#39;gc-AG052014-02&#39;,&#39;AG052014-01&#39;, &#39;AG051514-01&#39;]][&#39;ampl_eyelid_CSCSUS&#39;].describe()</span></div><div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;</div><div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;<span class="comment"># fund per mouse threshold</span></div><div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;thresh_wheel_corr&#39;</span>]=bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[<span class="stringliteral">&#39;r_wheel_fluo_rnd&#39;</span>].transform(<span class="keyword">lambda</span> x: x.quantile(.99))</div><div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;bh_correl_tmp=bh_correl_tmp[bh_correl_tmp.r_wheel_fluo &gt; .5]<span class="comment"># bh_correl_tmp.thresh_wheel_corr</span></div><div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;print((bh_correl_tmp.avg_activity_during_locomotion.describe()))</div><div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;print((bh_correl_tmp.avg_activity_during_locomotion.quantile(.99)))</div><div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;cr_ampl_m=cr_ampl_sel.copy()</div><div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160;</div><div class="line"><a name="l02257"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a168ec15e31cd794b26b32aa8050af095"> 2257</a></span>&#160;variable=<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span></div><div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;bins=[-1,.15,.4,1]</div><div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160;</div><div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;variable=<span class="stringliteral">&#39;perc_CR&#39;</span></div><div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;bins=[0, .15,  .4, 1]</div><div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160;</div><div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;<span class="comment">#grouped_session=cr_ampl_m.sort([&#39;perc_CR&#39;],ascending=True)</span></div><div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;<span class="comment">#cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;gc-AG052014-02&#39;]</span></div><div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;<span class="comment">#cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;AG052014-01&#39;]</span></div><div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;cr_ampl_m.dropna()</div><div class="line"><a name="l02270"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0fa44cbb109b8f0a0e2c64c77a70cfc7"> 2270</a></span>&#160;cuts=pd.cut(cr_ampl_m[variable],bins,include_lowest=<span class="keyword">True</span>)</div><div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;grouped_session=cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,cuts]) </div><div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;</div><div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;means=grouped_session.mean()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;sems=grouped_session.sem()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02275"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af7fd23d27b7f1f6c82c8cd53fcf8b8f5"> 2275</a></span>&#160;stds=grouped_session.sem()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02276"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a10c8c3e72533f5f324dcf742e02483d9"> 2276</a></span>&#160;counts=grouped_session.count()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;<span class="comment">#means.plot(by=&#39;perc_CR&#39;,kind=&#39;line&#39;,yerr=sems,marker =&#39;o&#39;,markersize=15)</span></div><div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;<span class="comment">#pl.xlim([-.1, 5.1])</span></div><div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;<span class="comment">#pl.legend([&#39;CR+&#39;,&#39;CR-&#39;],loc=2)</span></div><div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;<span class="comment">#pl.xlabel(&#39;Fraction of CRs&#39;)</span></div><div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;<span class="comment">#pl.ylabel(&#39;DF/F&#39;)</span></div><div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;pl.figure()</div><div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;ax=pl.gca()</div><div class="line"><a name="l02284"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf"> 2284</a></span>&#160;count=0</div><div class="line"><a name="l02285"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8a973f6b0dc47400d9d1d6df08a5bdc1"> 2285</a></span>&#160;mat_resp=[]</div><div class="line"><a name="l02286"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2d231ddca1511d613c3113bad4d81917"> 2286</a></span>&#160;mat_resp_std=[]</div><div class="line"><a name="l02287"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5b3ae93080deb3b0450862036fc42b2c"> 2287</a></span>&#160;mat_resp_count=[]</div><div class="line"><a name="l02288"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a096d9266cedf6334fd3d1cbe99ff9e82"> 2288</a></span>&#160;mat_resp_minus=[]</div><div class="line"><a name="l02289"></a><span class="lineno"> 2289</span>&#160;</div><div class="line"><a name="l02290"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad2d34788c675f9cefd8deae2d988eb2b"> 2290</a></span>&#160;resp_pd=pd.DataFrame()</div><div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160;<span class="keywordflow">for</span> mse <span class="keywordflow">in</span> means.index.get_level_values(0).unique():</div><div class="line"><a name="l02292"></a><span class="lineno"> 2292</span>&#160;    count+=1</div><div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="comment">#    ax=pl.subplot(5,1,count)    </span></div><div class="line"><a name="l02294"></a><span class="lineno"> 2294</span>&#160;    mat_resp_minus.append( means.loc[mse][<span class="stringliteral">&#39;fluo_minus&#39;</span>].values)</div><div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;</div><div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    mat_resp.append(means.loc[mse][<span class="stringliteral">&#39;fluo_plus&#39;</span>].values)</div><div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    mat_resp_std.append( stds.loc[mse][<span class="stringliteral">&#39;fluo_plus&#39;</span>].values)</div><div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;    mat_resp_count.append( counts.loc[mse][<span class="stringliteral">&#39;fluo_plus&#39;</span>].values)</div><div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;</div><div class="line"><a name="l02300"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae3588d6b8a60b8198aced11bfe3f2126"> 2300</a></span>&#160;    means.loc[mse][<span class="stringliteral">&#39;fluo_plus&#39;</span>].plot(ax=ax,marker=<span class="stringliteral">&#39;o&#39;</span>,markersize=15,label=mse,yerr=sems.loc[mse][<span class="stringliteral">&#39;fluo_plus&#39;</span>])      </div><div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;</div><div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;</div><div class="line"><a name="l02303"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2af5c662cab479e5471ca76326a57563"> 2303</a></span>&#160;fg=pl.figure(<span class="stringliteral">&#39;MEDIAN&#39;</span>)</div><div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;ax=pl.gca()</div><div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;</div><div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;mat_resp_count=np.array(mat_resp_count)</div><div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;mat_resp_std=np.array(mat_resp_std)</div><div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;mat_resp=np.array(mat_resp)</div><div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;mat_resp_minus=np.array(mat_resp_minus)</div><div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;</div><div class="line"><a name="l02311"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#afe9c1a6ce362223bae2fb7e913d4413d"> 2311</a></span>&#160;fluo_cr_plus_pd=pd.DataFrame(mat_resp.T,index=cuts.unique())</div><div class="line"><a name="l02312"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a882af24baa4611fbc853c0b9bcc00b3e"> 2312</a></span>&#160;fluo_cr_minus_pd=pd.DataFrame(mat_resp_minus.T,index=cuts.unique())</div><div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;</div><div class="line"><a name="l02314"></a><span class="lineno"> 2314</span>&#160;fluo_cr_plus_pd.median(1).plot(marker=<span class="stringliteral">&#39;o&#39;</span>,yerr=fluo_cr_plus_pd.mad(1))</div><div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;fluo_cr_minus_pd.median(1).plot(marker=<span class="stringliteral">&#39;o&#39;</span>,yerr=fluo_cr_minus_pd.mad(1))</div><div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;</div><div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160;pl.xlim([-.5,len(cuts.unique())+.1])</div><div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;pl.xticks(np.arange(len(cuts.unique())),cuts.unique())</div><div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;</div><div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160;fg=pl.figure(<span class="stringliteral">&#39;MEAN&#39;</span>)</div><div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;ax=pl.gca()</div><div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;</div><div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;fluo_cr_plus_pd.mean(1).plot(marker=<span class="stringliteral">&#39;o&#39;</span>,yerr=fluo_cr_plus_pd.sem(1))</div><div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;fluo_cr_minus_pd.mean(1).plot(marker=<span class="stringliteral">&#39;o&#39;</span>,yerr=fluo_cr_minus_pd.sem(1))</div><div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;pl.xlim([-.5,len(cuts.unique())+.1])</div><div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;pl.xticks(np.arange(len(cuts.unique())),cuts.unique())</div><div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;pl.xlabel(<span class="stringliteral">&#39;amplitude of CR&#39;</span>)</div><div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;</div><div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;pl.figure()</div><div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;idx1,idx2=np.where(~np.isnan(mat_resp))</div><div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;print((scipy.stats.pearsonr(idx2, mat_resp[idx1,idx2].flatten())))</div><div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;pl.scatter(idx2, mat_resp[idx1,idx2].flatten())</div><div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;</div><div class="line"><a name="l02334"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae40354a1051342eb5a9db005715dcfa9"> 2334</a></span>&#160;idx=np.where(~np.isnan(np.nanmean(mat_resp_std,0)))[0]</div><div class="line"><a name="l02335"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0c6fc0bbc72e40e86969e3db15926ab4"> 2335</a></span>&#160;m_std = [ m[~np.isnan(m)] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> mat_resp_std.T[idx]]</div><div class="line"><a name="l02336"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a69bf82b234d615788037db287191cafe"> 2336</a></span>&#160;m_count = [ m[~np.isnan(m)] <span class="keywordflow">for</span> mok <span class="keywordflow">in</span> mat_resp_count.T[idx]]</div><div class="line"><a name="l02337"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a67923833b8a2af86d745484951c622c9"> 2337</a></span>&#160;m_mean = [ m[~np.isnan(m)] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> mat_resp.T[idx]]</div><div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;<span class="comment">#print scipy.stats.f_oneway(*m)</span></div><div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;</div><div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;</div><div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;<span class="comment">#pluss=grouped_session.apply(lambda x: x[[&#39;fluo_plus&#39;]].values).values</span></div><div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;<span class="comment">#pl_m=[]</span></div><div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;<span class="comment">#for pl_ in pluss:</span></div><div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160;<span class="comment">#    pl_=np.array(pl_)</span></div><div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="comment">#    pl_m.append(pl_[~np.isnan(pl_)])</span></div><div class="line"><a name="l02346"></a><span class="lineno"> 2346</span>&#160;</div><div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;print((scipy.stats.f_oneway(*m_mean)))  </div><div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;<span class="keyword">import</span> statsmodels.api <span class="keyword">as</span> sm</div><div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;print((grouped_session.count()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]))</div><div class="line"><a name="l02351"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6f4fd396b94e5b0aba3e345d52966088"> 2351</a></span>&#160;sign_test = scipy.stats.ttest_ind_from_stats(grouped_session.mean()[<span class="stringliteral">&#39;fluo_plus&#39;</span>],grouped_session.std()[<span class="stringliteral">&#39;fluo_plus&#39;</span>],grouped_session.count()[<span class="stringliteral">&#39;fluo_plus&#39;</span>],grouped_session.mean()[<span class="stringliteral">&#39;fluo_minus&#39;</span>],grouped_session.std()[<span class="stringliteral">&#39;fluo_minus&#39;</span>],grouped_session.count()[<span class="stringliteral">&#39;fluo_minus&#39;</span>],equal_var=<span class="keyword">False</span>)</div><div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160;sign_test[1]</div><div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;sign_test</div><div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;X = sm.add_constant(idx2, prepend=<span class="keyword">False</span>)</div><div class="line"><a name="l02356"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a85c9a6647898bbc94de1619f3318ba8f"> 2356</a></span>&#160;y=mat_resp[idx1,idx2].flatten()</div><div class="line"><a name="l02357"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a508cc3106d2c29fe07dc87cbe3ea6927"> 2357</a></span>&#160;model=sm.OLS(y,X)</div><div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;results=model.fit()</div><div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;results.summary()</div><div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;<span class="comment">#grouped_session.mean()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]</span></div><div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160;<span class="comment">#id1=2</span></div><div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="comment">#id2=3</span></div><div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;<span class="comment">#pd.concat([grouped_session.mean()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]],grouped_session.std()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]],grouped_session.count()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]],axis=1,keys=[&#39;mean_&#39;,&#39;std_&#39;,&#39;count_&#39;])</span></div><div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;<span class="comment">#mouse_stats=pd.concat([grouped_session.mean()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]],grouped_session.std()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]],grouped_session.count()[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]]],axis=1,keys=[&#39;mean_&#39;,&#39;std_&#39;,&#39;count_&#39;]).loc[&#39;AG051514-01&#39;]</span></div><div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;<span class="comment">#scipy.stats.ttest_ind_from_stats(0.349052,0.208635,120.0,0.148381,0.142751,420.0, equal_var=False)[1]</span></div><div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;</div><div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;</div><div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;cr_ampl_m=cr_ampl_sel.copy()</div><div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;<span class="comment">#variable=&#39;ampl_eyelid_CSCSUS&#39;</span></div><div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;<span class="comment">#bins=[-1,.15,.4,1]</span></div><div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;</div><div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;variable=<span class="stringliteral">&#39;learning_phase&#39;</span></div><div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;bins=[0,.1,1,2,3]</div><div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="comment">#variable=&#39;perc_CR&#39;</span></div><div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;<span class="comment">#bins=[0, .15,  .4, .8, 1]</span></div><div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;</div><div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;<span class="comment">#grouped_session=cr_ampl_m.sort([&#39;perc_CR&#39;],ascending=True)</span></div><div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]</div><div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;<span class="comment">#cr_ampl_m=cr_ampl_m[cr_ampl_m.mouse!=&#39;AG052014-01&#39;]</span></div><div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;cr_ampl_m.dropna()</div><div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;cuts=pd.cut(cr_ampl_m[variable],bins,include_lowest=<span class="keyword">True</span>)</div><div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;grouped_session=cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,cuts]) </div><div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;</div><div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;means=grouped_session.mean()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;sems=grouped_session.sem()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;<span class="comment">#%%  create excel file</span></div><div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;</div><div class="line"><a name="l02395"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abf9b27b9c092d534307cd90c7566939f"> 2395</a></span>&#160;fluo_whichs = [<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]</div><div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;</div><div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;<span class="keywordflow">for</span> fluo_which <span class="keywordflow">in</span> fluo_whichs:</div><div class="line"><a name="l02398"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab462494acb3894fee8e680bb0057d319"> 2398</a></span>&#160;    writer = pd.ExcelWriter(<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/dropbox/&#39;</span>+fluo_which+<span class="stringliteral">&#39;_mean.xlsx&#39;</span>)</div><div class="line"><a name="l02399"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4662347feefed1b2f1ade4ea91bc7434"> 2399</a></span>&#160;    ddff = pd.DataFrame(cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>,<span class="stringliteral">&#39;chunk&#39;</span>,cuts]).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()[[fluo_which]].dropna()).to_excel(writer)</div><div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;    writer.close()</div><div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160;</div><div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;    writer = pd.ExcelWriter(<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/dropbox/&#39;</span>+fluo_which+<span class="stringliteral">&#39;_std.xlsx&#39;</span>)</div><div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;    ddff = pd.DataFrame(cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>,<span class="stringliteral">&#39;chunk&#39;</span>,cuts]).std()[[fluo_which]].dropna()).to_excel(writer)</div><div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;    writer.close()</div><div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;</div><div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;    writer = pd.ExcelWriter(<span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/dropbox/&#39;</span>+fluo_which+<span class="stringliteral">&#39;_count.xlsx&#39;</span>)</div><div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;    ddff=pd.DataFrame(cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;session&#39;</span>,<span class="stringliteral">&#39;chunk&#39;</span>,cuts]).<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()[fluo_which].dropna())</div><div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;    ddff[ddff[fluo_which]&gt;0].to_excel(writer)</div><div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;    writer.close()</div><div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;</div><div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;<span class="comment">#cr_ampl_m=cr_ampl_sel</span></div><div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;</div><div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;</div><div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;</div><div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;<span class="comment">#cr_ampl_m=cr_ampl_sel</span></div><div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;<span class="comment">#bins=[0, .2,  .4, .9, 1]</span></div><div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;<span class="comment">#bins=[0,.15,.4,1]</span></div><div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;</div><div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;</div><div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;</div><div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;</div><div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160;</div><div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;<span class="comment">#pl.errorbar(np.arange(5),np.nanmedian(mat_resp,0),mad(mat_resp,0),&#39;o&#39;) </span></div><div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;</div><div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;<span class="comment">#for mse in means.index.get_level_values(0).unique():</span></div><div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;<span class="comment">#    count+=1</span></div><div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;</div><div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;</div><div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;<span class="comment">#bins=np.arange(0,1,.05)</span></div><div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;</div><div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160;</div><div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;</div><div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;bh_correl_tmp=bh_correl_sel.copy()</div><div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;<span class="keywordflow">for</span> r_ <span class="keywordflow">in</span> bh_correl_tmp.keys()[bh_correl_tmp.keys().str.contains(<span class="stringliteral">&#39;r_.*rnd&#39;</span>)]:</div><div class="line"><a name="l02552"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a6425221f9d7655b240931750baaeb816"> 2552</a></span>&#160;    borders_low=bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[r_].quantile(.05)</div><div class="line"><a name="l02553"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a46eaf717a7edc5f4e98a6820d678ab6c"> 2553</a></span>&#160;    borders_high=bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[r_].quantile(.95)</div><div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;</div><div class="line"><a name="l02555"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a574732c04d57514f219fc914fdcb54e5"> 2555</a></span>&#160;    pl.figure(r_[2:-9],figsize=(14,14))</div><div class="line"><a name="l02556"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae53bca40fb518758f22beae48898d394"> 2556</a></span>&#160;    bh_correl_tmp[r_[:-4]].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>,ax=pl.gca())</div><div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;</div><div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160;    <span class="keywordflow">for</span> count,b_l,b_h <span class="keywordflow">in</span> zip(list(range(len(borders_low))),borders_low,borders_high):    </div><div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;        pl.subplot(3,2,count+1)    </div><div class="line"><a name="l02560"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a682c0ad28385d09ab3ad84efd3218b86"> 2560</a></span>&#160;        mx=pl.gca().get_ylim()[-1]</div><div class="line"><a name="l02561"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1e65ad649a2a537e0c9920637bd68272"> 2561</a></span>&#160;        pl.fill_between([b_l,b_h],[0,0],[mx,mx],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;        pl.xlabel(<span class="stringliteral">&#39;correlation&#39;</span>)</div><div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;        pl.ylabel(<span class="stringliteral">&#39;frequency&#39;</span>)</div><div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160;<span class="comment">#        pl.xlim([0,None])</span></div><div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;        pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;<span class="comment">#        pl.savefig(&#39;hist_&#39;+r_[:-4]+&#39;.pdf&#39;)</span></div><div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;</div><div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;    pl.legend([<span class="stringliteral">&#39;measured&#39;</span>,<span class="stringliteral">&#39;shuffled&#39;</span>])</div><div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;    pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;<span class="comment">#%% show the reponses of neurons to each of the conditions</span></div><div class="line"><a name="l02571"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8d660e4c73c7c34ce5ac14204bc34358"> 2571</a></span>&#160;results_corr=pd.DataFrame()</div><div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;bh_correl_tmp=bh_correl_sel.copy()</div><div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;bh_correl_tmp=bh_correl_tmp[bh_correl_tmp[<span class="stringliteral">&#39;learning_phase&#39;</span>]&gt;=0].copy()</div><div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;<span class="keywordflow">for</span> r_ <span class="keywordflow">in</span> bh_correl_tmp.keys()[bh_correl_tmp.keys().str.contains(<span class="stringliteral">&#39;r_.*rnd&#39;</span>)]:</div><div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;<span class="comment">#    print bh_correl_tmp.fillna(method=&#39;pad&#39;).groupby(&#39;mouse&#39;)[r_].quantile(.95).values</span></div><div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;    bh_correl_tmp[r_]=bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[r_].transform(<span class="keyword">lambda</span> x: x.quantile(.99))</div><div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;    bh_correl_tmp[r_[:-4]]=bh_correl_tmp[r_[:-4]]-bh_correl_tmp[r_]</div><div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160;<span class="comment">#    print bh_correl_tmp.fillna(method=&#39;pad&#39;).groupby(&#39;mouse&#39;)[r_].quantile(.95).values.T</span></div><div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;    results_corr=pd.concat([results_corr,bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[r_[:-4]].agg({r_[2:-9]:<span class="keyword">lambda</span> x: np.nanmean(x&gt;=0)})],axis=1)</div><div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;<span class="comment">#%% CHOOSE LAST SESSIONS</span></div><div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160;results_corr=pd.DataFrame()</div><div class="line"><a name="l02582"></a><span class="lineno"> 2582</span>&#160;<span class="comment">#bh_correl_tmp=bh_correl.fillna(method=&#39;pad&#39;)[(bh_correl.session_id==8.0)  | (np.isnan(bh_correl.session_id))  | ((bh_correl.mouse==&#39;b35&#39;) &amp; (bh_correl.session==&#39;20160714143248&#39;) &amp; (bh_correl.chunk==&#39;061&#39;)) &amp; (bh_correl.mouse!=&#39;b35&#39;)]</span></div><div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;idx_last_sessions = ( ((bh_correl_sel.mouse==<span class="stringliteral">&#39;b37&#39;</span>) &amp;  (bh_correl_sel.session == <span class="stringliteral">&#39;20160705103903&#39;</span>) &amp; (bh_correl_sel.chunk == <span class="stringliteral">&#39;121&#39;</span>)) |\</div><div class="line"><a name="l02584"></a><span class="lineno"> 2584</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;b35&#39;</span>) &amp;  (bh_correl_sel.session == <span class="stringliteral">&#39;20160714143248&#39;</span>) &amp; (bh_correl_sel.chunk == <span class="stringliteral">&#39;061&#39;</span>)) |\</div><div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;AG051514-01&#39;</span>)) |\</div><div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;AG052014-01&#39;</span>)) |\</div><div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;<span class="comment">#                              ((bh_correl_sel.mouse==&#39;gc-AGGC6f-031213-03&#39;)) |\</span></div><div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;                              ((bh_correl_sel.mouse==<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>)) ) </div><div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;</div><div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;</div><div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;</div><div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;</div><div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;bh_correl_tmp =  bh_correl_sel[idx_last_sessions].copy()           </div><div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;<span class="keywordflow">for</span> r_ <span class="keywordflow">in</span> bh_correl_tmp.keys()[bh_correl_tmp.keys().str.contains(<span class="stringliteral">&#39;r_.*rnd&#39;</span>)]:</div><div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;<span class="comment">#    print bh_correl_tmp.fillna(method=&#39;pad&#39;).groupby(&#39;mouse&#39;)[r_].quantile(.95).values</span></div><div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160;    bh_correl_tmp[r_]=bh_correl_tmp.fillna(method=<span class="stringliteral">&#39;pad&#39;</span>).groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[r_].transform(<span class="keyword">lambda</span> x: x.quantile(.99))</div><div class="line"><a name="l02597"></a><span class="lineno"> 2597</span>&#160;    bh_correl_tmp[r_[:-4]]=bh_correl_tmp[r_[:-4]]-bh_correl_tmp[r_]</div><div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;</div><div class="line"><a name="l02599"></a><span class="lineno"> 2599</span>&#160;<span class="comment">#    print bh_correl_tmp.fillna(method=&#39;pad&#39;).groupby(&#39;mouse&#39;)[r_].quantile(.95).values.T</span></div><div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;    <span class="comment">#results_corr=pd.concat([results_corr,bh_correl_tmp.fillna(method=&#39;pad&#39;).groupby(&#39;mouse&#39;)[r_[:-4]].agg({r_[2:-9]:lambda x: np.nanmean(x&gt;=0)})],axis=1)</span></div><div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;<span class="comment">#from collections import Counter    </span></div><div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;<span class="comment">#last_sessions = bh_correl_tmp.copy()    </span></div><div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;</div><div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160;</div><div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;<span class="comment">#    df = pd.DataFrame.from_dict(counts, orient=&#39;index&#39;)</span></div><div class="line"><a name="l02615"></a><span class="lineno"> 2615</span>&#160;<span class="comment">#    df.plot(kind=&#39;bar&#39;)</span></div><div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02617"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a70281704bcda9afefdd3cfb4f5465899"> 2617</a></span>&#160;probabilities = pd.DataFrame(index=[<span class="stringliteral">&#39;CR&#39;</span>,<span class="stringliteral">&#39;NOSE&#39;</span>,<span class="stringliteral">&#39;WHEEL&#39;</span>,<span class="stringliteral">&#39;UR&#39;,&#39;</span>Unrelated&#39;]);</div><div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160;<span class="keywordflow">for</span> mouse <span class="keywordflow">in</span>  bh_correl_tmp.mouse.unique():</div><div class="line"><a name="l02619"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4391d1ae185d97692dbee8c8d6bc50ef"> 2619</a></span>&#160;    last_sessions = bh_correl_tmp[bh_correl_tmp.mouse==mouse]    </div><div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160;    last_sessions = last_sessions.sort_values([<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>])[[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>,<span class="stringliteral">&#39;r_nose_fluo&#39;</span>,<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>,<span class="stringliteral">&#39;r_UR_eye_fluo&#39;</span>]].values</div><div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;</div><div class="line"><a name="l02622"></a><span class="lineno"> 2622</span>&#160;</div><div class="line"><a name="l02623"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a59ca6ee91e634e1c4a26523f47ec4ab6"> 2623</a></span>&#160;    thresh_corr=0</div><div class="line"><a name="l02624"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0721462b7492f88cd46c2a7f2cac1bd1"> 2624</a></span>&#160;    thresh_corr_neg=1</div><div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;    idx=np.min(last_sessions,1)&gt;-thresh_corr_neg</div><div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;    last_sessions=last_sessions[idx]</div><div class="line"><a name="l02627"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8fb705a07fcb2669a4081c22f9ef7bad"> 2627</a></span>&#160;    bests=np.argmax(last_sessions,1)</div><div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;    bests[np.max(last_sessions,1)&lt;=thresh_corr]=4</div><div class="line"><a name="l02629"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad2a1f6ba2a0c3706e50b096d546050cd"> 2629</a></span>&#160;    best_cr=last_sessions[(last_sessions[:,0]&gt;thresh_corr) &amp; (bests==0)].T</div><div class="line"><a name="l02630"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a18475e81961c0ffd7394c5210fcbac0f"> 2630</a></span>&#160;    best_nose=last_sessions[(last_sessions[:,1]&gt;thresh_corr) &amp; (bests==1)].T</div><div class="line"><a name="l02631"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4058b2e20a15a0f1098c601b0e71c2b3"> 2631</a></span>&#160;    best_wheel=last_sessions[(last_sessions[:,2]&gt;thresh_corr) &amp; (bests==2)].T</div><div class="line"><a name="l02632"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a38a59d49aa264e262d593f49c4c05e24"> 2632</a></span>&#160;    best_ur=last_sessions[(last_sessions[:,3]&gt;thresh_corr) &amp; (bests==3)].T</div><div class="line"><a name="l02633"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abb9fb3248ce2fbecb7e63bb0e86cee7d"> 2633</a></span>&#160;    unrelated=last_sessions[bests==4].T</div><div class="line"><a name="l02634"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ab576f2833643122ac1119788894468bc"> 2634</a></span>&#160;    all_neuron=len(last_sessions)</div><div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;</div><div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;<span class="comment">#    pl.bar([0,1,2,3,4],np.array([len(best_cr.T),len(best_nose.T),len(best_wheel.T),len(best_ur.T),len(unrelated.T)])*1./all_neuron,width=[-.1])</span></div><div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160;<span class="comment">#    pl.xlim([-.5,4.5])     </span></div><div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;<span class="comment">#    pl.xticks([0,1,2,3,4],[&#39;cr&#39;,&#39;nose&#39;,&#39;wheel&#39;,&#39;ur&#39;,&#39;unrelated&#39;])   </span></div><div class="line"><a name="l02639"></a><span class="lineno"> 2639</span>&#160;<span class="comment">#    pl.title(&#39;All significant cells&#39;)</span></div><div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    probabilities[mouse]=(np.array([len(best_cr.T),len(best_nose.T),len(best_wheel.T),len(best_ur.T),len(unrelated.T)])*1./all_neuron).T</div><div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;</div><div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;pl.subplot(3,1,1)</div><div class="line"><a name="l02643"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#accc088009d44c521706aa98d6387ee21"> 2643</a></span>&#160;probabilities.mean(axis=1).plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,yerr=probabilities.sem(axis=1))</div><div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;pl.title(<span class="stringliteral">&#39;All mice (N=5)&#39;</span>)</div><div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;pl.subplot(3,1,2)</div><div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;<span class="comment">#probabilities[[&#39;b37&#39;,&#39;gc-AGGC6f-031213-03&#39;,&#39;AG052014-01&#39;,&#39;AG051514-01&#39;]].mean(axis=1).plot(kind=&#39;bar&#39;,yerr=probabilities.sem(axis=1))</span></div><div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>,<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(axis=1).plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,yerr=probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>,<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]].sem(axis=1))</div><div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;</div><div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;pl.title(<span class="stringliteral">&#39;Only responding &gt; 30 % (N=4)&#39;</span>)</div><div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;pl.subplot(3,1,3)</div><div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;<span class="comment">#probabilities[[&#39;b37&#39;,&#39;gc-AGGC6f-031213-03&#39;,&#39;AG052014-01&#39;,&#39;AG051514-01&#39;]].mean(axis=1).plot(kind=&#39;bar&#39;,yerr=probabilities.sem(axis=1))</span></div><div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>]].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(axis=1).plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,yerr=probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>]].sem(axis=1))</div><div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;</div><div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Probability in each FOV&#39;</span>)</div><div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;pl.title(<span class="stringliteral">&#39;Only responding &gt; 60 %(N=3)&#39;</span>)</div><div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;pl.subplot(5,1,1)</div><div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;</div><div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;all_neuron=len(last_sessions)</div><div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;</div><div class="line"><a name="l02661"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5558ace5433f9aabbf0a0ec059900d94"> 2661</a></span>&#160;pl.bar([0,1,2,3,4],np.array([len(best_cr.T),len(best_nose.T),len(best_wheel.T),len(best_ur.T),len(unrelated.T)])*1./all_neuron,width=[-.1])</div><div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;pl.xlim([-.5,4.5])     </div><div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;pl.xticks([0,1,2,3,4],[<span class="stringliteral">&#39;cr&#39;</span>,<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;wheel&#39;</span>,<span class="stringliteral">&#39;ur&#39;,&#39;</span>unrelated&#39;])   </div><div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160;pl.title(<span class="stringliteral">&#39;All significant cells&#39;</span>)</div><div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02666"></a><span class="lineno"> 2666</span>&#160;</div><div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="comment">#%%    </span></div><div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;<span class="comment">#last_sessions = bh_correl_tmp    </span></div><div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;<span class="comment">#last_sessions = last_sessions.sort_values([&#39;r_CR_eye_fluo&#39;])[[&#39;r_CR_eye_fluo&#39;,&#39;r_nose_fluo&#39;,&#39;r_wheel_fluo&#39;,&#39;r_UR_eye_fluo&#39;]].values</span></div><div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;<span class="comment">#pl.figure()</span></div><div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;<span class="comment">#thresh_corr=0</span></div><div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;<span class="comment">#thresh_corr_neg=1</span></div><div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;<span class="comment">#idx=np.min(last_sessions,1)&gt;-thresh_corr_neg</span></div><div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;<span class="comment">#last_sessions=last_sessions[idx]</span></div><div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160;<span class="comment">#bests=np.argmax(last_sessions,1)</span></div><div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="comment">#bests[np.max(last_sessions,1)&lt;=thresh_corr]=4</span></div><div class="line"><a name="l02678"></a><span class="lineno"> 2678</span>&#160;<span class="comment">#best_cr=last_sessions[(last_sessions[:,0]&gt;thresh_corr) &amp; (bests==0)].T</span></div><div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;<span class="comment">#best_nose=last_sessions[(last_sessions[:,1]&gt;thresh_corr) &amp; (bests==1)].T</span></div><div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="comment">#best_wheel=last_sessions[(last_sessions[:,2]&gt;thresh_corr) &amp; (bests==2)].T</span></div><div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;<span class="comment">#best_ur=last_sessions[(last_sessions[:,3]&gt;thresh_corr) &amp; (bests==3)].T</span></div><div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;<span class="comment">#unrelated=last_sessions[bests==4].T</span></div><div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;</div><div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;</div><div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;pl.subplot(5,1,1)</div><div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;</div><div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;<span class="comment">#all_neuron=len(last_sessions)</span></div><div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;</div><div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160;<span class="comment">#pl.bar([0,1,2,3,4],np.array([len(best_cr.T),len(best_nose.T),len(best_wheel.T),len(best_ur.T),len(unrelated.T)])*1./all_neuron,width=[-.1])</span></div><div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;</div><div class="line"><a name="l02691"></a><span class="lineno"> 2691</span>&#160;<span class="comment">#probabilities.mean(axis=1).plot(kind=&#39;bar&#39;,yerr=probabilities.sem(axis=1))</span></div><div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;<span class="comment">#probabilities[[&#39;b35&#39;,&#39;b37&#39;,&#39;AG052014-01&#39;,&#39;AG051514-01&#39;,&#39;gc-AG052014-02&#39;]].mean(axis=1).plot(kind=&#39;bar&#39;,yerr=probabilities[[&#39;b35&#39;,&#39;b37&#39;,&#39;AG052014-01&#39;,&#39;AG051514-01&#39;,&#39;gc-AG052014-02&#39;]].sem(axis=1))</span></div><div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>,<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>(axis=1).plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,yerr=probabilities[[<span class="stringliteral">&#39;b37&#39;</span>,<span class="stringliteral">&#39;AG052014-01&#39;</span>,<span class="stringliteral">&#39;AG051514-01&#39;</span>,<span class="stringliteral">&#39;gc-AG052014-02&#39;</span>]].sem(axis=1))</div><div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;</div><div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160;</div><div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;pl.xlim([-.5,4.5])     </div><div class="line"><a name="l02697"></a><span class="lineno"> 2697</span>&#160;pl.xticks([0,1,2,3,4],[<span class="stringliteral">&#39;cr&#39;</span>,<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;wheel&#39;</span>,<span class="stringliteral">&#39;ur&#39;,&#39;</span>unrelated&#39;])   </div><div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;pl.title(<span class="stringliteral">&#39;All significant cells&#39;</span>)</div><div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;</div><div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;</div><div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;<span class="comment">#last_sessions= bh_correl_tmp_tmp.fillna(method=&#39;pad&#39;)[(bh_correl_tmp.session_id==8.0)  | (np.isnan(bh_correl_tmp.session_id))  | ((bh_correl_tmp.mouse==&#39;b35&#39;) &amp; (bh_correl_tmp.session==&#39;20160714143248&#39;) &amp; (bh_correl_tmp.chunk==&#39;061&#39;))]    </span></div><div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;<span class="comment">#last_sessions=bh_correl.fillna(method=&#39;pad&#39;)[(bh_correl.session_id==8.0)  | (np.isnan(bh_correl.session_id))  | ((bh_correl.mouse==&#39;b35&#39;) &amp; (bh_correl.session==&#39;20160714143248&#39;) &amp; (bh_correl.chunk==&#39;061&#39;))]</span></div><div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;last_sessions=bh_correl_sel[idx_last_sessions].copy().fillna(method=<span class="stringliteral">&#39;pad&#39;</span>)</div><div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;last_sessions.groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[<span class="stringliteral">&#39;perc_CR&#39;</span>].<a class="code" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>()</div><div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;last_sessions = last_sessions.sort_values([<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>])[[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>,<span class="stringliteral">&#39;r_nose_fluo&#39;</span>,<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>,<span class="stringliteral">&#39;r_UR_eye_fluo&#39;</span>]].values</div><div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;thresh_corr=0.2</div><div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;thresh_corr_neg=.3</div><div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;idx=np.min(last_sessions,1)&gt;-thresh_corr_neg</div><div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;last_sessions=last_sessions[idx]</div><div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;bests=np.argmax(last_sessions,1)</div><div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;bests[np.max(last_sessions,1)&lt;=thresh_corr]=4</div><div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;best_cr=last_sessions[(last_sessions[:,0]&gt;thresh_corr) &amp; (bests==0)].T</div><div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;best_nose=last_sessions[(last_sessions[:,1]&gt;thresh_corr) &amp; (bests==1)].T</div><div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;best_wheel=last_sessions[(last_sessions[:,2]&gt;thresh_corr) &amp; (bests==2)].T</div><div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;best_ur=last_sessions[(last_sessions[:,3]&gt;thresh_corr) &amp; (bests==3)].T</div><div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;unrelated=last_sessions[bests==4].T</div><div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;</div><div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;</div><div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;pl.subplot(5,1,2)</div><div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;pl.plot(best_cr,<span class="stringliteral">&#39;o-&#39;</span>,color=<span class="stringliteral">&#39;lightgray&#39;</span>,linewidth=1)</div><div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160;pl.title(<span class="stringliteral">&#39;CR best&#39;</span>)</div><div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;pl.xlim([-.5,4.5])</div><div class="line"><a name="l02723"></a><span class="lineno"> 2723</span>&#160;pl.ylim([-thresh_corr_neg, .8])</div><div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Pearson\&#39;s r&#39;</span>)</div><div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;</div><div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160;pl.subplot(5,1,3)</div><div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;pl.plot(best_nose,<span class="stringliteral">&#39;o-&#39;</span>,color=<span class="stringliteral">&#39;lightgray&#39;</span>,linewidth=1)</div><div class="line"><a name="l02728"></a><span class="lineno"> 2728</span>&#160;pl.title(<span class="stringliteral">&#39;Nose best&#39;</span>)</div><div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;pl.xlim([-.5,4.5])</div><div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;pl.ylim([-thresh_corr_neg, .8])</div><div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;</div><div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Pearson\&#39;s r&#39;</span>)</div><div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;</div><div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;pl.subplot(5,1,4)</div><div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160;pl.plot(best_wheel,<span class="stringliteral">&#39;o-&#39;</span>,color=<span class="stringliteral">&#39;lightgray&#39;</span>,linewidth=1)</div><div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;pl.title(<span class="stringliteral">&#39;Wheel best&#39;</span>)</div><div class="line"><a name="l02737"></a><span class="lineno"> 2737</span>&#160;pl.xlim([-.5,4.5])</div><div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;pl.ylim([-thresh_corr_neg, .8])</div><div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;</div><div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Pearson\&#39;s r&#39;</span>)</div><div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;</div><div class="line"><a name="l02742"></a><span class="lineno"> 2742</span>&#160;pl.subplot(5,1,5)</div><div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;pl.plot(best_ur,<span class="stringliteral">&#39;o-&#39;</span>,color=<span class="stringliteral">&#39;lightgray&#39;</span>,linewidth=1)</div><div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160;pl.title(<span class="stringliteral">&#39;UR best&#39;</span>)</div><div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;pl.xlim([-.5,4.5])</div><div class="line"><a name="l02746"></a><span class="lineno"> 2746</span>&#160;pl.ylim([-thresh_corr_neg, .8])</div><div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;</div><div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Pearson\&#39;s r&#39;</span>)</div><div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;</div><div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;<span class="comment">#pl.subplot(6,1,6)</span></div><div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160;<span class="comment">#pl.plot(unrelated,&#39;o-&#39;,color=&#39;gray&#39;)</span></div><div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;<span class="comment">#pl.title(&#39;unrelated&#39;)</span></div><div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;<span class="comment">#pl.xlim([-.5,4.5])</span></div><div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;<span class="comment">#pl.ylim([-thresh_corr_neg, .8])</span></div><div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;<span class="comment">#pl.ylabel(&#39;Pearson\&#39;s r&#39;)</span></div><div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;</div><div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;</div><div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;<span class="comment">#pl.figure(&#39;Cells selectivity all&#39;,figsize=(6,12))   </span></div><div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;<span class="comment">#results_corr.mean().plot(kind=&#39;bar&#39;,yerr=results_corr.sem(),ax=pl.gca())</span></div><div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;<span class="comment">#pl.xlabel(&#39;behavior&#39;)</span></div><div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;<span class="comment">#pl.ylabel(&#39;percentage of neurons &gt; 95th percentile&#39;)</span></div><div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160;<span class="comment">#pl.figure(&#39;Cells selectivity_each&#39;,figsize=(6,12))   </span></div><div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;<span class="comment">#results_corr.T.plot(kind=&#39;bar&#39;,ax=pl.gca())</span></div><div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;<span class="comment">#pl.xlabel(&#39;behavior&#39;)</span></div><div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;<span class="comment">#pl.ylabel(&#39;percentage of neurons &gt; 95th percentile&#39;)</span></div><div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;<span class="comment">#%% respond to two conditions</span></div><div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;<span class="keyword">import</span> itertools</div><div class="line"><a name="l02771"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae28d56eecaab3e0711554e081517ff32"> 2771</a></span>&#160;resp_couples=bh_correl_tmp.copy()</div><div class="line"><a name="l02772"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5f6ccd8472c35dfcc703951c7dadb561"> 2772</a></span>&#160;couples=[<span class="stringliteral">&#39;r_CR_eye_fluo&#39;</span>,<span class="stringliteral">&#39;r_nose_fluo&#39;</span>,<span class="stringliteral">&#39;r_UR_eye_fluo&#39;</span>,<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>]</div><div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;</div><div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;</div><div class="line"><a name="l02775"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4afb94f4e8362cec358c851d83f05651"> 2775</a></span>&#160;nm_c=itertools.combinations([<span class="stringliteral">&#39;CR&#39;</span>,<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;UR&#39;,&#39;</span>wheel&#39;],1)</div><div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160;<span class="keywordflow">for</span> cp <span class="keywordflow">in</span> itertools.combinations(couples, 1):</div><div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    resp_couples[<span class="stringliteral">&#39;R_&#39;</span>+nm_c.next()[0]]=(bh_correl_tmp[cp[0]]&gt;=0) </div><div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;</div><div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;nm_c=itertools.combinations([<span class="stringliteral">&#39;CR&#39;</span>,<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;UR&#39;,&#39;</span>wheel&#39;],2)</div><div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;<span class="keywordflow">for</span> cp <span class="keywordflow">in</span> itertools.combinations(couples, 2):</div><div class="line"><a name="l02781"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2b511e099d2264ead34c91c00109f1b2"> 2781</a></span>&#160;    cp_ = next(nm_c)</div><div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;    resp_couples[<span class="stringliteral">&#39;R_&#39;</span>+cp_[0]+<span class="stringliteral">&#39;_&#39;</span>+cp_[1]]=(bh_correl_tmp[cp[0]]&gt;=0) &amp; (bh_correl_tmp[cp[1]]&gt;=0)</div><div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160;</div><div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;nm_c=itertools.combinations([<span class="stringliteral">&#39;CR&#39;</span>,<span class="stringliteral">&#39;nose&#39;</span>,<span class="stringliteral">&#39;UR&#39;,&#39;</span>wheel&#39;],3)</div><div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;<span class="keywordflow">for</span> cp <span class="keywordflow">in</span> itertools.combinations(couples, 3):</div><div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    cp_ = next(nm_c)</div><div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160;    resp_couples[<span class="stringliteral">&#39;R_&#39;</span>+cp_[0]+<span class="stringliteral">&#39;_&#39;</span>+cp_[1] +<span class="stringliteral">&#39;_&#39;</span>+cp_[2]]=(bh_correl_tmp[cp[0]]&gt;=0) &amp; (bh_correl_tmp[cp[1]]&gt;=0)  &amp; (bh_correl_tmp[cp[2]]&gt;=0)</div><div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;pl.figure(<span class="stringliteral">&#39;Cells responding three conditions all&#39;</span>,figsize=(12,12))   </div><div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;</div><div class="line"><a name="l02791"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9710752817c13d99eb3d3ba4402361b0"> 2791</a></span>&#160;resp_couples_agg=resp_couples.groupby(<span class="stringliteral">&#39;mouse&#39;</span>).<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>().filter(regex=<span class="stringliteral">&quot;^R_&quot;</span>)</div><div class="line"><a name="l02792"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af18ab72f8804762b1bd2503efef30523"> 2792</a></span>&#160;resp_couples_agg.filter(regex=<span class="stringliteral">&quot;^R_&quot;</span>).plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,ax=pl.gca())</div><div class="line"><a name="l02793"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#abc325fc13d4194905c1786e24ee447f0"> 2793</a></span>&#160;labels = pl.gca().get_xticklabels()</div><div class="line"><a name="l02794"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2a6e541cd030366c98e526cb7790dff2"> 2794</a></span>&#160;pl.setp(labels, rotation=0)</div><div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;pl.figure(<span class="stringliteral">&#39;Cells responding three conditions each&#39;</span>,figsize=(12,12))   </div><div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;<span class="comment">#pl.savefig(&#39;cell_selectivity_all.pdf&#39;)</span></div><div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;</div><div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;resp_couples_agg.mean().plot(kind=<span class="stringliteral">&#39;bar&#39;</span>,yerr=resp_couples_agg.sem(),ax=pl.gca()) </div><div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;labels = pl.gca().get_xticklabels()</div><div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;pl.setp(labels, rotation=30) </div><div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font) </div><div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;<span class="comment">#pl.savefig(&#39;cell_selectivity_each.pdf&#39;)</span></div><div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02805"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a617a47c70795bcff659815ad0efd2266"> 2805</a></span>&#160;counter=0</div><div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;pl.figure(figsize=(12,12))</div><div class="line"><a name="l02807"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#aa6ebf46a9450398d5ed8f23232d50cff"> 2807</a></span>&#160;legends=[]</div><div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;<span class="keywordflow">for</span> r_ <span class="keywordflow">in</span> bh_correl.keys()[bh_correl.keys().str.contains(<span class="stringliteral">&#39;r_.*rnd&#39;</span>)]:</div><div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;    counter+=1</div><div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;</div><div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160;    ax=pl.subplot(3,2,counter)</div><div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;    bh_correl[r_[:-4]].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>,ax=ax)</div><div class="line"><a name="l02813"></a><span class="lineno"> 2813</span>&#160;    bh_correl[r_].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>,ax=ax)</div><div class="line"><a name="l02814"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1f8fb6fc08debfce65b5f3dcbc1569d7"> 2814</a></span>&#160;    bords_=np.nanpercentile(bh_correl[r_].values.astype(np.float32),[5,95])</div><div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;    pl.fill_between(bords_,[0,0],[12,12],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;    pl.title(r_[:-4])    </div><div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;</div><div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;<span class="comment">#bh_correl_tmp[[&#39;r_nose_fluo&#39;,&#39;r_nose_fluo_rnd&#39;]].hist(by=bh_correl_tmp[&#39;mouse&#39;],bins=30,histtype=&#39;step&#39;,normed=&#39;True&#39;)</span></div><div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;<span class="comment">#bh_correl_tmp[[&#39;r_wheel_fluo&#39;,&#39;r_wheel_fluo_rnd&#39;]].hist(by=bh_correl_tmp[&#39;mouse&#39;],bins=30,histtype=&#39;step&#39;,normed=&#39;True&#39;)</span></div><div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;<span class="comment">#bh_correl_tmp[[&#39;r_UR_eye_fluo&#39;,&#39;r_UR_eye_fluo_rnd&#39;]].hist(by=bh_correl_tmp[&#39;mouse&#39;],bins=30,histtype=&#39;step&#39;,normed=&#39;True&#39;)</span></div><div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;<span class="comment">#bh_correl_tmp=bh_correl[bh_correl[&#39;learning_phase&#39;]&gt;1]</span></div><div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;<span class="comment">#bh_correl_tmp[[&#39;r_CR_eye_fluo&#39;,&#39;r_CR_eye_fluo_rnd&#39;]].hist(by=bh_correl_tmp[&#39;mouse&#39;],bins=30,histtype=&#39;step&#39;,normed=&#39;True&#39;)</span></div><div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;bh_correl_tmp=bh_correl[bh_correl[<span class="stringliteral">&#39;learning_phase&#39;</span>]&gt;=0]</div><div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;active_during_nose&#39;</span>].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>)</div><div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;active_during_wheel&#39;</span>].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>)</div><div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;active_during_CS&#39;</span>].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>)</div><div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;active_during_UR&#39;</span>].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>)</div><div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;</div><div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;bh_correl_tmp=bh_correl[bh_correl[<span class="stringliteral">&#39;learning_phase&#39;</span>]&gt;1]</div><div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;bh_correl_tmp[[<span class="stringliteral">&#39;active_during_CR&#39;</span>]].<a class="code" href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">hist</a>(by=bh_correl_tmp[<span class="stringliteral">&#39;mouse&#39;</span>],bins=30,histtype=<span class="stringliteral">&#39;step&#39;</span>,normed=<span class="stringliteral">&#39;True&#39;</span>)</div><div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;<span class="comment">#    pl.figure()</span></div><div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;<span class="comment">#    group.plot(x=&#39;neuron_id&#39;, y=&#39;r_nose_fluo&#39;, title=str(i))</span></div><div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02837"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a480bdf69dad7f5a55065ef5ad02e5b83"> 2837</a></span>&#160;cumulative=<span class="keyword">False</span></div><div class="line"><a name="l02838"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a677b948dae857a139e7ca83cd3f87422"> 2838</a></span>&#160;show_neg=<span class="keyword">True</span></div><div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;</div><div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;pl.subplot(2,2,1)</div><div class="line"><a name="l02841"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a9336ebf25087d91c818ee6e9ec29f8c1"> 2841</a></span>&#160;bh_correl.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,<span class="stringliteral">&#39;neuron_id&#39;</span>]).r_nose_fluo.mean().plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,x=<span class="stringliteral">&#39;mouse&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;bh_correl.r_nose_fluo_rnd.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;</div><div class="line"><a name="l02844"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0830d2082bff8ff40254a496e52b7079"> 2844</a></span>&#160;bords_nose=np.nanpercentile(bh_correl.r_nose_fluo_rnd.values.astype(np.float32),[5,95])</div><div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;pl.fill_between(bords_nose,[0,0],[1,1],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;</div><div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;</div><div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;pl.xlabel(<span class="stringliteral">&#39;Correlation&#39;</span>)</div><div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Percentage of neurons&#39;</span>)</div><div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;pl.title(<span class="stringliteral">&#39;Nose  vs fluo&#39;</span>)</div><div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> show_neg:</div><div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    pl.xlim([0,1])</div><div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;<span class="comment">#pl.ylim([0,2.5])</span></div><div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;pl.subplot(2,2,2)</div><div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;bh_correl.r_wheel_fluo.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;bh_correl.r_wheel_fluo_rnd.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;</div><div class="line"><a name="l02858"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a2670d14199ed8f3d54823ec2d65d7b4d"> 2858</a></span>&#160;bords_wheel=np.nanpercentile(bh_correl.r_wheel_fluo_rnd.values.astype(np.float32),[5,95])</div><div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;pl.fill_between(bords_wheel,[0,0],[1,1],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;</div><div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;pl.title(<span class="stringliteral">&#39;Wheel  vs fluo&#39;</span>)</div><div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;pl.xlabel(<span class="stringliteral">&#39;Correlation&#39;</span>)</div><div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Percentage of neurons&#39;</span>)</div><div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> show_neg:</div><div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;    pl.xlim([0,1])</div><div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;</div><div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;<span class="comment">#pl.ylim([0,2.5])</span></div><div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;</div><div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;</div><div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;pl.subplot(2,2,3)</div><div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;bh_correl.r_UR_eye_fluo.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;bh_correl.r_UR_eye_fluo_rnd.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=50,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02873"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a934fc7d71d182e7ff620822a5bdbe54c"> 2873</a></span>&#160;bords_UR=np.nanpercentile(bh_correl.r_UR_eye_fluo_rnd.values.astype(np.float32),[5,95])</div><div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;pl.fill_between(bords_UR,[0,0],[1,1],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;</div><div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;</div><div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160;pl.title(<span class="stringliteral">&#39;UR  vs fluo&#39;</span>)</div><div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;pl.xlabel(<span class="stringliteral">&#39;Correlation&#39;</span>)</div><div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Percentage of neurons&#39;</span>)</div><div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> show_neg:</div><div class="line"><a name="l02881"></a><span class="lineno"> 2881</span>&#160;    pl.xlim([0,1])</div><div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;<span class="comment">#pl.ylim([0,2.5])</span></div><div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;</div><div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;pl.subplot(2,2,4)</div><div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;bh_correl.r_CR_eye_fluo.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=100,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;bh_correl.r_CR_eye_fluo_rnd.plot(kind=<span class="stringliteral">&#39;hist&#39;</span>,bins=100,normed=<span class="keyword">True</span>,histtype = <span class="stringliteral">&#39;step&#39;</span>,cumulative=cumulative)</div><div class="line"><a name="l02887"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a5f13f4abf85f2ee400b7f893d3fe98cb"> 2887</a></span>&#160;bords_CR=np.nanpercentile(bh_correl.r_CR_eye_fluo_rnd.values.astype(np.float32),[5,95])</div><div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;pl.fill_between(bords_CR,[0,0],[10,10],facecolor=<span class="stringliteral">&#39;green&#39;</span>,alpha=.5)</div><div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;</div><div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;<span class="comment">#bh_correl_tmp.delta_norm.plot(kind=&#39;hist&#39;,bins=200,normed=True)</span></div><div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;<span class="comment">#bh_correl.delta_norm.plot(kind=&#39;hist&#39;,bins=30,normed=True)</span></div><div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;pl.title(<span class="stringliteral">&#39;CR vs fluo&#39;</span>)</div><div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;pl.legend([<span class="stringliteral">&#39;Measured (p&lt;0.05)&#39;</span>,<span class="stringliteral">&#39;Random shuffle (5th - 95th percentile)&#39;</span>],loc=2)</div><div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;pl.xlabel(<span class="stringliteral">&#39;Correlation&#39;</span>)</div><div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;pl.ylabel(<span class="stringliteral">&#39;Percentage of neurons&#39;</span>)</div><div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;<span class="keywordflow">if</span> <span class="keywordflow">not</span> show_neg:</div><div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;    pl.xlim([0,1])</div><div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;<span class="comment">#pl.ylim([0,5])</span></div><div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;bh_correl_tmp=bh_correl.copy()</div><div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;bh_correl_tmp[<span class="stringliteral">&#39;respond_to_wheel&#39;</span>]=(bh_correl_tmp[<span class="stringliteral">&#39;r_wheel_fluo&#39;</span>]&gt;bords_UR[-1])</div><div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;print((bh_correl_tmp.groupby(<span class="stringliteral">&#39;mouse&#39;</span>)[<span class="stringliteral">&#39;respond_to_wheel&#39;</span>].<a class="code" href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">mean</a>()))</div><div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;</div><div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;</div><div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;<span class="comment">#print np.mean(bh_correl_tmp[&#39;r_CR_eye_fluo&#39;]&gt;bords_CR[-1])</span></div><div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;<span class="comment">#print np.mean(bh_correl_tmp[&#39;r_wheel_fluo&#39;]&gt;bords_wheel[-1])</span></div><div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;<span class="comment">#print np.mean(bh_correl_tmp[&#39;r_nose_fluo&#39;]&gt;bords_nose[-1])</span></div><div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;<span class="comment">#np.mean(bh_correl_tmp[&#39;r_eye_fluo&#39;]&gt;bords_eye[-1])</span></div><div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;</div><div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;</div><div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;</div><div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;<span class="keyword">from</span> itertools <span class="keyword">import</span> cycle, islice</div><div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;cr_ampl_m=cr_ampl_sel.copy()</div><div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;</div><div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;grouped_session=cr_ampl_m.groupby([<span class="stringliteral">&#39;mouse&#39;</span>,pd.cut(cr_ampl_m[<span class="stringliteral">&#39;perc_CR&#39;</span>],bins,include_lowest=<span class="keyword">True</span>),pd.cut(cr_ampl_m[<span class="stringliteral">&#39;fluo_plus&#39;</span>],[0,.2,.8,1.5],include_lowest=<span class="keyword">True</span>)]) </div><div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;pl.close(<span class="stringliteral">&#39;all&#39;</span>)</div><div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;</div><div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;<span class="keywordflow">for</span> counter,ms <span class="keywordflow">in</span> enumerate(cr_ampl_m.mouse.unique()):</div><div class="line"><a name="l02920"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a71e3f5e7059e4fd4e0065ad281add3a1"> 2920</a></span>&#160;    cr_now=cr_ampl_m[cr_ampl_m.mouse==ms]</div><div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;    <span class="keywordflow">if</span> <span class="stringliteral">&#39;b3&#39;</span> <span class="keywordflow">in</span> ms:</div><div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;        cr_now=cr_now[cr_now.session_id&gt;=np.maximum(0,cr_now.session_id.max()-3)]</div><div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;        <span class="keywordflow">if</span> ms == <span class="stringliteral">&#39;AG052014-01&#39;</span>:</div><div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;            print(<span class="stringliteral">&#39;*&#39;</span>)</div><div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;            cr_now=cr_now[cr_now.session_id==np.maximum(0,cr_now.session_id.max()-3)]</div><div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160;        <span class="keywordflow">elif</span> ms == <span class="stringliteral">&#39;gc-AG052014-02&#39;</span>:</div><div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;            print(<span class="stringliteral">&#39;**&#39;</span>)</div><div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;            cr_now=cr_now[cr_now.session_id&gt;=np.maximum(0,cr_now.session_id.max()-5)]</div><div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;        <span class="keywordflow">elif</span> ms == <span class="stringliteral">&#39;AG051514-01&#39;</span>:</div><div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;            print(<span class="stringliteral">&#39;**&#39;</span>)</div><div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;            cr_now=cr_now[cr_now.session_id&gt;=np.maximum(0,cr_now.session_id.max()-2)]    </div><div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160;        <span class="keywordflow">else</span>:</div><div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;            cr_now=cr_now[cr_now.session_id==np.maximum(0,cr_now.session_id.max())]   </div><div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160;                          </div><div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;    cr_now[<span class="stringliteral">&#39;delta&#39;</span>]=(cr_now[<span class="stringliteral">&#39;fluo_plus&#39;</span>]-cr_now[<span class="stringliteral">&#39;fluo_minus&#39;</span>])  </div><div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;    cr_now[<span class="stringliteral">&#39;delta_norm&#39;</span>]=old_div((cr_now[<span class="stringliteral">&#39;fluo_plus&#39;</span>]-cr_now[<span class="stringliteral">&#39;fluo_minus&#39;</span>]),np.abs(cr_now[<span class="stringliteral">&#39;fluo_plus&#39;</span>]+cr_now[<span class="stringliteral">&#39;fluo_minus&#39;</span>]))          </div><div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    cr_now[<span class="stringliteral">&#39;fluo_minus&#39;</span>]=-cr_now[<span class="stringliteral">&#39;fluo_minus&#39;</span>]</div><div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;    cr_now=cr_now[cr_now.fluo_minus&lt;=0]</div><div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    cr_now=cr_now[cr_now.delta_norm&gt;0]</div><div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    ax=pl.subplot(1,6,counter+1)</div><div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    cr_now=cr_now.sort(<span class="stringliteral">&#39;delta&#39;</span>)</div><div class="line"><a name="l02943"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae9dc79f928c0b87b6f24a53a80804c14"> 2943</a></span>&#160;    my_colors = list(islice(cycle([<span class="stringliteral">&#39;k&#39;</span>, <span class="stringliteral">&#39;r&#39;]), None, len(cr_now)))</span></div><div class="line"><a name="l02944"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a4cfa2a4653315588b1ceed8018235087"> 2944</a></span>&#160;<span class="stringliteral">    cr_now[[&#39;delta&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]].dropna(0)[-61:-1].plot(ax=ax,kind=<span class="stringliteral">&#39;bar&#39;</span>,stacked=<span class="keyword">True</span>,color=my_colors,width=.9,edgecolor=<span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    pl.tick_params(</div><div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;        axis=<span class="stringliteral">&#39;x&#39;</span>,          <span class="comment"># changes apply to the x-axis</span></div><div class="line"><a name="l02947"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a40b5ec2f455aafcdf87faa2a2ec10c59"> 2947</a></span>&#160;        which=<span class="stringliteral">&#39;both&#39;</span>,      <span class="comment"># both major and minor ticks are affected</span></div><div class="line"><a name="l02948"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a1e1e13bec2639fca768af56dd3b64e9a"> 2948</a></span>&#160;        bottom=<span class="stringliteral">&#39;off&#39;</span>,      <span class="comment"># ticks along the bottom edge are off</span></div><div class="line"><a name="l02949"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a8aab264665f2085687d9eeca4c67a691"> 2949</a></span>&#160;        top=<span class="stringliteral">&#39;off&#39;</span>,         <span class="comment"># ticks along the top edge are off</span></div><div class="line"><a name="l02950"></a><span class="lineno"><a class="line" href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#afd66b4510fd1bb16e26289af23b99113"> 2950</a></span>&#160;        labelbottom=<span class="stringliteral">&#39;off&#39;</span>) <span class="comment"># labels along the bottom edge are off</span></div><div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;    ax.legend().remove()</div><div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;    pl.ylabel(<span class="stringliteral">&#39;DF/F&#39;</span>)</div><div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160;    pl.ylim([-1.4,1.4])</div><div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;<span class="comment">#    cr_now[[&#39;fluo_plus&#39;,&#39;fluo_minus&#39;]].dropna(0).sort(&#39;fluo_plus&#39;)[-61:-1].plot(kind=&#39;bar&#39;,stacked=True,color=my_colors,width=.9)</span></div><div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;    pl.title(ms)</div><div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;    pl.xlabel(<span class="stringliteral">&#39;Granule cells&#39;</span>)</div><div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;</div><div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;</div><div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;pl.legend([<span class="stringliteral">&#39;CR+-CR-&#39;</span>,<span class="stringliteral">&#39;CR-&#39;</span>])</div><div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;bins=[0,.1, .5, 1]</div><div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;grouped_session=cr_ampl.groupby([pd.cut(cr_ampl_m[<span class="stringliteral">&#39;ampl_eyelid_CSCSUS&#39;</span>],bins,include_lowest=<span class="keyword">True</span>)])    </div><div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;means=grouped_session.mean()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160;sems=grouped_session.sem()[[<span class="stringliteral">&#39;fluo_plus&#39;</span>,<span class="stringliteral">&#39;fluo_minus&#39;</span>]]</div><div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;means.plot(kind=<span class="stringliteral">&#39;line&#39;</span>,yerr=sems,marker=<span class="stringliteral">&#39;o&#39;</span>,xticks=list(range(3)),markersize=15)</div><div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;<span class="comment">#pl.xlim([-.1, 2.1])</span></div><div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;pl.legend([<span class="stringliteral">&#39;CR+&#39;</span>,<span class="stringliteral">&#39;CR-&#39;</span>],loc=3)</div><div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;pl.xlabel(<span class="stringliteral">&#39;Fraction of CRs&#39;</span>)</div><div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;pl.ylabel(<span class="stringliteral">&#39;DF/F&#39;</span>)</div><div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;</div><div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="ttc" id="namespacecaiman_1_1components__evaluation_html_a967e8c445c84976814609f9c120153a2"><div class="ttname"><a href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">caiman.components_evaluation.compute_event_exceptionality</a></div><div class="ttdeci">def compute_event_exceptionality(traces, robust_std=False, N=5, use_mode_fast=False)</div><div class="ttdef"><b>Definition:</b> <a href="components__evaluation_8py_source.html#l00084">components_evaluation.py:84</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1utils__granule_html"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html">use_cases.granule_cells.utils_granule</a></div><div class="ttdef"><b>Definition:</b> <a href="utils__granule_8py_source.html#l00001">utils_granule.py:1</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1utils__granule_html_ac9cde14ba363f17139f7a84a7164e5f4"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#ac9cde14ba363f17139f7a84a7164e5f4">use_cases.granule_cells.utils_granule.process_wheel_traces</a></div><div class="ttdeci">def process_wheel_traces(traces, time_vect, thresh_MOV_iqr=3, time_CS_on=-.25, time_US_on=0)</div><div class="ttdef"><b>Definition:</b> <a href="utils__granule_8py_source.html#l00512">utils_granule.py:512</a></div></div>
<div class="ttc" id="namespacecompare__online__offline_html_ac15e5a1de3bd77dc1ff2768e42dc9e8b"><div class="ttname"><a href="namespacecompare__online__offline.html#ac15e5a1de3bd77dc1ff2768e42dc9e8b">compare_online_offline.hist</a></div><div class="ttdeci">hist</div><div class="ttdef"><b>Definition:</b> <a href="compare__online__offline_8py_source.html#l00279">compare_online_offline.py:279</a></div></div>
<div class="ttc" id="namespacecaiman_1_1gui_1_1gui_html_a4e2a3f798bd0d5098afbf69c71c8fb9f"><div class="ttname"><a href="namespacecaiman_1_1gui_1_1gui.html#a4e2a3f798bd0d5098afbf69c71c8fb9f">caiman.gui.gui.mean</a></div><div class="ttdeci">mean</div><div class="ttdef"><b>Definition:</b> <a href="gui_8py_source.html#l00234">gui.py:234</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1utils__granule_html_af632b4bb540efcbdd4df79f9228c2f78"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#af632b4bb540efcbdd4df79f9228c2f78">use_cases.granule_cells.utils_granule.process_fast_process_day</a></div><div class="ttdeci">def process_fast_process_day(base_folders, save_name='temp_save.npz')</div><div class="ttdoc">Use this after having used fast_process_day. </div><div class="ttdef"><b>Definition:</b> <a href="utils__granule_8py_source.html#l01176">utils_granule.py:1176</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_a897278208f333e2c803ca0621c27a913"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a897278208f333e2c803ca0621c27a913">use_cases.granule_cells.analysis_parallel_multisession.func_avg_fluo</a></div><div class="ttdeci">def func_avg_fluo(X, args, kwargs)</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l00609">analysis_parallel_multisession.py:609</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_a0d85a403a5511da7f6041ea7957638c5"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#a0d85a403a5511da7f6041ea7957638c5">use_cases.granule_cells.analysis_parallel_multisession.selct</a></div><div class="ttdeci">selct</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l00487">analysis_parallel_multisession.py:487</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1utils__granule_html_a9e7ada950fa11b7fa54ea6bffa5ca746"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a9e7ada950fa11b7fa54ea6bffa5ca746">use_cases.granule_cells.utils_granule.process_wheel_traces_talmo</a></div><div class="ttdeci">def process_wheel_traces_talmo(wheel_mms_TM_, timestamps_TM_, tm, thresh_MOV=.2, time_CS_on=-.25, time_US_on=0)</div><div class="ttdef"><b>Definition:</b> <a href="utils__granule_8py_source.html#l00527">utils_granule.py:527</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_ae8b31000f68152a5834e996b507ddeb3"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ae8b31000f68152a5834e996b507ddeb3">use_cases.granule_cells.analysis_parallel_multisession.get_stats</a></div><div class="ttdeci">def get_stats(group)</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l01869">analysis_parallel_multisession.py:1869</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_ad43c3812e6d13e0518d9f8b8f463ffcf"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#ad43c3812e6d13e0518d9f8b8f463ffcf">use_cases.granule_cells.analysis_parallel_multisession.count</a></div><div class="ttdeci">int count</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l02284">analysis_parallel_multisession.py:2284</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_acb2727703e95ab5978e608eea77f625f"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#acb2727703e95ab5978e608eea77f625f">use_cases.granule_cells.analysis_parallel_multisession.unroll_Talmo_data</a></div><div class="ttdeci">def unroll_Talmo_data(matr_list, is_nose=False)</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l00228">analysis_parallel_multisession.py:228</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1utils__granule_html_a548726920163e9294689515308c625ca"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1utils__granule.html#a548726920163e9294689515308c625ca">use_cases.granule_cells.utils_granule.process_eyelid_traces</a></div><div class="ttdeci">def process_eyelid_traces(traces, time_vect, idx_CS_US, idx_US, idx_CS, thresh_CR=.1, time_CR_on=-.1, time_US_on=.05)</div><div class="ttdoc">preprocess traces output of get_behavior_traces </div><div class="ttdef"><b>Definition:</b> <a href="utils__granule_8py_source.html#l00491">utils_granule.py:491</a></div></div>
<div class="ttc" id="namespacecaiman_1_1components__evaluation_html"><div class="ttname"><a href="namespacecaiman_1_1components__evaluation.html">caiman.components_evaluation</a></div><div class="ttdef"><b>Definition:</b> <a href="components__evaluation_8py_source.html#l00001">components_evaluation.py:1</a></div></div>
<div class="ttc" id="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession_html_af08d82dec3d2c26b2eb5eae6f2a3b561"><div class="ttname"><a href="namespaceuse__cases_1_1granule__cells_1_1analysis__parallel__multisession.html#af08d82dec3d2c26b2eb5eae6f2a3b561">use_cases.granule_cells.analysis_parallel_multisession.my_custom_loss_func</a></div><div class="ttdeci">def my_custom_loss_func(ground_truth, predictions)</div><div class="ttdef"><b>Definition:</b> <a href="analysis__parallel__multisession_8py_source.html#l00597">analysis_parallel_multisession.py:597</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_9fdcf4dafa59827d19629261a7a4f90c.html">use_cases</a></li><li class="navelem"><a class="el" href="dir_004be44c8f98b9f6a23cc4c7c8192a42.html">granule_cells</a></li><li class="navelem"><a class="el" href="analysis__parallel__multisession_8py.html">analysis_parallel_multisession.py</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
