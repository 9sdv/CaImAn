<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caiman: demo_motion_correction_nonrigid.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Caiman_logo_FIsmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caiman
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A Computational toolbox for large scale Calcium Imaging Analysis</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">use_cases/motion_correction_paper/demo_motion_correction_nonrigid.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">Created on Mon Nov 21 15:53:15 2016</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">@author: agiovann</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> division</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> zip</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> str</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> map</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">from</span> builtins <span class="keyword">import</span> range</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">from</span> past.utils <span class="keyword">import</span> old_div</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">import</span> cv2</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    cv2.setNumThreads(1)</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keywordflow">except</span>:</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    print(<span class="stringliteral">&#39;Open CV is naturally single threaded&#39;</span>)</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keywordflow">try</span>:</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    <span class="keywordflow">if</span> __IPYTHON__:</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;        print((1))</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;        <span class="comment"># this is used for debugging purposes only. allows to reload classes when changed</span></div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;        get_ipython().magic(<span class="stringliteral">&#39;load_ext autoreload&#39;</span>)</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;        get_ipython().magic(<span class="stringliteral">&#39;autoreload 2&#39;</span>)</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keywordflow">except</span> NameError:</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;    print(<span class="stringliteral">&#39;Not IPYTHON&#39;</span>)</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="keywordflow">pass</span></div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">import</span> caiman <span class="keyword">as</span> cm</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">import</span> time</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">import</span> pylab <span class="keyword">as</span> pl</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">import</span> psutil</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">import</span> sys</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">import</span> os</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">from</span> ipyparallel <span class="keyword">import</span> Client</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">from</span> skimage.external.tifffile <span class="keyword">import</span> TiffFile</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacecaiman_1_1motion__correction.html">caiman.motion_correction</a> <span class="keyword">import</span> tile_and_correct<span class="comment">#, motion_correction_piecewise</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">#%% in parallel</span></div><div class="line"><a name="l00043"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a7c12b0a7d034249b2ceb2b7a2a36498b">   43</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacedemo__motion__correction__nonrigid.html#a7c12b0a7d034249b2ceb2b7a2a36498b">tile_and_correct_wrapper</a>(params):</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    <span class="keyword">from</span> skimage.external.tifffile <span class="keyword">import</span> imread</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keyword">import</span> cv2</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        cv2.setNumThreads(1)</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keywordflow">except</span>:</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;        1 <span class="comment">#&#39;Open CV is naturally single threaded&#39;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="keyword">from</span> <a class="code" href="namespacecaiman_1_1motion__correction.html">caiman.motion_correction</a> <span class="keyword">import</span> tile_and_correct</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    img_name,  out_fname,idxs, shape_mov, template, strides, overlaps, max_shifts,\</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        add_to_movie,max_deviation_rigid,upsample_factor_grid, newoverlaps, newstrides,shifts_opencv  = params</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    imgs = imread(img_name,key = idxs)</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    mc = np.zeros(imgs.shape,dtype = np.float32)</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    shift_info = []</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordflow">for</span> count, img <span class="keywordflow">in</span> enumerate(imgs): </div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        <span class="keywordflow">if</span> count % 10 == 0:</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            print(count)</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        mc[count],total_shift,start_step,xy_grid = <a class="code" href="namespacecaiman_1_1motion__correction.html#aea060208c09f0e4fb01e6d31b9acf36f">tile_and_correct</a>(img, template, strides, overlaps,max_shifts, add_to_movie=add_to_movie, newoverlaps = newoverlaps, newstrides = newstrides,\</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                upsample_factor_grid= upsample_factor_grid, upsample_factor_fft=10,show_movie=<span class="keyword">False</span>,max_deviation_rigid=max_deviation_rigid,shifts_opencv = shifts_opencv)</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        shift_info.append([total_shift,start_step,xy_grid])</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    <span class="keywordflow">if</span> out_fname <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:           </div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        outv = np.memmap(out_fname,mode=<span class="stringliteral">&#39;r+&#39;</span>, dtype=np.float32, shape=shape_mov, order=<span class="stringliteral">&#39;F&#39;</span>)</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        outv[:,idxs] = np.reshape(mc.astype(np.float32),(len(imgs),-1),order = <span class="stringliteral">&#39;F&#39;</span>).T</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">return</span> shift_info, idxs, np.nanmean(mc,0)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">def </span><a class="code" href="namespacedemo__motion__correction__nonrigid.html#ab88fd1006bbd98bfc246c62eaff53366">motion_correction_piecewise</a>(fname, splits, strides, overlaps, add_to_movie=0, template = None, max_shifts = (12,12),max_deviation_rigid = 3,newoverlaps = <span class="keywordtype">None</span>, newstrides = <span class="keywordtype">None</span>,\</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;                                upsample_factor_grid = 4, order = <span class="stringliteral">&#39;F&#39;</span>,dview = <span class="keywordtype">None</span>,save_movie= <span class="keyword">True</span>, base_name = <span class="stringliteral">&#39;none&#39;</span>, num_splits = <span class="keywordtype">None</span>,shifts_opencv= <span class="keyword">False</span>):</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="stringliteral">&#39;&#39;&#39;</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00081"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ab88fd1006bbd98bfc246c62eaff53366">   81</a></span>&#160;<span class="stringliteral">    &#39;&#39;&#39;</span></div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;    with TiffFile(fname) <span class="keyword">as</span> tf:</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        d1,d2 = tf[0].shape</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        T = len(tf)    </div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    <span class="keywordflow">if</span> type(splits) <span class="keywordflow">is</span> int:</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;        idxs = np.array_split(list(range(T)),splits)</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;        idxs = splits</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;        save_movie = <span class="keyword">False</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    <span class="keywordflow">if</span> template <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;        <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Not implemented&#39;</span>)</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;    shape_mov =  (d1*d2,T)</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    dims = d1,d2</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    <span class="keywordflow">if</span> num_splits <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        idxs = np.array(idxs)[np.random.randint(0,len(idxs),num_splits)]</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        save_movie = <span class="keyword">False</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        print(<span class="stringliteral">&#39;**** MOVIE NOT SAVED BECAUSE num_splits is not None ****&#39;</span>)</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;        </div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    <span class="keywordflow">if</span> save_movie:</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="keywordflow">if</span> base_name <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;            base_name = fname[:-4]</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        fname_tot = base_name + <span class="stringliteral">&#39;_d1_&#39;</span> + str(dims[0]) + <span class="stringliteral">&#39;_d2_&#39;</span> + str(dims[1]) + <span class="stringliteral">&#39;_d3_&#39;</span> + str(1 <span class="keywordflow">if</span> len(dims) == 2 <span class="keywordflow">else</span> dims[2]) + <span class="stringliteral">&#39;_order_&#39;</span> + str(order) + <span class="stringliteral">&#39;_frames_&#39;</span> + str(T) + <span class="stringliteral">&#39;_.mmap&#39;</span></div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        fname_tot = os.path.join(os.path.split(fname)[0],fname_tot) </div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        np.memmap(fname_tot, mode=<span class="stringliteral">&#39;w+&#39;</span>, dtype=np.float32, shape=shape_mov, order=order)</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        fname_tot = <span class="keywordtype">None</span></div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    pars = []</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    </div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    </div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        </div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="keywordflow">for</span> idx <span class="keywordflow">in</span> idxs:</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;        pars.append([fname,fname_tot,idx,shape_mov, template, strides, overlaps, max_shifts, np.array(add_to_movie,dtype = np.float32),max_deviation_rigid,upsample_factor_grid, newoverlaps, newstrides, shifts_opencv ])</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    t1 = time.time()</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="keywordflow">if</span> dview <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;        res =dview.map_sync(tile_and_correct_wrapper,pars)</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        res = list(map(tile_and_correct_wrapper,pars))</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    print((time.time()-t1))    </div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    <span class="keywordflow">return</span> fname_tot, res</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">#backend=&#39;SLURM&#39;</span></div><div class="line"><a name="l00136"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aec243578508d14c950b15e41a4de034e">  136</a></span>&#160;backend = <span class="stringliteral">&#39;local&#39;</span></div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keywordflow">if</span> backend == <span class="stringliteral">&#39;SLURM&#39;</span>:</div><div class="line"><a name="l00138"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#afc887c81cb0ff13d5b2439525ddbdc8d">  138</a></span>&#160;    n_processes = np.int(os.environ.get(<span class="stringliteral">&#39;SLURM_NPROCS&#39;</span>))</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;    <span class="comment"># roughly number of cores on your machine minus 1</span></div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    n_processes = np.maximum(np.int(psutil.cpu_count()), 1)</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;print((<span class="stringliteral">&#39;using &#39;</span> + str(n_processes) + <span class="stringliteral">&#39; processes&#39;</span>))</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">#%% start cluster for efficient computation</span></div><div class="line"><a name="l00144"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a9e59a8544e50abae8f7d58057ab8e1bf">  144</a></span>&#160;single_thread = <span class="keyword">False</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="keywordflow">if</span> single_thread:</div><div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a2e98a47cee987dc7000ac312036cddaf">  147</a></span>&#160;    dview = <span class="keywordtype">None</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordflow">try</span>:</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        c.close()</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">except</span>:</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        print(<span class="stringliteral">&#39;C was not existing, creating one&#39;</span>)</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    print(<span class="stringliteral">&quot;Stopping  cluster to avoid unnencessary use of memory....&quot;</span>)</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    sys.stdout.flush()</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span> backend == <span class="stringliteral">&#39;SLURM&#39;</span>:</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00157"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af58da398f293ce7fc4630bc69ad5f8d7">  157</a></span>&#160;            cm.stop_server(is_slurm=<span class="keyword">True</span>)</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <span class="keywordflow">except</span>:</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;            print(<span class="stringliteral">&#39;Nothing to stop&#39;</span>)</div><div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ace72880acd4ada0f7d8d7a34c74c5e49">  160</a></span>&#160;        slurm_script = <span class="stringliteral">&#39;/mnt/xfs1/home/agiovann/SOFTWARE/Constrained_NMF/SLURM/slurmStart.sh&#39;</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        cm.start_server(slurm_script=slurm_script)</div><div class="line"><a name="l00162"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a7667610e670e037bd84c42dadbfbaa30">  162</a></span>&#160;        pdir, profile = os.environ[<span class="stringliteral">&#39;IPPPDIR&#39;</span>], os.environ[<span class="stringliteral">&#39;IPPPROFILE&#39;</span>]</div><div class="line"><a name="l00163"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae0323a9039add2978bf5b49550572c7c">  163</a></span>&#160;        c = Client(ipython_dir=pdir, profile=profile)</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;        cm.stop_server()</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;        cm.start_server()</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;        c = Client()</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    print((<span class="stringliteral">&#39;Using &#39;</span> + str(len(c)) + <span class="stringliteral">&#39; processes&#39;</span>))</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    dview = c[:len(c)]</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">#%% set parameters and create template by rigid motion correction</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;t1 = time.time()</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">#fname = &#39;k56_20160608_RSM_125um_41mW_zoom2p2_00001_00034.tif&#39;</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">#fname = &#39;Sue_1000.tif&#39;</span></div><div class="line"><a name="l00175"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a203723e4839c81b9d0924b3278e95de1">  175</a></span>&#160;fname = <span class="stringliteral">&#39;Sue_2000.tif&#39;</span></div><div class="line"><a name="l00176"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aa7bf4838a4a728185e5f6f498987f8e5">  176</a></span>&#160;max_shifts = (12,12)</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">#splits = 56 # for parallelization split the movies in  num_splits chuncks across time</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">#num_splits_to_process = 28</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">#fname = &#39;M_FLUO_t_1000.tif&#39;</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">#max_shifts = (10,10)</span></div><div class="line"><a name="l00181"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a197e96f33125648e12a1bc31ac7255f9">  181</a></span>&#160;splits = 56 <span class="comment"># for parallelization split the movies in  num_splits chuncks across time</span></div><div class="line"><a name="l00182"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a3ddb6f3b8a6fb37a64a320dce1cbe934">  182</a></span>&#160;num_splits_to_process = 28</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">#fname = &#39;M_FLUO_4.tif&#39;</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;m = cm.load(fname,subindices=slice(0,500,<span class="keywordtype">None</span>))</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;template = cm.motion_correction.bin_median( m[100:400].copy().motion_correct(max_shifts[0],max_shifts[1],template=<span class="keywordtype">None</span>)[0])</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="keywordflow">print</span> (time.time() - t1)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">#pl.imshow(template)</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00190"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac6592808ea206727dd6408fa35f77b30">  190</a></span>&#160;shifts_opencv = <span class="keyword">False</span></div><div class="line"><a name="l00191"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1f45912c384bcf6ad6d6f58e24bcda5a">  191</a></span>&#160;new_templ = template</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;add_to_movie=-np.min(template)</div><div class="line"><a name="l00193"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ab534833a9a5102bc75c2aa8a2207235a">  193</a></span>&#160;save_movie = <span class="keyword">False</span></div><div class="line"><a name="l00194"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aec2269ddcef2faf5f35a7257ba3b8f0b">  194</a></span>&#160;num_iter = 1 </div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keywordflow">for</span> iter_ <span class="keywordflow">in</span> range(num_iter):</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    print(iter_)</div><div class="line"><a name="l00197"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a84282bd34a9ac753190e570d7fbdae95">  197</a></span>&#160;    old_templ = new_templ.copy()</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">if</span> iter_ == num_iter-1:</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;        save_movie = <span class="keyword">True</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;        print(<span class="stringliteral">&#39;saving!&#39;</span>)</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;        num_splits_to_process = <span class="keywordtype">None</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">#        templ_to_save = old_templ</span></div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;</div><div class="line"><a name="l00204"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ab0bd7560790c13b656fd58e17e35143e">  204</a></span>&#160;    fname_tot, res = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#ab88fd1006bbd98bfc246c62eaff53366">motion_correction_piecewise</a>(fname,splits, <span class="keywordtype">None</span>, <span class="keywordtype">None</span>,\</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;                            add_to_movie=add_to_movie, template = old_templ, max_shifts = max_shifts,max_deviation_rigid = 0,\</div><div class="line"><a name="l00206"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac7485dcc8d256a6f197ed7802687f252">  206</a></span>&#160;                            newoverlaps = <span class="keywordtype">None</span>, newstrides = <span class="keywordtype">None</span>,\</div><div class="line"><a name="l00207"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a9f4e8630516f3da89537313b4c828759">  207</a></span>&#160;                            upsample_factor_grid = 4, order = <span class="stringliteral">&#39;F&#39;</span>,dview = dview, save_movie=save_movie ,base_name  = fname[:-4]+ <span class="stringliteral">&#39;_rig_&#39;</span>,num_splits=num_splits_to_process,shifts_opencv=shifts_opencv)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    new_templ = np.nanmedian(np.dstack([r[-1] <span class="keywordflow">for</span> r <span class="keywordflow">in</span> res ]),-1)</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    print((old_div(np.linalg.norm(new_templ-old_templ),np.linalg.norm(old_templ))))</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;t2 = time.time() - t1</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;print(t2)</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;pl.imshow(new_templ,cmap = <span class="stringliteral">&#39;gray&#39;</span>,vmax = np.percentile(new_templ,95))     </div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="keyword">import</span> scipy</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;np.save(fname[:-4]+<span class="stringliteral">&#39;_templ_rigid.npy&#39;</span>,new_templ)</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">#scipy.io.savemat(&#39;/mnt/xfs1/home/agiovann/dropbox/Python_progress/&#39; + str(np.shape(m)[-1])+&#39;_templ_rigid.mat&#39;,{&#39;template&#39;:new_templ}) </span></div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;template = new_templ</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;mr = cm.load(fname_tot)</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">#%% online does not seem to work!</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">#overlaps = (16,16)</span></div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">#if template.shape == (512,512):</span></div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">#    strides = (128,128)# 512 512 </span></div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">#    #strides = (48,48)# 128 64</span></div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">#elif template.shape == (64,128):</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">#    strides = (48,48)# 512 512</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">#else:</span></div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">#    raise Exception(&#39;Unknown size, set manually&#39;)    </span></div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">#upsample_factor_grid = 4</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">#T = m.shape[0]</span></div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">#idxs_outer = np.array_split(range(T),T/1000)</span></div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">#for iddx in idxs_outer:</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">#    num_fr = len(iddx)</span></div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">#    splits = np.array_split(iddx,num_fr/n_processes)</span></div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">#    print (splits[0][0]),(splits[-1][-1])</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">#    fname_tot, res = motion_correction_piecewise(fname,splits, strides, overlaps,\</span></div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">#                            add_to_movie=add_to_movie, template = template, max_shifts = (12,12),max_deviation_rigid = 3,\</span></div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">#                            upsample_factor_grid = upsample_factor_grid,dview = dview)</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;t1 = time.time()</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="keywordflow">if</span> template.shape == (512,512):</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    strides = (128,128)<span class="comment"># 512 512 </span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    overlaps = (32,32)</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">#    strides = (16,16)# 512 512 </span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    newoverlaps = <span class="keywordtype">None</span></div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    newstrides = <span class="keywordtype">None</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="comment">#strides = (48,48)# 128 64</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keywordflow">elif</span> template.shape == (64,128):</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    strides = (32,32)<span class="comment">#</span></div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    overlaps = (16,16)</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;    newoverlaps = <span class="keywordtype">None</span></div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    newstrides = <span class="keywordtype">None</span></div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="keywordflow">else</span>:</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;    <span class="keywordflow">raise</span> Exception(<span class="stringliteral">&#39;Unknown size, set manually&#39;</span>)    </div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;splits = 56</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;num_splits_to_process = 28</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;upsample_factor_grid = 4</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;max_deviation_rigid = 3</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;new_templ = template</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;add_to_movie = -np.min(m)</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;num_iter = 2</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;save_movie = <span class="keyword">False</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="keywordflow">for</span> iter_ <span class="keywordflow">in</span> range(num_iter):</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    print(iter_)</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    old_templ = new_templ.copy()</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    <span class="keywordflow">if</span> iter_ == num_iter-1:</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        save_movie = <span class="keyword">True</span></div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        num_splits_to_process = <span class="keywordtype">None</span></div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        print(<span class="stringliteral">&#39;saving!&#39;</span>)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    fname_tot, res = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#ab88fd1006bbd98bfc246c62eaff53366">motion_correction_piecewise</a>(fname,splits, strides, overlaps,\</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                            add_to_movie=add_to_movie, template = old_templ, max_shifts = max_shifts,max_deviation_rigid = max_deviation_rigid,\</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                            newoverlaps = newoverlaps, newstrides = newstrides,\</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;                            upsample_factor_grid = upsample_factor_grid, order = <span class="stringliteral">&#39;F&#39;</span>,dview = dview,save_movie = save_movie, base_name = fname[:-4]+ <span class="stringliteral">&#39;_els_opencv_&#39;</span>,num_splits=num_splits_to_process,shifts_opencv = shifts_opencv)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    new_templ = np.nanmedian(np.dstack([r[-1] <span class="keywordflow">for</span> r <span class="keywordflow">in</span> res ]),-1)</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">#    print((old_div(np.linalg.norm(new_templ-old_templ),np.linalg.norm(old_templ))))</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">#    pl.imshow(new_templ,cmap = &#39;gray&#39;,vmax = np.percentile(new_templ,99))</span></div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">#    pl.pause(.1)</span></div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;t2 = time.time() - t1</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;print(t2)</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;mc = cm.load(fname_tot) </div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;pl.imshow(new_templ,cmap = <span class="stringliteral">&#39;gray&#39;</span>,vmax = np.percentile(new_templ,95))       </div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160; <span class="comment">#%%</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;np.save(fname[:-4]+<span class="stringliteral">&#39;_templ_pw_rigid.npy&#39;</span>,new_templ)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="comment">#scipy.io.savemat(&#39;/mnt/xfs1/home/agiovann/dropbox/Python_progress/&#39; + str(np.shape(m)[-1])+&#39;_templ_pw_rigid.mat&#39;,{&#39;template&#39;:templ_to_save}) </span></div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="keyword">def </span><a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(fname,final_size_x,final_size_y, swap_dim,pyr_scale = .5,levels = 3,winsize = 100, iterations = 15, poly_n = 5, poly_sigma = 1.2/5, flags = 0,\</div><div class="line"><a name="l00307"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">  307</a></span>&#160;                                      play_flow = False, resize_fact_flow = .2,template = None):</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    </div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;    <span class="comment">#cv2.OPTFLOW_FARNEBACK_GAUSSIAN</span></div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    <span class="keyword">import</span> scipy</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    vmin, vmax = -1, 1</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    m = cm.load(fname)</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    </div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;    </div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    max_shft_x = np.int(np.ceil((np.shape(m)[1]-final_size_x)/2))</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    max_shft_y = np.int(np.ceil((np.shape(m)[2]-final_size_y)/2))</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;    max_shft_x_1 = - ( (np.shape(m)[1]-max_shft_x)-(final_size_x) )</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    max_shft_y_1 = - ( (np.shape(m)[2]-max_shft_y)-(final_size_y) )</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;    <span class="keywordflow">if</span> max_shft_x_1 == 0:</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        max_shft_x_1 = <span class="keywordtype">None</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;        </div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;    <span class="keywordflow">if</span> max_shft_y_1 == 0:</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;        max_shft_y_1 = <span class="keywordtype">None</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">#    print ([max_shft_x,max_shft_x_1,max_shft_y,max_shft_y_1])    </span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    m = m[:,max_shft_x:max_shft_x_1,max_shft_y:max_shft_y_1]</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;    print(<span class="stringliteral">&#39;Local correlations..&#39;</span>)</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    img_corr = m.local_correlations(eight_neighbours=<span class="keyword">True</span>, swap_dim = swap_dim)</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    <span class="keywordflow">print</span> (m.shape)</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="keywordflow">if</span> template <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;        tmpl = cm.motion_correction.bin_median(m)</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    <span class="keywordflow">else</span>:</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;        tmpl = template</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">#    tmpl = tmpl[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y]</span></div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;    </div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    </div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;    print(<span class="stringliteral">&#39;Compute Smoothness.. &#39;</span>)</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    smoothness = np.sqrt(np.sum(np.sum(np.array(np.gradient(np.mean(m,0)))**2,0)))</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    smoothness_corr = np.sqrt(np.sum(np.sum(np.array(np.gradient(img_corr))**2,0)))</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    </div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    print(<span class="stringliteral">&#39;Compute correlations.. &#39;</span>)</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    correlations = []</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;    count = 0</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">for</span> fr <span class="keywordflow">in</span> m:</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;         <span class="keywordflow">if</span> count%100 == 0:</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            print(count)   </div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;        </div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;         count +=1    </div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;         correlations.append(scipy.stats.pearsonr(fr.flatten(),tmpl.flatten())[0]) </div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;        </div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    print(<span class="stringliteral">&#39;Compute optical flow .. &#39;</span>)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    </div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    m = m.resize(1,1,resize_fact_flow)</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    norms = []</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    flows = []</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    count = 0</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">for</span> fr <span class="keywordflow">in</span> m:</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;        </div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;        <span class="keywordflow">if</span> count%100 == 0:</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;            print(count)   </div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;        </div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;        count +=1    </div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;        flow = cv2.calcOpticalFlowFarneback(tmpl,fr,<span class="keywordtype">None</span>,pyr_scale, levels, winsize, iterations, poly_n, poly_sigma, flags)</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;        </div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;        <span class="keywordflow">if</span> play_flow:</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;            pl.subplot(1,3,1)    </div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;            pl.cla()    </div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;            pl.imshow(fr,vmin = 0, vmax = 300, cmap = <span class="stringliteral">&#39;gray&#39;</span> )       </div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;            pl.title(<span class="stringliteral">&#39;movie&#39;</span>)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;            </div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;            pl.subplot(1,3,3)    </div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;            pl.cla()    </div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;            pl.imshow(flow[:,:,1],vmin=vmin,vmax=vmax)       </div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            pl.title(<span class="stringliteral">&#39;y_flow&#39;</span>)</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            </div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;            pl.subplot(1,3,2)    </div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;            pl.cla()    </div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;            pl.imshow(flow[:,:,0],vmin=vmin,vmax=vmax)       </div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            pl.title(<span class="stringliteral">&#39;x_flow&#39;</span>)</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;            pl.pause(.05)</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            </div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;            </div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        n = np.linalg.norm(flow)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;        flows.append(flow)</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;        norms.append(n)</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;        </div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    </div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;        </div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;    </div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    </div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    np.savez(fname[:-4]+<span class="stringliteral">&#39;_metrics&#39;</span>,flows = flows, norms = norms, correlations = correlations,smoothness=smoothness,tmpl = tmpl, smoothness_corr = smoothness_corr, img_corr = img_corr)</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    <span class="keywordflow">return</span> tmpl, correlations, flows, norms, smoothness</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    </div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="comment">#%% run comparisons MLK</span></div><div class="line"><a name="l00395"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ab568b2aedeb1c578414fdedede7c7278">  395</a></span>&#160;m_res = glob.glob(<span class="stringliteral">&#39;MKL*hdf5&#39;</span>)</div><div class="line"><a name="l00396"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aeb9ab35108f761d8b8031b0f05026065">  396</a></span>&#160;final_size = (512-24,512-24)</div><div class="line"><a name="l00397"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a2c3e31d81d46bbbeb6806197ad289967">  397</a></span>&#160;winsize = 100</div><div class="line"><a name="l00398"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a6f979c38c0b7d4b189a04b43fd074e5e">  398</a></span>&#160;swap_dim = <span class="keyword">False</span></div><div class="line"><a name="l00399"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ab01c95cabcbd004a27a0c68ca7e1d07d">  399</a></span>&#160;resize_fact_flow = .2</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_res:</div><div class="line"><a name="l00401"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1c854bbf850a868de0d797133fb8c15b">  401</a></span>&#160;    tmpl, correlations, flows_orig, norms,smoothness  = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],swap_dim, winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="comment">#%% run comparisons NORMCORRE</span></div><div class="line"><a name="l00405"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1f34e6b2c326353e26d80c6352a4bb0e">  405</a></span>&#160;m_fluos = glob.glob(<span class="stringliteral">&#39;M_FLUO*.mmap&#39;</span>) + glob.glob(<span class="stringliteral">&#39;M_FLUO*.tif&#39;</span>) </div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;final_size = (64-20,128-20)</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;winsize = 32</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;resize_fact_flow = 1</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_fluos:</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="comment">#% run comparisons resonant</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;m_res = glob.glob(<span class="stringliteral">&#39;Sue*mmap&#39;</span>) + glob.glob(<span class="stringliteral">&#39;Sue*.tif&#39;</span>)  </div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;final_size = (512-24,512-24)</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;winsize = 100</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;swap_dim = <span class="keyword">False</span></div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;resize_fact_flow = .2</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_res:</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness  = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],swap_dim, winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;<span class="comment">#%% run comparisons SIMA</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;m_fluos = glob.glob(<span class="stringliteral">&#39;plane*.tif&#39;</span>) + glob.glob(<span class="stringliteral">&#39;row*.tif&#39;</span>) </div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;final_size = (64-20,128-20)</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;winsize = 32</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;resize_fact_flow = 1</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_fluos:</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;<span class="comment">#% run comparisons resonant</span></div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;m_res = glob.glob(<span class="stringliteral">&#39;Sue*.tif&#39;</span>)  </div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;final_size = (512-24,512-24)</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;winsize = 100</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;resize_fact_flow = .2</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_res:</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness  = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;<span class="comment">#%% run comparisons SUITE2P</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;<span class="keywordflow">for</span> mvs <span class="keywordflow">in</span> glob.glob(<span class="stringliteral">&#39;Sue*2000*16*.mat&#39;</span>):</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    <span class="keywordflow">print</span> (mvs)</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    cm.movie(scipy.io.loadmat(mvs)[<span class="stringliteral">&#39;data&#39;</span>].transpose([2,0,1])).<a class="code" href="to__python__format_8m.html#ac42abb663b6292b7a30912190e66b7d3">save</a>(mvs[:-3]+<span class="stringliteral">&#39;.hdf5&#39;</span>)</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;m_fluos = glob.glob(<span class="stringliteral">&#39;M_FLUO*.hdf5&#39;</span>)</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;final_size = (64-20,128-20)</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;winsize = 32</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;resize_fact_flow = 1</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_fluos:</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;<span class="comment">#% run comparisons resonant</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;m_res = glob.glob(<span class="stringliteral">&#39;Sue_2000*16*.hdf5&#39;</span>)  </div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;final_size = (512-24,512-24)</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;winsize = 100</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;resize_fact_flow = .2</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;<span class="keywordflow">for</span> mv <span class="keywordflow">in</span> m_res:</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    tmpl, correlations, flows_orig, norms,smoothness  = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(mv,final_size[0],final_size[1],winsize=winsize , play_flow=<span class="keyword">False</span>, resize_fact_flow=resize_fact_flow)</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;<span class="comment">#%% plot the results</span></div><div class="line"><a name="l00453"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a5babce84f438f931e25193a656aba164">  453</a></span>&#160;files_img = [<span class="stringliteral">u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/NORM_CORRE_OPENCV/Sue_2000_els_opencv__d1_512_d2_512_d3_1_order_F_frames_2000_._metrics.npz&#39;</span>,</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;             <span class="stringliteral">u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/NORMCORRE_EFF/Sue_2000_els__d1_512_d2_512_d3_1_order_F_frames_2000_._metrics.npz&#39;</span>,</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">#             u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/MLK/Sue_2000_MLK_metrics.npz&#39;,</span></div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment">#             u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/SIMA_RESULTS/Sue_1000_T.tifrow1_example_sima_Trow1_example_sima_metrics.npz&#39;,</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">#             u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/SUITE_2P_RES/Sue_2000_t_NB_16.._metrics.npz&#39;,</span></div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;             <span class="stringliteral">u&#39;/mnt/xfs1/home/agiovann/DataForPublications/Piecewise-Rigid-Analysis-paper/MLK/MKL16T._metrics.npz&#39;</span>] </div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">#for fl in glob.glob(&#39;*.npz&#39;):</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="keywordflow">for</span> fl <span class="keywordflow">in</span> files_img:    </div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    with np.load(fl) <span class="keyword">as</span> ld:</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        print(ld.keys())</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;        pl.figure()</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;        print(fl + <span class="stringliteral">&#39;:&#39;</span> + str(np.mean(ld[<span class="stringliteral">&#39;norms&#39;</span>])) + <span class="stringliteral">&#39;+/-&#39;</span> + str(np.std(ld[<span class="stringliteral">&#39;norms&#39;</span>])) + <span class="stringliteral">&#39; ; &#39;</span> + str(np.mean(ld[<span class="stringliteral">&#39;correlations&#39;</span>])) + <span class="stringliteral">&#39;+/-&#39;</span> + str(np.std(ld[<span class="stringliteral">&#39;correlations&#39;</span>])) + <span class="stringliteral">&#39; ; &#39;</span> + str(ld[<span class="stringliteral">&#39;smoothness&#39;</span>]) + <span class="stringliteral">&#39; ; &#39;</span> + str(ld[<span class="stringliteral">&#39;smoothness_corr&#39;</span>]))</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;        pl.subplot(1,2,1)</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;        <span class="keywordflow">try</span>:</div><div class="line"><a name="l00467"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae26a0b2f2e0b42080986515672674a38">  467</a></span>&#160;            mean_img = np.mean(cm.load(fl[:-12]+<span class="stringliteral">&#39;mmap&#39;</span>),0)[12:-12,12:-12]</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;        <span class="keywordflow">except</span>:</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;            <span class="keywordflow">try</span>:</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;                mean_img = np.mean(cm.load(fl[:-12]+<span class="stringliteral">&#39;.tif&#39;</span>),0)[12:-12,12:-12]    </div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;            <span class="keywordflow">except</span>:</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;                mean_img = np.mean(cm.load(fl[:-12]+<span class="stringliteral">&#39;hdf5&#39;</span>),0)[12:-12,12:-12]        </div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="comment">#        lq,hq = np.nanpercentile(mean_img,[.1,99.9])</span></div><div class="line"><a name="l00474"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a96135a7b659062db97bd3c8f41f859a8">  474</a></span>&#160;        lq, hq = 13.3, 318.01</div><div class="line"><a name="l00475"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af0d5eb5af7b3da35f3ad085dff317238">  475</a></span>&#160;        pl.imshow(mean_img,vmin = lq,vmax = hq)</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;        pl.colorbar()</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="comment">#        pl.plot(ld[&#39;correlations&#39;])</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;        </div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;        pl.subplot(1,2,2)</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;        pl.imshow(ld[<span class="stringliteral">&#39;img_corr&#39;</span>],vmin = 0,vmax =.5)</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;        pl.colorbar()</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="keywordflow">for</span> fl <span class="keywordflow">in</span> glob.glob(<span class="stringliteral">&#39;Mf*.npz&#39;</span>):</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    with np.load(fl) <span class="keyword">as</span> ld:</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;        print(ld.keys())</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;        pl.figure()</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;        print(fl + <span class="stringliteral">&#39;:&#39;</span> + str(np.mean(ld[<span class="stringliteral">&#39;norms&#39;</span>])) + <span class="stringliteral">&#39;+/-&#39;</span> + str(np.std(ld[<span class="stringliteral">&#39;norms&#39;</span>])) + <span class="stringliteral">&#39; ; &#39;</span> + str(np.mean(ld[<span class="stringliteral">&#39;correlations&#39;</span>])) + <span class="stringliteral">&#39;+/-&#39;</span> + str(np.std(ld[<span class="stringliteral">&#39;correlations&#39;</span>])) + <span class="stringliteral">&#39; ; &#39;</span> + str(ld[<span class="stringliteral">&#39;smoothness&#39;</span>]) + <span class="stringliteral">&#39; ; &#39;</span> + str(ld[<span class="stringliteral">&#39;smoothness_corr&#39;</span>]))</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;     </div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        </div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="comment">#total_shifts = []</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;<span class="comment">#start_steps = []</span></div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">#xy_grids = []</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">#mc = np.zeros(m.shape)</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="comment">#for count,img in enumerate(np.array(m)):</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;<span class="comment">#    if count % 10  == 0:</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">#        print(count)</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">#    mc[count],total_shift,start_step,xy_grid = tile_and_correct(img, template, strides, overlaps,(12,12), newoverlaps = None, \</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">#                newstrides = newstrides, upsample_factor_grid=upsample_factor_grid,\</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="comment">#                upsample_factor_fft=10,show_movie=False,max_deviation_rigid=2,add_to_movie=add_to_movie)</span></div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="comment">#    total_shifts.append(total_shift)</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">#    start_steps.append(start_step)</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="comment">#    xy_grids.append(xy_grid)</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;<span class="comment">#mc = cm.load(&#39;M_FLUO_4_d1_64_d2_128_d3_1_order_F_frames_4620_.mmap&#39;)</span></div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">#mc = cm.load(&#39;M_FLUO_t_d1_64_d2_128_d3_1_order_F_frames_6764_.mmap&#39;)</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00513"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a7a229a4786deeddd59c6091247a8c8a6">  513</a></span>&#160;mc.resize(1,1,.1).play(gain=10.,fr = 30, offset = 100,magnification=1.)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;m.resize(1,1,.2).play(gain=10,fr = 30, offset = 0,magnification=1.)</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00517"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#accc088009d44c521706aa98d6387ee21">  517</a></span>&#160;cm.concatenate([mr.resize(1,1,.5),mc.resize(1,1,.5)],axis=1).play(gain=10,fr = 100, offset = 300,magnification=1.)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="keyword">import</span> h5py</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;with  h5py.File(<span class="stringliteral">&#39;sueann_pw_rigid_movie.mat&#39;</span>) <span class="keyword">as</span> f:</div><div class="line"><a name="l00522"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a88d3c6be19cad13570a2d716513360df">  522</a></span>&#160;    mef = np.array(f[<span class="stringliteral">&#39;M2&#39;</span>])</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;mef = cm.movie(mef.transpose([0,2,1]))    </div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;cm.concatenate([mef.resize(1,1,.15),mc.resize(1,1,.15)],axis=1).play(gain=30,fr = 40, offset = 300,magnification=1.)</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;(mef-mc).resize(1,1,.1).play(gain=50,fr = 20, offset = 0,magnification=1.)</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;(mc-mef).resize(1,1,.1).play(gain=50,fr = 20, offset = 0,magnification=1.)</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00533"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#adf1f3edb9115acb0a1e04209b7a9937b">  533</a></span>&#160;T,d1,d2 = np.shape(m)</div><div class="line"><a name="l00534"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aeab382666f8e614bca97fa34490135b4">  534</a></span>&#160;shape_mov = (d1*d2,m.shape[0])</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a0867f43e27585e019c13f7f4b7c4ab6b">  536</a></span>&#160;Y = np.memmap(<span class="stringliteral">&#39;M_FLUO_4_d1_64_d2_128_d3_1_order_F_frames_4620_.mmap&#39;</span>,mode = <span class="stringliteral">&#39;r&#39;,dtype=np.float32, shape=shape_mov, order=&#39;</span>F&#39;)</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;mc = cm.movie(np.reshape(Y,(d2,d1,T),order = <span class="stringliteral">&#39;F&#39;</span>).transpose([2,1,0]))</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;mc.resize(1,1,.25).play(gain=10.,fr=50)</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;total_shifts = [r[0][0][0] <span class="keywordflow">for</span> r <span class="keywordflow">in</span> res]</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;pl.plot(np.reshape(np.array(total_shifts),(len(total_shifts),-1))) </div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">#m_raw = cm.motion_correction.bin_median(m,exclude_nans=True)</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">#m_rig = cm.motion_correction.bin_median(mr,exclude_nans=True)</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">#m_el = cm.motion_correction.bin_median(mc,exclude_nans=True)</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;m_raw = np.nanmean(m,0)</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;m_rig = np.nanmean(mr,0)</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;m_el = np.nanmean(mc,0)</div><div class="line"><a name="l00553"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a84fad03851d66db4a2494ddf0317c2f0">  553</a></span>&#160;m_ef = np.nanmean(mef,0)</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keyword">import</span> scipy</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;r_raw = []</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;r_rig = []</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;r_el = []</div><div class="line"><a name="l00559"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1b76aa9a6e9d1b6bf007652885935247">  559</a></span>&#160;r_ef = []</div><div class="line"><a name="l00560"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#afe828ab26f637c170e8ba8d57c54e748">  560</a></span>&#160;max_shft_x, max_shft_y = max_shifts</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">for</span> fr_id <span class="keywordflow">in</span> range(m.shape[0]):</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;    fr = m[fr_id].copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    templ_ = m_raw.copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;    r_raw.append(scipy.stats.pearsonr(fr.flatten(),templ_.flatten())[0]) </div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;    fr = mr[fr_id].copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;    templ_ = m_rig.copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]    </div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;    r_rig.append(scipy.stats.pearsonr(fr.flatten(),templ_.flatten())[0]) </div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;    fr = mc[fr_id].copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    templ_ = m_el.copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]    </div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    r_el.append(scipy.stats.pearsonr(fr.flatten(),templ_.flatten())[0])        </div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordflow">if</span> 1:</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        fr = mef[fr_id].copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;        templ_ = m_ef.copy()[max_shft_x:-max_shft_x,max_shft_y :-max_shft_y]    </div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;        r_ef.append(scipy.stats.pearsonr(fr.flatten(),templ_.flatten())[0])   </div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;r_raw =np.array(r_raw)</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;r_rig =np.array(r_rig)     </div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;r_el =np.array(r_el)     </div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;r_ef =np.array(r_ef)        </div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">#r_ef = scipy.io.loadmat(&#39;sueann.mat&#39;)[&#39;cM2&#39;].squeeze()</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">#r_efr = scipy.io.loadmat(&#39;sueann.mat&#39;)[&#39;cY&#39;].squeeze()</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">#pl.close()</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;pl.plot(r_raw)</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;pl.plot(r_rig)</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;pl.plot(r_el)</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment">#pl.plot(r_ef)</span></div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;pl.scatter(r_el,r_ef)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;pl.plot([0,1],[0,1],<span class="stringliteral">&#39;r--&#39;</span>)</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;pl.plot(old_div((r_ef-r_el),np.abs(r_el)))</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keyword">import</span> pylab <span class="keyword">as</span> pl</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;vmax=-100</div><div class="line"><a name="l00600"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#adc3ed9e6930be764fc8ff2681041d7d8">  600</a></span>&#160;max_shft = 3</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;pl.subplot(3,3,1);</div><div class="line"><a name="l00606"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a65a86ebae492ca78e26c87ad0d7de7aa">  606</a></span>&#160;pl.imshow(np.nanmean(m,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>,vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;pl.title(<span class="stringliteral">&#39;raw&#39;</span>)</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;pl.subplot(3,3,2);</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;pl.title(<span class="stringliteral">&#39;rigid mean&#39;</span>)</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;pl.imshow(np.nanmean(mr,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>, vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>);</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;pl.subplot(3,3,3);</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;pl.imshow(np.nanmean(mc,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>,vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;pl.title(<span class="stringliteral">&#39;pw-rigid mean&#39;</span>)</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;pl.subplot(3,3,5)</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;pl.scatter(r_raw,r_rig)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;pl.plot([0,1],[0,1],<span class="stringliteral">&#39;r--&#39;</span>)</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;pl.xlabel(<span class="stringliteral">&#39;raw&#39;</span>)</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;pl.ylabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;pl.xlim([0,1])</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;pl.ylim([0,1])</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;pl.subplot(3,3,6)</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;pl.scatter(r_rig,r_el)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;pl.plot([0,1],[0,1],<span class="stringliteral">&#39;r--&#39;</span>)</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;pl.ylabel(<span class="stringliteral">&#39;pw-rigid&#39;</span>)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;pl.xlabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;pl.xlim([0,1])</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;pl.ylim([0,1])</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keywordflow">if</span> 0:</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    pl.subplot(2,3,3);</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;    pl.scatter(r_el,r_ef)</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    pl.plot([0,1],[0,1],<span class="stringliteral">&#39;r--&#39;</span>)</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;    pl.ylabel(<span class="stringliteral">&#39;pw-rigid&#39;</span>)</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;    pl.xlabel(<span class="stringliteral">&#39;pw-rigid eft&#39;</span>)</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;    pl.xlim([0,1])</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;    pl.ylim([0,1])</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    pl.subplot(2,3,6);</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    pl.imshow(np.nanmean(mef,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>,vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;    pl.title(<span class="stringliteral">&#39;pw-rigid eft mean&#39;</span>)</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;pl.plot(r_ef)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;mc = cm.movie(mc)</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;mc[np.isnan(mc)] = 0</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="comment">#%% play movie</span></div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;(mc+add_to_movie).resize(1,1,.25).play(gain=10.,fr=50)</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="comment">#%% compute correlation images</span></div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;ccimage = m.local_correlations(eight_neighbours=<span class="keyword">True</span>,swap_dim=<span class="keyword">False</span>)</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;ccimage_rig = mr.local_correlations(eight_neighbours=<span class="keyword">True</span>,swap_dim=<span class="keyword">False</span>)</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;ccimage_els = mc.local_correlations(eight_neighbours=<span class="keyword">True</span>,swap_dim=<span class="keyword">False</span>)</div><div class="line"><a name="l00669"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aca614de2bc7cf2e19dfea3eab54eb560">  669</a></span>&#160;ccimage_ef = mef.local_correlations(eight_neighbours=<span class="keyword">True</span>,swap_dim=<span class="keyword">False</span>)</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="comment">#%% check correlation images</span></div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;pl.subplot(2,2,1)</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;pl.imshow(ccimage,vmin = 0, vmax = 0.4, interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;pl.subplot(2,2,2)</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;pl.imshow(ccimage_rig,vmin = 0, vmax = 0.4, interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;pl.subplot(2,2,3)</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;pl.imshow(ccimage_els,vmin = 0, vmax = 0.4, interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;pl.subplot(2,2,4)</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;pl.imshow(ccimage_ef,vmin = 0, vmax = 0.4, interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00680"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac8ecda5f171822944210a41004e6a003">  680</a></span>&#160;all_mags = [] </div><div class="line"><a name="l00681"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a4391d4b4cbd4cd2d5048d4437158594d">  681</a></span>&#160;all_mags_eig = [] </div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;<span class="keywordflow">for</span> chunk <span class="keywordflow">in</span> res:</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <span class="keywordflow">for</span> frame <span class="keywordflow">in</span> chunk[0]:</div><div class="line"><a name="l00684"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aabe4cc6cbcf137dd33b51da9e1516022">  684</a></span>&#160;        shifts,pos,init = frame</div><div class="line"><a name="l00685"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a8e5f32e0e15ca5991ed96672dbad83f5">  685</a></span>&#160;        x_sh = np.zeros(np.add(init[-1],1))</div><div class="line"><a name="l00686"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae1c9be50038ce0a5b3f713232de0d2fe">  686</a></span>&#160;        y_sh = np.zeros(np.add(init[-1],1))</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;        <span class="keywordflow">for</span> nt,sh <span class="keywordflow">in</span> zip(init,shifts):</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;            x_sh[nt] = sh[0]</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;            y_sh[nt] = sh[1]</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;</div><div class="line"><a name="l00692"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ad6d11f1d71dbd99daa41988c7be0ccd9">  692</a></span>&#160;        jac_xx = x_sh[1:,:] - x_sh[:-1,:]</div><div class="line"><a name="l00693"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac2492db6f3c9d0cc7b7ce5786588ae99">  693</a></span>&#160;        jac_yx = y_sh[1:,:] - y_sh[:-1,:]</div><div class="line"><a name="l00694"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a6b9698389f45ecc276eae5eb89c72f6c">  694</a></span>&#160;        jac_xy = x_sh[:,1:] - x_sh[:,:-1]</div><div class="line"><a name="l00695"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af38e3b1a4035f401f549d41f89f4786e">  695</a></span>&#160;        jac_yy = y_sh[:,1:] - y_sh[:,:-1]</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aaff44ce33bf6c4c7da1c3eb4d7a35ce9">  697</a></span>&#160;        mag_norm = np.sqrt(jac_xx[:,:-1]**2 + jac_yx[:,:-1]**2 + jac_xy[:-1,:]**2 +  jac_yy[:-1,:]**2)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;        all_mags.append(mag_norm)</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="comment">#        pl.cla()            </span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;<span class="comment">#        pl.imshow(mag_norm,vmin=0,vmax =1,interpolation = &#39;none&#39;)</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="comment">#        pl.pause(.1)</span></div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00705"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a9aeb96c8da9bd63888b00fc28af9e1d6">  705</a></span>&#160;mam = cm.movie(np.dstack(all_mags)).transpose([2,0,1])</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;<span class="comment">#mam.play(magnification=10,gain = 5.)</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;pl.imshow(np.max(mam,0),interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;m = cm.load(<span class="stringliteral">&#39;rig_sue__d1_512_d2_512_d3_1_order_F_frames_3000_.mmap&#39;</span>)</div><div class="line"><a name="l00711"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aa7fb79750993e7512e30b1124da6563c">  711</a></span>&#160;m1 = cm.load(<span class="stringliteral">&#39;els_sue__d1_512_d2_512_d3_1_order_F_frames_3000_.mmap&#39;</span>)</div><div class="line"><a name="l00712"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a6e6df7034531bdc0e8c713e42caf38a7">  712</a></span>&#160;m0 = cm.load(<span class="stringliteral">&#39;k56_20160608_RSM_125um_41mW_zoom2p2_00001_00034.tif&#39;</span>)</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;tmpl = cm.motion_correction.bin_median(m)</div><div class="line"><a name="l00714"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a02f1b337c42bb03686b2d37699f4b56f">  714</a></span>&#160;tmpl1 = cm.motion_correction.bin_median(m1)</div><div class="line"><a name="l00715"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae993389a577361dbce0e022fd548bd98">  715</a></span>&#160;tmpl0 = cm.motion_correction.bin_median(m0)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;vmin, vmax = -1, 1</div><div class="line"><a name="l00719"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ad43c3812e6d13e0518d9f8b8f463ffcf">  719</a></span>&#160;count = 0</div><div class="line"><a name="l00720"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae9ebe6fae685c6a9e946d7e6e5ccd0cd">  720</a></span>&#160;pyr_scale = .5 </div><div class="line"><a name="l00721"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a494d6f580c2a5363542d4d2258575f5c">  721</a></span>&#160;levels = 3</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;winsize = 100 </div><div class="line"><a name="l00723"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1d10e252e778731e59f0f71afd7e727e">  723</a></span>&#160;iterations = 15</div><div class="line"><a name="l00724"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aa6dba1ebafbae63e342290a2a0362317">  724</a></span>&#160;poly_n = 5</div><div class="line"><a name="l00725"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac9489860a9064132d8a03751ba6cfe2c">  725</a></span>&#160;poly_sigma = old_div(1.2,5)</div><div class="line"><a name="l00726"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ac8bf36fe0577cba66bccda3a6f7e80a4">  726</a></span>&#160;flags = 0 <span class="comment">#cv2.OPTFLOW_FARNEBACK_GAUSSIAN</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;norms = []</div><div class="line"><a name="l00728"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#afc5e137403c2782f0c00080d1e6c77e1">  728</a></span>&#160;flows = []</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="keywordflow">for</span> fr,fr1,fr0 <span class="keywordflow">in</span> zip(m.resize(1,1,.2),m1.resize(1,1,.2),m0.resize(1,1,.2)):</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    count +=1</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    print(count)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;</div><div class="line"><a name="l00733"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#accee2133c0f391624593dbdac7281d71">  733</a></span>&#160;    flow1 = cv2.calcOpticalFlowFarneback(tmpl1[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],fr1[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],<span class="keywordtype">None</span>,pyr_scale, levels, winsize, iterations, poly_n, poly_sigma, flags);</div><div class="line"><a name="l00734"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a0dc7d0fe5a8f75433aa8d560f6fe1001">  734</a></span>&#160;    flow = cv2.calcOpticalFlowFarneback(tmpl[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],fr[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],<span class="keywordtype">None</span>,pyr_scale, levels, winsize, iterations, poly_n, poly_sigma, flags);</div><div class="line"><a name="l00735"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a0e1333221a2e29c0c424151896376e6a">  735</a></span>&#160;    flow0 = cv2.calcOpticalFlowFarneback(tmpl0[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],fr0[max_shft_x:-max_shft_x,max_shft_y:-max_shft_y],<span class="keywordtype">None</span>,pyr_scale, levels, winsize, iterations, poly_n, poly_sigma, flags);</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="comment">#    pl.subplot(2,3,1)    </span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;<span class="comment">#    pl.cla()    </span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment">#    pl.imshow(flow1[:,:,1],vmin=vmin,vmax=vmax)       </span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="comment">#    pl.subplot(2,3,2)    </span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment">#    pl.cla()</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="comment">#    pl.imshow(flow[:,:,1],vmin=vmin,vmax=vmax)     </span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="comment">#    pl.subplot(2,3,3)       </span></div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="comment">#    pl.cla()</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="comment">#    pl.imshow(flow0[:,:,1],vmin=vmin,vmax=vmax)         </span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="comment">#    </span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;<span class="comment">#    pl.subplot(2,3,4)    </span></div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="comment">#    pl.cla()    </span></div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="comment">#    pl.imshow(flow1[:,:,0],vmin=vmin,vmax=vmax)       </span></div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;<span class="comment">#    pl.subplot(2,3,5)    </span></div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="comment">#    pl.cla()</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment">#    pl.imshow(flow[:,:,0],vmin=vmin,vmax=vmax)     </span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">#    pl.subplot(2,3,6)       </span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment">#    pl.cla()</span></div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">#    pl.imshow(flow0[:,:,0],vmin=vmin,vmax=vmax)         </span></div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="comment">#    pl.pause(.1)</span></div><div class="line"><a name="l00757"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a10be10844f9c3c7a197a6adb759acba0">  757</a></span>&#160;    n1,n,n0 = np.linalg.norm(flow1), np.linalg.norm(flow), np.linalg.norm(flow0)</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    flows.append([flow1,flow,flow0])</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    norms.append([n1,n,n0 ])</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00761"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae230b29ee8bb13d93ff660f8cea738ac">  761</a></span>&#160;flm1_x = cm.movie(np.dstack( [fl[0][:,:,0] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00762"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a8c38087de355e054bf93b2b358ed494a">  762</a></span>&#160;flm_x = cm.movie(np.dstack( [fl[1][:,:,0] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00763"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ad83848d5397d907ad398a434b1dd4090">  763</a></span>&#160;flm0_x = cm.movie(np.dstack( [fl[2][:,:,0] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;</div><div class="line"><a name="l00765"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a779f6f50da3accf44cdeed2313761e22">  765</a></span>&#160;flm1_y = cm.movie(np.dstack( [fl[0][:,:,1] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00766"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a32c7ffc81b86fe99ddf1d49e1512aa49">  766</a></span>&#160;flm_y = cm.movie(np.dstack( [fl[1][:,:,1] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00767"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a8225c23e1ae8e80dd6d64166f348551b">  767</a></span>&#160;flm0_y = cm.movie(np.dstack( [fl[2][:,:,1] <span class="keywordflow">for</span> fl  <span class="keywordflow">in</span> flows])).transpose([2,0,1])</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;pl.figure()</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;pl.subplot(2,1,1)</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;pl.plot(norms)</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;pl.subplot(2,1,2)</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_el)</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_rig)</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_raw)</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;<span class="comment">#%% compare to optical flow</span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;pl.figure()</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;vmin = -.5</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;vmax = .5</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;cmap = <span class="stringliteral">&#39;hot&#39;</span></div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;pl.subplot(2,3,1)</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;pl.imshow(np.mean(np.abs(flm1_x),0),vmin = vmin, vmax = vmax,cmap=cmap)</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;pl.title(<span class="stringliteral">&#39;PW-RIGID&#39;</span>)</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;pl.ylabel(<span class="stringliteral">&#39;optical flow x&#39;</span>)</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;pl.colorbar()</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;pl.subplot(2,3,2)</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;pl.title(<span class="stringliteral">&#39;RIGID&#39;</span>)</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;pl.imshow(np.mean(np.abs(flm_x),0),vmin = vmin, vmax = vmax,cmap=cmap)</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;pl.colorbar()</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;pl.subplot(2,3,3)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;pl.imshow(np.mean(np.abs(flm0_x),0),vmin = vmin*4, vmax = vmax*4,cmap=cmap)</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;pl.title(<span class="stringliteral">&#39;RAW&#39;</span>)</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;pl.colorbar()</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;pl.subplot(2,3,4)</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;pl.imshow(np.mean(np.abs(flm1_y),0),vmin = vmin, vmax = vmax,cmap=cmap)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;pl.ylabel(<span class="stringliteral">&#39;optical flow y&#39;</span>)</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;pl.colorbar()</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;pl.subplot(2,3,5)</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;pl.imshow(np.mean(np.abs(flm_y),0),vmin = vmin, vmax = vmax,cmap=cmap)</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;pl.colorbar()</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;pl.subplot(2,3,6)</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;pl.imshow(np.mean(np.abs(flm0_y),0),vmin = vmin*4, vmax = vmax*4,cmap=cmap)</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;pl.colorbar()</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00807"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a09cfe54eee84f0564a97f77fa0f658ae">  807</a></span>&#160;fl_rig = [n[1]/1000 <span class="keywordflow">for</span> n <span class="keywordflow">in</span> norms]</div><div class="line"><a name="l00808"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a2e1a537f8656385fcc333becfdcd0da7">  808</a></span>&#160;fl_raw = [n[2]/1000 <span class="keywordflow">for</span> n <span class="keywordflow">in</span> norms]</div><div class="line"><a name="l00809"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1ccf32c8ad7dc99341d3f188d1b03e56">  809</a></span>&#160;fl_el = [n[0]/1000 <span class="keywordflow">for</span> n <span class="keywordflow">in</span> norms]</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;</div><div class="line"><a name="l00812"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a6cd5922b1316a58f3ac11f4478bc123d">  812</a></span>&#160;font = {<span class="stringliteral">&#39;family&#39;</span> : <span class="stringliteral">&#39;Myriad Pro&#39;</span>,</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        <span class="stringliteral">&#39;weight&#39;</span> : <span class="stringliteral">&#39;regular&#39;</span>,</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        <span class="stringliteral">&#39;size&#39;</span>   : 15}</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;pl.rc(<span class="stringliteral">&#39;font&#39;</span>, **font)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;vmax=-100</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;max_shft = 3</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;pl.subplot(4,3,1);</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;pl.imshow(np.nanmean(m,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>,vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;pl.title(<span class="stringliteral">&#39;raw&#39;</span>)</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;pl.subplot(4,3,2);</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;pl.title(<span class="stringliteral">&#39;rigid mean&#39;</span>)</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;pl.imshow(np.nanmean(mr,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>, vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>);</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;pl.subplot(4,3,3);</div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;pl.imshow(np.nanmean(mc,0)[max_shft:-max_shft,max_shft:-max_shft],cmap=<span class="stringliteral">&#39;gray&#39;</span>,vmax = vmax,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;pl.title(<span class="stringliteral">&#39;pw-rigid mean&#39;</span>)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;pl.xlim([0,100])</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;pl.ylim([220,320])</div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;pl.subplot(4,3,5)</div><div class="line"><a name="l00846"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a3691308f2a4c2f6983f2880d32e29c84">  846</a></span>&#160;pl.scatter(r_raw,r_rig,s = 50, c = <span class="stringliteral">&#39;red&#39;</span>)</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;pl.axis(<span class="stringliteral">&#39;tight&#39;</span>)</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;pl.plot([0,1],[0,1],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;pl.xlabel(<span class="stringliteral">&#39;raw&#39;</span>)</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;pl.ylabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;pl.xlim([0.2,.45])</div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;pl.ylim([.2,.45])</div><div class="line"><a name="l00853"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a13e58ee403824cb43cb2da8248c9973e">  853</a></span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;pl.subplot(4,3,6)</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;pl.scatter(r_rig,r_el,s = 50, c = <span class="stringliteral">&#39;red&#39;</span>)</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;pl.plot([0,1],[0,1],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;pl.ylabel(<span class="stringliteral">&#39;pw-rigid&#39;</span>)</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;pl.xlabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;pl.xlim([0.3,.45])</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;pl.ylim([.3,.45])</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;</div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;pl.subplot(4,3,4)</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_el)</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_rig)</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;pl.plot(np.arange(0,3000*.2,0.2),r_raw)</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;pl.xlim([220,320])</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;pl.ylabel(<span class="stringliteral">&#39;correlation&#39;</span>)</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;pl.subplot(4,3,7)</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;pl.plot(norms)</div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;pl.xlim([220,320])</div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;pl.ylabel(<span class="stringliteral">&#39;norm of optical flow&#39;</span>)</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;pl.xlabel(<span class="stringliteral">&#39;frames&#39;</span>)</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;pl.subplot(4,3,8)</div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;pl.scatter(fl_raw,fl_rig,s = 50, c = <span class="stringliteral">&#39;red&#39;</span>)</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;pl.axis(<span class="stringliteral">&#39;tight&#39;</span>)</div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;pl.plot([0,3000],[0,3000],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;pl.xlabel(<span class="stringliteral">&#39;raw&#39;</span>)</div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;pl.ylabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;pl.xlim([0,3])</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;pl.ylim([0,3])</div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;</div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;pl.subplot(4,3,9)</div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;pl.scatter(fl_rig,fl_el,s = 50, c = <span class="stringliteral">&#39;red&#39;</span>)</div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;pl.plot([0,1000],[0,1000],<span class="stringliteral">&#39;k--&#39;</span>)</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;pl.ylabel(<span class="stringliteral">&#39;pw-rigid&#39;</span>)</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;pl.xlabel(<span class="stringliteral">&#39;rigid&#39;</span>)</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;pl.xlim([0,1])</div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;pl.ylim([0,1])</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;pl.locator_params(nbins=4)</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;</div><div class="line"><a name="l00901"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a7a67083b57b090fb77055e7cce4ad016">  901</a></span>&#160;ofl_mod_rig = np.mean(np.sqrt(flm_x**2+flm_y**2),0)</div><div class="line"><a name="l00902"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a1568c3c4a54a2416453b80e2ba68f218">  902</a></span>&#160;ofl_mod_el = np.mean(np.sqrt(flm1_x**2+flm1_y**2),0)</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;pl.subplot(4,3,10);</div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;pl.imshow(ofl_mod_el,cmap=<span class="stringliteral">&#39;hot&#39;</span>,vmin = 0, vmax = 1,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;pl.colorbar()</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;pl.subplot(4,3,11);</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;pl.imshow(ofl_mod_rig,cmap=<span class="stringliteral">&#39;hot&#39;</span>,vmin = 0, vmax = 1,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="comment">#pl.xlim([0,100])</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;<span class="comment">#pl.ylim([220,320])</span></div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;</div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;pl.subplot(4,3,12);</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;pl.imshow(ofl_mod_el,cmap=<span class="stringliteral">&#39;hot&#39;</span>,vmin = 0, vmax = 1,interpolation = <span class="stringliteral">&#39;none&#39;</span>)</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;<span class="comment">#pl.xlim([0,100])</span></div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;<span class="comment">#pl.ylim([220,320])</span></div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;pl.axis(<span class="stringliteral">&#39;off&#39;</span>)</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="comment">#font = {&#39;family&#39; : &#39;Myriad Pro&#39;,</span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">#        &#39;weight&#39; : &#39;regular&#39;,</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">#        &#39;size&#39;   : 15}</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;<span class="comment">#</span></div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;<span class="comment">#pl.rc(&#39;font&#39;, **font)</span></div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;pl.rcParams[<span class="stringliteral">&#39;pdf.fonttype&#39;</span>] = 42</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;<span class="comment">#%% test against SIMA</span></div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;<span class="keyword">import</span> sima</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;<span class="keyword">import</span> sima.motion</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;<span class="keyword">from</span> sima.motion <span class="keyword">import</span> HiddenMarkov2D</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;<span class="comment">#fname_gr = &#39;M_FLUO_t.tif&#39;</span></div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;<span class="comment">#fname_gr = &#39;Sue_1000.tif&#39;</span></div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;<span class="comment">#fname_gr = &#39;Sue_2000.tif&#39;</span></div><div class="line"><a name="l00938"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a140d458c796fb09a5589576c694f7a0d">  938</a></span>&#160;fname_gr = <span class="stringliteral">&#39;Sue_1000_T.tif&#39;</span></div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;fname_gr = <span class="stringliteral">&#39;Sue_1000_T.tifrow1_example_sima_T.tif&#39;</span></div><div class="line"><a name="l00940"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a0d3859dfb664d3076413a7444a0b41c5">  940</a></span>&#160;sequences = [sima.Sequence.create(<span class="stringliteral">&#39;TIFF&#39;</span>,fname_gr)]</div><div class="line"><a name="l00941"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a17a813ff016f566e53dfb54c93ba2913">  941</a></span>&#160;dataset = sima.ImagingDataset(sequences,fname_gr)             </div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;<span class="keyword">import</span> time</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;t1 = time.time()</div><div class="line"><a name="l00945"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aceafd7932d26aeff4dc7f3a4e57c3229">  945</a></span>&#160;granularity = <span class="stringliteral">&#39;row&#39;</span></div><div class="line"><a name="l00946"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a9d0f5cbb62c1e65161682e03db08921f">  946</a></span>&#160;gran_n = 1</div><div class="line"><a name="l00947"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aba0f8f21f571c3fd3258bae8f7b22e05">  947</a></span>&#160;mc_approach  = sima.motion.HiddenMarkov2D(granularity = (granularity,gran_n),max_displacement=max_shifts, verbose = <span class="keyword">True</span>,n_processes  = 14)</div><div class="line"><a name="l00948"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#abc30d394492f9660ce1f25d6c6c7bff8">  948</a></span>&#160;new_dataset = mc_approach.correct(dataset,<span class="keywordtype">None</span>)</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;t2 =time.time() - t1</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;print(t2)</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00952"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a36910ddc19d1bf237b12507db74f71a2">  952</a></span>&#160;new_dataset.export_frames([[[fname_gr[:-4] + granularity  + str(gran_n) + <span class="stringliteral">&#39;_example_sima.tif&#39;</span>]]], fmt=<span class="stringliteral">&#39;TIFF16&#39;</span>)</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00954"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ad8de2282f2ea56546591c9b2f6bdb846">  954</a></span>&#160;m_s = cm.load(granularity  + str(gran_n) + <span class="stringliteral">&#39;_example_sima.tif&#39;</span>)</div><div class="line"><a name="l00955"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a07fd5e14fd4377c8625716d2499c05b1">  955</a></span>&#160;m_s_row = cm.load(<span class="stringliteral">&#39;example_sima.tif&#39;</span>)</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;</div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00958"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af80868e601b55aa323ad76671ccea523">  958</a></span>&#160;<span class="keyword">def </span><a class="code" href="namespacedemo__motion__correction__nonrigid.html#af80868e601b55aa323ad76671ccea523">compute_jacobians</a>(res):</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;    all_mags = [] </div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;    all_mags_eig = [] </div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="keywordflow">for</span> chunk <span class="keywordflow">in</span> res:</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="keywordflow">for</span> frame <span class="keywordflow">in</span> chunk[0]:</div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;            shifts,pos,init = frame</div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;            x_sh = np.zeros(np.add(init[-1],1))</div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;            y_sh = np.zeros(np.add(init[-1],1))</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    </div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;            <span class="keywordflow">for</span> nt,sh <span class="keywordflow">in</span> zip(init,shifts):</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;                x_sh[nt] = sh[0]</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;                y_sh[nt] = sh[1]</div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    </div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;            jac_xx = x_sh[1:,:] - x_sh[:-1,:]</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;            jac_yx = y_sh[1:,:] - y_sh[:-1,:]</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;            jac_xy = x_sh[:,1:] - x_sh[:,:-1]</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;            jac_yy = y_sh[:,1:] - y_sh[:,:-1]</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;    </div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;            mag_norm = np.sqrt(jac_xx[:,:-1]**2 + jac_yx[:,:-1]**2 + jac_xy[:-1,:]**2 +  jac_yy[:-1,:]**2)</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            <span class="keywordflow">for</span> a,b,c,d <span class="keywordflow">in</span> zip(jac_xx, jac_xy, jac_yy, jac_yy):</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;                jc = np.array([[a,b],[c,d]])</div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;                w, vl, vr = scipy.linalg.eig(jc)</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;                lsl</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;                </div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;            </div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;            all_mags_eig.append(mag_eig)</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;            all_mags.append(mag_norm)</div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;</div><div class="line"><a name="l00999"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a7ada29596201128c16e3885fc46e7e6e">  999</a></span>&#160;nmf = <span class="stringliteral">&#39;M_FLUO_t_shifted_flow.tif&#39;</span></div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;m = cm.load(<span class="stringliteral">&#39;M_FLUO_t_1000_els__d1_64_d2_128_d3_1_order_F_frames_1000_.mmap&#39;</span>)</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;<span class="comment">#shfts = [(a,b) for a,b in zip(np.random.randint(-2,3,m.shape[0]),np.random.randint(-2,3,m.shape[0]))]</span></div><div class="line"><a name="l01002"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#af2f03cd8939d6f7dcc7ae7a1a9b5cc56"> 1002</a></span>&#160;shfts = [(a,b) <span class="keywordflow">for</span> a,b <span class="keywordflow">in</span> zip(np.random.randn(m.shape[0]),np.random.randn(m.shape[0]))]</div><div class="line"><a name="l01003"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#aac2262519a744d1f737604d33ac0c99a"> 1003</a></span>&#160;msh = m.copy().apply_shifts(shfts)</div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;msh[:,10:-10,10:-10].<a class="code" href="to__python__format_8m.html#ac42abb663b6292b7a30912190e66b7d3">save</a>(nmf)</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;template = np.nanmean(m[:,10:-10,10:-10],0)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;tmpl, correlations, flows_orig, norms,smoothness = <a class="code" href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">compute_metrics_motion_correction</a>(<span class="stringliteral">&#39;M_FLUO_t_shifted_flow.tif&#39;</span>,template.shape[0],template.shape[1],winsize=32, play_flow=<span class="keyword">False</span>, resize_fact_flow=1,template = template)</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;with  np.load(<span class="stringliteral">&#39;M_FLUO_t_shifted_flow_metrics.npz&#39;</span>) <span class="keyword">as</span> ld:</div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;    flows = ld[<span class="stringliteral">&#39;flows&#39;</span>]</div><div class="line"><a name="l01010"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#ae2337ee935a19a2ff5f62086e0b57a1d"> 1010</a></span>&#160;    ff_1 = [np.nanmean(f[:,:,1]) <span class="keywordflow">for</span> f <span class="keywordflow">in</span> flows]</div><div class="line"><a name="l01011"></a><span class="lineno"><a class="line" href="namespacedemo__motion__correction__nonrigid.html#a3574e93f0c498772b928f9416e47c615"> 1011</a></span>&#160;    ff_0 = [np.nanmean(f[:,:,0]) <span class="keywordflow">for</span> f <span class="keywordflow">in</span> flows]</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;            </div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;            </div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;pl.subplot(2,1,1)</div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;pl.plot(np.array(shfts)[:,1])</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;pl.plot(np.array(ff_0))</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;pl.legend([<span class="stringliteral">&#39;shifts&#39;</span>,<span class="stringliteral">&#39;optical flow&#39;</span>])</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;pl.xlim([400,600])</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;pl.ylabel(<span class="stringliteral">&#39;x shifts&#39;</span>)</div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;pl.subplot(2,1,2)</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;pl.plot(np.array(shfts)[:,0])</div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;pl.plot(np.array(ff_1))</div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;pl.xlim([400,600])</div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;pl.xlabel(<span class="stringliteral">&#39;frames (15 Hz)&#39;</span>)</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;pl.ylabel(<span class="stringliteral">&#39;y shifts&#39;</span>)</div><div class="ttc" id="namespacecaiman_1_1motion__correction_html_aea060208c09f0e4fb01e6d31b9acf36f"><div class="ttname"><a href="namespacecaiman_1_1motion__correction.html#aea060208c09f0e4fb01e6d31b9acf36f">caiman.motion_correction.tile_and_correct</a></div><div class="ttdeci">def tile_and_correct(img, template, strides, overlaps, max_shifts, newoverlaps=None, newstrides=None, upsample_factor_grid=4, upsample_factor_fft=10, show_movie=False, max_deviation_rigid=2, add_to_movie=0, shifts_opencv=False)</div><div class="ttdoc">perform piecewise rigid motion correction iteration, by 1) dividing the FOV in patches 2) motion corr...</div><div class="ttdef"><b>Definition:</b> <a href="caiman_2motion__correction_8py_source.html#l01497">caiman/motion_correction.py:1497</a></div></div>
<div class="ttc" id="namespacedemo__motion__correction__nonrigid_html_af5830be09e6083a1d4193197cadc7e24"><div class="ttname"><a href="namespacedemo__motion__correction__nonrigid.html#af5830be09e6083a1d4193197cadc7e24">demo_motion_correction_nonrigid.compute_metrics_motion_correction</a></div><div class="ttdeci">def compute_metrics_motion_correction(fname, final_size_x, final_size_y, swap_dim, pyr_scale=.5, levels=3, winsize=100, iterations=15, poly_n=5, poly_sigma=1.2/5, flags=0, play_flow=False, resize_fact_flow=.2, template=None)</div><div class="ttdef"><b>Definition:</b> <a href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py_source.html#l00307">use_cases/motion_correction_paper/demo_motion_correction_nonrigid.py:307</a></div></div>
<div class="ttc" id="namespacedemo__motion__correction__nonrigid_html_af80868e601b55aa323ad76671ccea523"><div class="ttname"><a href="namespacedemo__motion__correction__nonrigid.html#af80868e601b55aa323ad76671ccea523">demo_motion_correction_nonrigid.compute_jacobians</a></div><div class="ttdeci">def compute_jacobians(res)</div><div class="ttdef"><b>Definition:</b> <a href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py_source.html#l00958">use_cases/motion_correction_paper/demo_motion_correction_nonrigid.py:958</a></div></div>
<div class="ttc" id="namespacecaiman_1_1motion__correction_html"><div class="ttname"><a href="namespacecaiman_1_1motion__correction.html">caiman.motion_correction</a></div><div class="ttdef"><b>Definition:</b> <a href="caiman_2motion__correction_8py_source.html#l00001">caiman/motion_correction.py:1</a></div></div>
<div class="ttc" id="to__python__format_8m_html_ac42abb663b6292b7a30912190e66b7d3"><div class="ttname"><a href="to__python__format_8m.html#ac42abb663b6292b7a30912190e66b7d3">save</a></div><div class="ttdeci">save([fname_masks(1:end-4) '_python.mat'], 'roiFile', 'globalId', 'init', 'name_shapes',... 'A', 'C', 'A_in', 'template', 'yRange', 'xRange', 'ImageSize', 'selectMask') clear roiFile globalId init name_shapes A C A_in template selectMask ImageSize yRange xRange end %% fls</div></div>
<div class="ttc" id="namespacedemo__motion__correction__nonrigid_html_a7c12b0a7d034249b2ceb2b7a2a36498b"><div class="ttname"><a href="namespacedemo__motion__correction__nonrigid.html#a7c12b0a7d034249b2ceb2b7a2a36498b">demo_motion_correction_nonrigid.tile_and_correct_wrapper</a></div><div class="ttdeci">def tile_and_correct_wrapper(params)</div><div class="ttdef"><b>Definition:</b> <a href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py_source.html#l00043">use_cases/motion_correction_paper/demo_motion_correction_nonrigid.py:43</a></div></div>
<div class="ttc" id="namespacedemo__motion__correction__nonrigid_html_ab88fd1006bbd98bfc246c62eaff53366"><div class="ttname"><a href="namespacedemo__motion__correction__nonrigid.html#ab88fd1006bbd98bfc246c62eaff53366">demo_motion_correction_nonrigid.motion_correction_piecewise</a></div><div class="ttdeci">def motion_correction_piecewise(fname, splits, strides, overlaps, add_to_movie=0, template=None, max_shifts=(12, 12), max_deviation_rigid=3, newoverlaps=None, newstrides=None, upsample_factor_grid=4, order='F', dview=None, save_movie=True, base_name='none', num_splits=None, shifts_opencv=False)</div><div class="ttdef"><b>Definition:</b> <a href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py_source.html#l00081">use_cases/motion_correction_paper/demo_motion_correction_nonrigid.py:81</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_9fdcf4dafa59827d19629261a7a4f90c.html">use_cases</a></li><li class="navelem"><a class="el" href="dir_c021ca323801cae44c8ed219f732bb5d.html">motion_correction_paper</a></li><li class="navelem"><a class="el" href="use__cases_2motion__correction__paper_2demo__motion__correction__nonrigid_8py.html">demo_motion_correction_nonrigid.py</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
