<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Caiman: online_testing.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Caiman_logo_FIsmall.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Caiman
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A Computational toolbox for large scale Calcium Imaging Analysis</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('online__testing_8py_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">online_testing.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="online__testing_8py.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html">    1</a></span>&#160;<span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">Created on Fri Nov 11 11:55:48 2016</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral"></span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="stringliteral">@author: agiovann</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="keyword">from</span> skimage.external <span class="keyword">import</span> tifffile</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="keyword">import</span> caiman <span class="keyword">as</span> cm</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> PCA,DictionaryLearning,MiniBatchDictionaryLearning,NMF</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">from</span> sklearn.decomposition <span class="keyword">import</span> FastICA</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">import</span> pylab <span class="keyword">as</span> pl</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">import</span> glob</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">from</span> <a class="code" href="namespacecaiman_1_1components__evaluation.html">caiman.components_evaluation</a> <span class="keyword">import</span> compute_event_exceptionality<span class="comment">#import spams</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">#from PIL import Image</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">import</span> scipy</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">from</span> skimage.morphology <span class="keyword">import</span> square</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="keyword">from</span> skimage.filters <span class="keyword">import</span> rank</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00023"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a4124bc0a9335c27f086f24ba207a4912">   23</a></span>&#160;a = cm.load(<span class="stringliteral">&#39;example_movies/demoMovie.tif&#39;</span>)</div><div class="line"><a name="l00024"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a08bb308811ce024625f94c506a83bcfd">   24</a></span>&#160;all_els = []</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keywordflow">for</span> it <span class="keywordflow">in</span> range(10):</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;    print(it)</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">#    a = cm.movie(np.random.randn(*mns.shape).astype(np.float32))</span></div><div class="line"><a name="l00028"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ab4ae50adbd1b32c211ed3d96953f7e20">   28</a></span>&#160;    Yr = cm.movie.to_2D(a).astype(np.float)</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    <span class="comment">#%</span></div><div class="line"><a name="l00031"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a00d8dd5a0d95d6f61f3a71ffc043a41b">   31</a></span>&#160;    norm = lambda(x): np.exp(-x**2/2)/np.sqrt(2*np.pi)</div><div class="line"><a name="l00032"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#af6fb2057c11243dfb545d4fc0aa3b853">   32</a></span>&#160;    fitness ,res, sd_r,md = <a class="code" href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">compute_event_exceptionality</a>(Yr.T)</div><div class="line"><a name="l00033"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a633d331c131d047277bffd2ca8f12927">   33</a></span>&#160;    mns = cm.movie(scipy.ndimage.convolve(np.reshape(np.clip(-np.log(<a class="code" href="namespaceonline__testing.html#a00d8dd5a0d95d6f61f3a71ffc043a41b">norm</a>(np.array((Yr-md)/sd_r,dtype=np.float))),0,1000),[-1,60,80],order = <span class="stringliteral">&#39;F&#39;</span>),np.ones([3,3,3])))</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;    mns[mns&lt;27*np.log((mns.shape[0]))] = 0</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    all_els.append(np.sum(mns&gt;0))</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;    print(all_els)</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">#%%    </span></div><div class="line"><a name="l00038"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a79ae533555e4c4c96a036032b461dd44">   38</a></span>&#160;mov = Yr</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;mns = -cm.movie(np.reshape(res.clip(-1000,0),[80,60,-1]).transpose([2,1,0]))</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">#mns[mns &gt; 1000] = 1000</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;mov = cm.movie.to_2D(mns)    </div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00044"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a5f275402fe7e3f672eab8b802e8913ca">   44</a></span>&#160;noise = res[2]</div><div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a1a6b6fb557d8d37d59700faf4e4c9167">   45</a></span>&#160;mode = cm.components_evaluation.mode_robust(Yr,0)</div><div class="line"><a name="l00046"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a2b4c08601e5d41c71be06c384b3c373a">   46</a></span>&#160;Yr_1 = (cm.movie.to_2D(a)-mode)/res[2]</div><div class="line"><a name="l00047"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ae43d9b3a12ddb7c52082670b733712f0">   47</a></span>&#160;mns_1 = (np.reshape(Yr_1,[-1,80,60],order=<span class="stringliteral">&#39;F&#39;</span>))</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;mov = np.maximum(0,cm.movie.to_2D(mns_1))</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#afab032f0307c27fe09c0d6f4a2cee7f0">   52</a></span>&#160;n_comps = 10</div><div class="line"><a name="l00053"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a83bc31c3083b74669a617f4e5ba0a87f">   53</a></span>&#160;pca = PCA(n_comps)</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;pca = NMF(n_comps,alpha = 10,l1_ratio = 1,init = <span class="stringliteral">&#39;nndsvda&#39;</span>)</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;pca.fit(mov)</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">import</span> cv2</div><div class="line"><a name="l00059"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ace3d4d597bfdb23a69ff766dee1adfb9">   59</a></span>&#160;comps = np.reshape(pca.components_,[n_comps,30,30])</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keywordflow">for</span> count,comp <span class="keywordflow">in</span> enumerate(comps):</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    pl.subplot(4,4,count+1)</div><div class="line"><a name="l00062"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a661743603b39a171d4f2f6dd689961b0">   62</a></span>&#160;    blur = cv2.GaussianBlur(comp.astype(np.float32),(5,5),0)</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    blur = np.array(blur/np.max(blur) * 255, dtype = np.uint8)</div><div class="line"><a name="l00064"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a02ff77c7d08a18370453f101d0cd296e">   64</a></span>&#160;    ret3,th3 = cv2.threshold(blur,0,255,cv2.THRESH_BINARY+cv2.THRESH_OTSU)</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    pl.imshow((th3*comp).T)</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;n_comps = 3</div><div class="line"><a name="l00069"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a0729a163fc1156dcd09aa6e084c0d163">   69</a></span>&#160;dl = DictionaryLearning(n_comps,alpha=1,verbose = <span class="keyword">True</span>)</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;comps = dl.fit_transform(Yr.T)</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;comps = np.reshape(comps,[30,30,n_comps]).transpose([2,0,1])</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keywordflow">for</span> count,comp <span class="keywordflow">in</span> enumerate(comps):</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    pl.subplot(4,4,count+1)</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    pl.imshow(comp)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00076"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ab747090da33da890241dc3fc12ffbfc6">   76</a></span>&#160;N_ICA_COMPS = 8</div><div class="line"><a name="l00077"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a8c8c776963e18ab4ed1c66df9b4ee7e6">   77</a></span>&#160;ica =  FastICA(N_ICA_COMPS,max_iter=10000,tol= 10e-8)</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;ica.fit(pca.components_)</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">#%</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;comps = np.reshape(ica.components_,[N_ICA_COMPS,30,30])</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keywordflow">for</span> count,comp <span class="keywordflow">in</span> enumerate(comps):</div><div class="line"><a name="l00082"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a49654e4709f40aecccada266daa32fc6">   82</a></span>&#160;    idx = np.argmax(np.abs(comp))</div><div class="line"><a name="l00083"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a50b69e8e55167990c85f65e0a656e294">   83</a></span>&#160;    comp = comp * np.sign(comp.flatten()[idx])</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    pl.subplot(4,4,count+1)</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    pl.imshow(comp.T)</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;n_comps = 5    </div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;a = cm.load(<span class="stringliteral">&#39;demoMovie.tif&#39;</span>)[:100,20:50,20:50].IPCA_stICA(15,n_comps) </div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;comps = np.reshape(a,[n_comps,30,30])</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keywordflow">for</span> count,comp <span class="keywordflow">in</span> enumerate(comps):</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    pl.subplot(3,4,count+1)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    pl.imshow(comp)</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00095"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ab3cd915d758008bd19d0f2428fbb354a">   95</a></span>&#160;m = cm.load(<span class="stringliteral">&#39;demoMovie.tif&#39;</span>)</div><div class="line"><a name="l00096"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#aa7fb79750993e7512e30b1124da6563c">   96</a></span>&#160;m1 = m.IPCA_denoise(50)  </div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00098"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#adc604550ef0a958139e08f7e311b8a22">   98</a></span>&#160;m1.play(fr = 30,gain = 5.,magnification=4) </div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;m1.save(<span class="stringliteral">&#39;demoMovieDen.tif&#39;</span>)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;m1 = cm.load(<span class="stringliteral">&#39;demoMovieDen.tif&#39;</span>)</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;m1.play(fr = 30,gain = 4.,magnification=4) </div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a2e445a8b72314d5b83a76e8431d4f5b1">  109</a></span>&#160;fls = glob.glob(<span class="stringliteral">&#39;*Den.tif&#39;</span>)</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keywordflow">print</span> fls</div><div class="line"><a name="l00111"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a932f0b933f14db499b8e437f80572b3c">  111</a></span>&#160;all_names, all_shifts, all_xcorrs, all_templates = cm.motion_correction.motion_correct_online_multifile(fls,0)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#adf1f3edb9115acb0a1e04209b7a9937b">  114</a></span>&#160;Yr, dims, T = cm.load_memmap(all_names[0])</div><div class="line"><a name="l00115"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a479b78c01efbe4664b402a300da492f7">  115</a></span>&#160;d1, d2 = dims</div><div class="line"><a name="l00116"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a51dcdeb45e5f187043150dc943c52faf">  116</a></span>&#160;images = np.reshape(Yr.T, [T] + list(dims), order=<span class="stringliteral">&#39;F&#39;</span>)</div><div class="line"><a name="l00117"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a0867f43e27585e019c13f7f4b7c4ab6b">  117</a></span>&#160;Y = np.reshape(Yr, dims + (T,), order=<span class="stringliteral">&#39;F&#39;</span>)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00119"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a2689c4b3931025b79053532a5f1b0a85">  119</a></span>&#160;K = 35  <span class="comment"># number of neurons expected per patch</span></div><div class="line"><a name="l00120"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a0e1aa99ac6c67f09ceb1e704f60d11e2">  120</a></span>&#160;gSig = [7, 7]  <span class="comment"># expected half size of neurons</span></div><div class="line"><a name="l00121"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#aa12b9a735b1584d120a698cf7277c46e">  121</a></span>&#160;merge_thresh = 0.8  <span class="comment"># merging threshold, max correlation allowed</span></div><div class="line"><a name="l00122"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a533391314665d6bf1b5575e9a9cd8552">  122</a></span>&#160;p = 2  <span class="comment"># order of the autoregressive system</span></div><div class="line"><a name="l00123"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a11a67521c3c3ae68ebdff99d1b60569b">  123</a></span>&#160;cnm = cnmf.CNMF(8,  k=K, gSig=gSig, merge_thresh=merge_thresh,</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                p=p, dview=<span class="keywordtype">None</span>, Ain=<span class="keywordtype">None</span>,method_deconvolution=<span class="stringliteral">&#39;oasis&#39;</span>)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;cnm = cnm.fit(images)</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00127"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ad13f4ef02232cc621f4e6055271cf9e8">  127</a></span>&#160;A, C, b, f, YrA, sn = cnm.A, cnm.C, cnm.b, cnm.f, cnm.YrA, cnm.sn</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00129"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a86d45a8267e46830bf7f292099ea8c6f">  129</a></span>&#160;final_frate = 10</div><div class="line"><a name="l00130"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a2d25628f7539936953abbeb1cc27b342">  130</a></span>&#160;tB = np.minimum(-2, np.floor(-5. / 30 * final_frate))</div><div class="line"><a name="l00131"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a6ead18d1238493364c01bd04f02672ae">  131</a></span>&#160;tA = np.maximum(5, np.ceil(25. / 30 * final_frate))</div><div class="line"><a name="l00132"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a4753cc15d6bd479bc5c79767414c6874">  132</a></span>&#160;Npeaks = 10</div><div class="line"><a name="l00133"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ad3d074ebad4ce65e092199ba4025ae6f">  133</a></span>&#160;traces = C + YrA</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">#        traces_a=traces-scipy.ndimage.percentile_filter(traces,8,size=[1,np.shape(traces)[-1]/5])</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">#        traces_b=np.diff(traces,axis=1)</span></div><div class="line"><a name="l00136"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#aa8fbba52d07a23ee6eeb03897ce99bb6">  136</a></span>&#160;fitness_raw, fitness_delta, erfc_raw, erfc_delta, r_values, significant_samples = \</div><div class="line"><a name="l00137"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#af7225e2c256ea992433062878217c767">  137</a></span>&#160;    <a class="code" href="namespacecaiman_1_1components__evaluation.html#ad2a8435be788c8e75130e41f884adb0f">evaluate_components</a>(Y, traces, A, C, b, f, remove_baseline=<span class="keyword">True</span>,</div><div class="line"><a name="l00138"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a1b23842d0f9dff17eaa871f467b74939">  138</a></span>&#160;                                      N=5, robust_std=<span class="keyword">False</span>, Athresh=0.1, Npeaks=Npeaks, tB=tB, tA=tA, thresh_C=0.3)</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a12b738616c1497d14069912add127460">  140</a></span>&#160;idx_components_r = np.where(r_values &gt;= .5)[0]</div><div class="line"><a name="l00141"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a91a7b55f8e73ef914e4b6c2f2fe31bc4">  141</a></span>&#160;idx_components_raw = np.where(fitness_raw &lt; -40)[0]</div><div class="line"><a name="l00142"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a745384816a420b5ef7999f1d37072705">  142</a></span>&#160;idx_components_delta = np.where(fitness_delta &lt; -20)[0]</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a70cd9938f14087ac6a8bba5b05b11bd2">  147</a></span>&#160;idx_components = np.union1d(idx_components_r, idx_components_raw)</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;idx_components = np.union1d(idx_components, idx_components_delta)</div><div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#ae20f2fb5b16337eccc48ffae14cd6158">  149</a></span>&#160;idx_components_bad = np.setdiff1d(range(len(traces)), idx_components)</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;print(<span class="stringliteral">&#39; ***** &#39;</span>)</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keywordflow">print</span> len(traces)</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;print(len(idx_components))</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">#%% visualize components</span></div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"># pl.figure();</span></div><div class="line"><a name="l00158"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a814939980bc59d2ee5dcef6cfe5f39c7">  158</a></span>&#160;Cn = cm.local_correlations(Y[:,:,:3000])</div><div class="line"><a name="l00159"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a71f1310bd7eec55f1a110c31ec982eb9">  159</a></span>&#160;crd = <a class="code" href="namespacecaiman_1_1utils_1_1visualization.html#ad48f24a70009a82e7a8cafa02e283a0e">plot_contours</a>(A.tocsc(), np.mean(images,0), thr=0.9)</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;    </div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">#%%</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<a class="code" href="namespacecaiman_1_1utils_1_1visualization.html#a04e79a7228ed9dde61b3c5f935fe8742">view_patches_bar</a>(Yr, scipy.sparse.coo_matrix(A.tocsc()[:, idx_components]), C[</div><div class="line"><a name="l00163"></a><span class="lineno"><a class="line" href="namespaceonline__testing.html#a86d0d51ceb4bc3bd26707520f257a5a4">  163</a></span>&#160;                               idx_components, :], b, f, dims[0], dims[1], YrA=YrA[idx_components, :], img=Cn)</div><div class="ttc" id="namespacecaiman_1_1components__evaluation_html_a967e8c445c84976814609f9c120153a2"><div class="ttname"><a href="namespacecaiman_1_1components__evaluation.html#a967e8c445c84976814609f9c120153a2">caiman.components_evaluation.compute_event_exceptionality</a></div><div class="ttdeci">def compute_event_exceptionality(traces, robust_std=False, N=5, use_mode_fast=False)</div><div class="ttdef"><b>Definition:</b> <a href="components__evaluation_8py_source.html#l00092">components_evaluation.py:92</a></div></div>
<div class="ttc" id="namespaceonline__testing_html_a00d8dd5a0d95d6f61f3a71ffc043a41b"><div class="ttname"><a href="namespaceonline__testing.html#a00d8dd5a0d95d6f61f3a71ffc043a41b">online_testing.norm</a></div><div class="ttdeci">norm</div><div class="ttdef"><b>Definition:</b> <a href="online__testing_8py_source.html#l00031">online_testing.py:31</a></div></div>
<div class="ttc" id="namespacecaiman_1_1components__evaluation_html_ad2a8435be788c8e75130e41f884adb0f"><div class="ttname"><a href="namespacecaiman_1_1components__evaluation.html#ad2a8435be788c8e75130e41f884adb0f">caiman.components_evaluation.evaluate_components</a></div><div class="ttdeci">def evaluate_components(Y, traces, A, C, b, f, final_frate, remove_baseline=True, N=5, robust_std=False, Athresh=0.1, Npeaks=5, thresh_C=0.3)</div><div class="ttdoc">Define a metric and order components according to the probabilty if some &quot;exceptional events&quot; (like a...</div><div class="ttdef"><b>Definition:</b> <a href="components__evaluation_8py_source.html#l00269">components_evaluation.py:269</a></div></div>
<div class="ttc" id="namespacecaiman_1_1utils_1_1visualization_html_a04e79a7228ed9dde61b3c5f935fe8742"><div class="ttname"><a href="namespacecaiman_1_1utils_1_1visualization.html#a04e79a7228ed9dde61b3c5f935fe8742">caiman.utils.visualization.view_patches_bar</a></div><div class="ttdeci">def view_patches_bar(Yr, A, C, b, f, d1, d2, YrA=None, secs=1, img=None)</div><div class="ttdoc">view spatial and temporal components interactively </div><div class="ttdef"><b>Definition:</b> <a href="visualization_8py_source.html#l00751">visualization.py:751</a></div></div>
<div class="ttc" id="namespacecaiman_1_1utils_1_1visualization_html_ad48f24a70009a82e7a8cafa02e283a0e"><div class="ttname"><a href="namespacecaiman_1_1utils_1_1visualization.html#ad48f24a70009a82e7a8cafa02e283a0e">caiman.utils.visualization.plot_contours</a></div><div class="ttdeci">def plot_contours(A, Cn, thr=None, thr_method='max', maxthr=0.2, nrgthr=0.9, display_numbers=True, max_number=None, cmap=None, swap_dim=False, colors='w', vmin=None, vmax=None, kwargs)</div><div class="ttdoc">Plots contour of spatial components against a background image and returns their coordinates. </div><div class="ttdef"><b>Definition:</b> <a href="visualization_8py_source.html#l00879">visualization.py:879</a></div></div>
<div class="ttc" id="namespacecaiman_1_1components__evaluation_html"><div class="ttname"><a href="namespacecaiman_1_1components__evaluation.html">caiman.components_evaluation</a></div><div class="ttdef"><b>Definition:</b> <a href="components__evaluation_8py_source.html#l00001">components_evaluation.py:1</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_f45e86d5cfdcf8a6d08b4787631e1538.html">sandbox</a></li><li class="navelem"><a class="el" href="online__testing_8py.html">online_testing.py</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
